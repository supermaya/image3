<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê¸°ì¡´ íšŒì› í¬ì¸íŠ¸ ì§€ê¸‰</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 20px;
        }
        .warning {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            color: #856404;
        }
        .info {
            background: #d1ecf1;
            border: 1px solid #17a2b8;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            color: #0c5460;
        }
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #5a6fd8;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .danger {
            background: #dc3545;
        }
        .danger:hover {
            background: #c82333;
        }
        #log {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            margin-top: 20px;
            max-height: 400px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            line-height: 1.5;
        }
        .log-item {
            margin-bottom: 5px;
        }
        .log-success {
            color: #28a745;
        }
        .log-error {
            color: #dc3545;
        }
        .log-info {
            color: #17a2b8;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ ê¸°ì¡´ íšŒì› í¬ì¸íŠ¸ ì§€ê¸‰</h1>

        <div class="warning">
            <strong>âš ï¸ ì£¼ì˜ì‚¬í•­</strong>
            <ul>
                <li>ì´ ì‘ì—…ì€ <strong>í•œ ë²ˆë§Œ</strong> ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤.</li>
                <li>ëª¨ë“  ê¸°ì¡´ íšŒì›ì—ê²Œ <strong>1000P</strong>ê°€ walletBalanceì— ì§€ê¸‰ë©ë‹ˆë‹¤.</li>
                <li>ì´ë¯¸ í¬ì¸íŠ¸ë¥¼ ë°›ì€ íšŒì›ì€ ì¤‘ë³µ ì§€ê¸‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</li>
                <li>ì‘ì—… ì „ ë°ì´í„°ë² ì´ìŠ¤ ë°±ì—…ì„ ê¶Œì¥í•©ë‹ˆë‹¤.</li>
            </ul>
        </div>

        <div class="info">
            <strong>â„¹ï¸ ì‘ì—… ë‚´ìš©</strong>
            <ul>
                <li>dailyPointsê°€ 1000 ë¯¸ë§Œì¸ íšŒì›ì—ê²Œ 1000P ì§€ê¸‰</li>
                <li>walletBalanceê°€ ì—†ê±°ë‚˜ 0ì¸ íšŒì›ì—ê²Œ 1000P ì§€ê¸‰</li>
                <li>ëª¨ë“  ì‘ì—…ì€ Firestoreì— ê¸°ë¡ë©ë‹ˆë‹¤</li>
            </ul>
        </div>

        <div style="margin-bottom: 20px;">
            <button id="preview-btn" onclick="previewUsers()">ğŸ‘€ ëŒ€ìƒ íšŒì› ë¯¸ë¦¬ë³´ê¸°</button>
            <button id="execute-btn" class="danger" onclick="executeGrantPoints()" disabled>
                ğŸš€ í¬ì¸íŠ¸ ì§€ê¸‰ ì‹¤í–‰
            </button>
        </div>

        <div id="log"></div>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getFirestore, collection, getDocs, doc, updateDoc, addDoc, query } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Firebase ì„¤ì • (index.htmlê³¼ ë™ì¼í•˜ê²Œ)
        const firebaseConfig = {
            apiKey: "AIzaSyAChI2Lr2RgLxIJWg-NCafGhbgo7MHfpLA",
            authDomain: "pixelplanet-95dd9.firebaseapp.com",
            projectId: "pixelplanet-95dd9",
            storageBucket: "pixelplanet-95dd9.firebasestorage.app",
            messagingSenderId: "895107624648",
            appId: "1:895107624648:web:f928b2e9156691fab97ffd",
            measurementId: "G-4JVYXYZPW0"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        window.db = db;
        window.collection = collection;
        window.getDocs = getDocs;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.addDoc = addDoc;
        window.query = query;

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const logItem = document.createElement('div');
            logItem.className = `log-item log-${type}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(logItem);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        window.log = log;
    </script>

    <script>
        let eligibleUsers = [];

        async function previewUsers() {
            const logDiv = document.getElementById('log');
            logDiv.innerHTML = '';
            log('ëŒ€ìƒ íšŒì› ì¡°íšŒ ì¤‘...', 'info');

            try {
                const usersRef = window.collection(window.db, 'users');
                const usersSnapshot = await window.getDocs(usersRef);

                eligibleUsers = [];
                let totalUsers = 0;

                usersSnapshot.forEach((doc) => {
                    totalUsers++;
                    const userData = doc.data();
                    const userId = doc.id;
                    const email = userData.email || 'Unknown';
                    const walletBalance = userData.walletBalance || 0;
                    const dailyPoints = userData.dailyPoints || 0;

                    // ì¡°ê±´: walletBalanceê°€ 1000 ë¯¸ë§Œì¸ íšŒì› (ê¸°ì¡´ íšŒì›ë“¤ì—ê²Œ 1000P ì§€ê¸‰)
                    if (walletBalance < 1000) {
                        eligibleUsers.push({
                            userId: userId,
                            email: email,
                            currentWallet: walletBalance,
                            currentDaily: dailyPoints
                        });
                    }
                });

                log(`ì´ íšŒì› ìˆ˜: ${totalUsers}ëª…`, 'info');
                log(`í¬ì¸íŠ¸ ì§€ê¸‰ ëŒ€ìƒ: ${eligibleUsers.length}ëª…`, 'success');

                if (eligibleUsers.length > 0) {
                    log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
                    log('ëŒ€ìƒ íšŒì› ëª©ë¡:', 'info');
                    eligibleUsers.forEach((user, index) => {
                        log(`${index + 1}. ${user.email} (ì§€ê°‘: ${user.currentWallet}P, ì¼ì¼: ${user.currentDaily}P)`, 'info');
                    });
                    log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');

                    // ì‹¤í–‰ ë²„íŠ¼ í™œì„±í™”
                    document.getElementById('execute-btn').disabled = false;
                    log('âœ… "í¬ì¸íŠ¸ ì§€ê¸‰ ì‹¤í–‰" ë²„íŠ¼ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                } else {
                    log('í¬ì¸íŠ¸ ì§€ê¸‰ì´ í•„ìš”í•œ íšŒì›ì´ ì—†ìŠµë‹ˆë‹¤.', 'info');
                    document.getElementById('execute-btn').disabled = true;
                }

            } catch (error) {
                log(`ì˜¤ë¥˜ ë°œìƒ: ${error.message}`, 'error');
                console.error(error);
            }
        }

        async function executeGrantPoints() {
            if (eligibleUsers.length === 0) {
                alert('ë¨¼ì € "ëŒ€ìƒ íšŒì› ë¯¸ë¦¬ë³´ê¸°"ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”.');
                return;
            }

            const confirmed = confirm(
                `${eligibleUsers.length}ëª…ì˜ íšŒì›ì—ê²Œ 1000Pë¥¼ ì§€ê¸‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n` +
                `ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`
            );

            if (!confirmed) {
                log('ì‘ì—…ì´ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'info');
                return;
            }

            // ë²„íŠ¼ ë¹„í™œì„±í™”
            document.getElementById('preview-btn').disabled = true;
            document.getElementById('execute-btn').disabled = true;

            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            log('í¬ì¸íŠ¸ ì§€ê¸‰ ì‹œì‘...', 'info');

            let successCount = 0;
            let failCount = 0;

            for (let i = 0; i < eligibleUsers.length; i++) {
                const user = eligibleUsers[i];
                try {
                    // walletBalance ì—…ë°ì´íŠ¸
                    const userRef = window.doc(window.db, 'users', user.userId);
                    await window.updateDoc(userRef, {
                        walletBalance: 1000
                    });

                    // ê±°ë˜ ë‚´ì—­ ì¶”ê°€
                    const transactionRef = window.collection(window.db, 'pointTransactions');
                    await window.addDoc(transactionRef, {
                        userId: user.userId,
                        type: 'admin_grant',
                        amount: 1000,
                        description: 'ê¸°ì¡´ íšŒì› ë³´ìƒ í¬ì¸íŠ¸',
                        createdAt: new Date()
                    });

                    successCount++;
                    log(`âœ… [${i + 1}/${eligibleUsers.length}] ${user.email} - 1000P ì§€ê¸‰ ì™„ë£Œ`, 'success');

                } catch (error) {
                    failCount++;
                    log(`âŒ [${i + 1}/${eligibleUsers.length}] ${user.email} - ì‹¤íŒ¨: ${error.message}`, 'error');
                }

                // ì§„í–‰ë¥  í‘œì‹œ
                if ((i + 1) % 10 === 0) {
                    log(`ì§„í–‰ë¥ : ${i + 1}/${eligibleUsers.length} (${Math.round((i + 1) / eligibleUsers.length * 100)}%)`, 'info');
                }
            }

            log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”', 'info');
            log(`ì‘ì—… ì™„ë£Œ!`, 'success');
            log(`ì„±ê³µ: ${successCount}ëª…`, 'success');
            if (failCount > 0) {
                log(`ì‹¤íŒ¨: ${failCount}ëª…`, 'error');
            }
            log(`ì´ ì§€ê¸‰ í¬ì¸íŠ¸: ${successCount * 1000}P`, 'success');

            alert(`ì‘ì—… ì™„ë£Œ!\nì„±ê³µ: ${successCount}ëª…\nì‹¤íŒ¨: ${failCount}ëª…`);
        }

        window.previewUsers = previewUsers;
        window.executeGrantPoints = executeGrantPoints;
    </script>
</body>
</html>
