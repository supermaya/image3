<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìŒì•… ê´€ë¦¬ - í¬ë¦¬ì—ì´í„° ì „ìš©</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f6fa;
            min-height: 100vh;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header .container {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 28px;
        }

        .header-actions {
            display: flex;
            gap: 15px;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .btn:hover {
            transform: translateY(-2px);
        }

        .btn-upload {
            background: white;
            color: #667eea;
        }

        .btn-logout {
            background: #dc3545;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 30px auto;
            padding: 0 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            color: #667eea;
        }

        .search-bar {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .search-bar input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .music-list {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .music-item {
            display: grid;
            grid-template-columns: 80px 1fr auto;
            gap: 15px;
            padding: 15px;
            border-bottom: 1px solid #f0f0f0;
            align-items: center;
            transition: background 0.2s;
        }

        .music-item:hover {
            background: #f8f9fa;
        }

        .music-item:last-child {
            border-bottom: none;
        }

        .album-cover {
            width: 80px;
            height: 80px;
            border-radius: 8px;
            object-fit: cover;
            background: #e0e0e0;
        }

        .music-info {
            flex: 1;
        }

        .music-title {
            font-size: 18px;
            font-weight: bold;
            color: #333;
            margin-bottom: 5px;
        }

        .music-artist {
            color: #666;
            font-size: 14px;
            margin-bottom: 5px;
        }

        .music-meta {
            display: flex;
            gap: 15px;
            font-size: 12px;
            color: #999;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .badge-category {
            background: #e3f2fd;
            color: #1976d2;
        }

        .badge-featured {
            background: #fff3e0;
            color: #f57c00;
        }

        .music-actions {
            display: flex;
            gap: 10px;
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            transition: transform 0.2s;
        }

        .btn-icon:hover {
            transform: scale(1.1);
        }

        .btn-play {
            background: #667eea;
            color: white;
        }

        .btn-edit {
            background: #ffc107;
            color: white;
        }

        .btn-delete {
            background: #dc3545;
            color: white;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            font-size: 24px;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 30px;
            cursor: pointer;
            color: #999;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 600;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
        }

        .audio-player {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div>
                <h1>ğŸµ ìŒì•… ê´€ë¦¬</h1>
                <p id="userEmail" style="margin-top: 5px; opacity: 0.9;">ë¡œë”©ì¤‘...</p>
            </div>
            <div class="header-actions">
                <button class="btn btn-upload" onclick="window.location.href='creator-upload.html'">
                    + ìƒˆ ìŒì•… ì—…ë¡œë“œ
                </button>
                <button class="btn btn-logout" onclick="handleLogout()">
                    ë¡œê·¸ì•„ì›ƒ
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="stats">
            <div class="stat-card">
                <h3>ì´ ìŒì•…</h3>
                <div class="value" id="totalMusic">0</div>
            </div>
            <div class="stat-card">
                <h3>ì´ ì¬ìƒ</h3>
                <div class="value" id="totalPlays">0</div>
            </div>
            <div class="stat-card">
                <h3>ì´ ì¢‹ì•„ìš”</h3>
                <div class="value" id="totalLikes">0</div>
            </div>
        </div>

        <div class="search-bar">
            <input type="text" id="searchInput" placeholder="ğŸ” ìŒì•… ì œëª© ë˜ëŠ” ì•„í‹°ìŠ¤íŠ¸ ê²€ìƒ‰..."
                   oninput="handleSearch()">
        </div>

        <div class="music-list" id="musicList">
            <div class="loading">ìŒì•… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
        </div>
    </div>

    <!-- ìˆ˜ì • ëª¨ë‹¬ -->
    <div id="editModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>ìŒì•… ì •ë³´ ìˆ˜ì •</h2>
                <button class="close-btn" onclick="closeEditModal()">&times;</button>
            </div>

            <form id="editForm">
                <input type="hidden" id="editMusicId">

                <div class="form-group">
                    <label>ê³¡ ì œëª©</label>
                    <input type="text" id="editTitle" required>
                </div>

                <div class="form-group">
                    <label>ì•„í‹°ìŠ¤íŠ¸</label>
                    <input type="text" id="editArtist" required>
                </div>

                <div class="form-group">
                    <label>ì¹´í…Œê³ ë¦¬</label>
                    <select id="editCategory">
                        <option value="pop">íŒ</option>
                        <option value="rock">ë¡</option>
                        <option value="jazz">ì¬ì¦ˆ</option>
                        <option value="classical">í´ë˜ì‹</option>
                        <option value="hiphop">í™í•©</option>
                        <option value="electronic">ì¼ë ‰íŠ¸ë¡œë‹‰</option>
                        <option value="rnb">R&B</option>
                        <option value="other">ê¸°íƒ€</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ë¶„ë¥˜</label>
                    <select id="editClassification">
                        <option value="general">ì¼ë°˜</option>
                        <option value="featured">ì¶”ì²œ</option>
                        <option value="new">ì‹ ê³¡</option>
                        <option value="popular">ì¸ê¸°</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ì´ë¯¸ì§€ ìë™ì „í™˜ ì‹œê°„ (ì´ˆ) <span style="color: #999; font-size: 12px;">ì„ íƒì‚¬í•­</span></label>
                    <input type="number" id="editAutoplayTiming" min="1" max="60" placeholder="ê¸°ë³¸ê°’: 3ì´ˆ">
                    <small style="color: #666; display: block; margin-top: 5px;">
                        1~60ì´ˆ ì‚¬ì´ ê°’ ì…ë ¥ (ë¯¸ì…ë ¥ ì‹œ ê¸°ë³¸ê°’ 3ì´ˆ ì ìš©)<br>
                        ê¶Œì¥: íŒ¨ì…˜ 2-3ì´ˆ, í¬íŠ¸ë ˆì´íŠ¸ 5-7ì´ˆ, í’ê²½ 7-10ì´ˆ
                    </small>
                </div>

                <button type="submit" class="btn btn-upload" style="width: 100%; margin-top: 20px;">
                    ì €ì¥
                </button>
            </form>
        </div>
    </div>

    <!-- ì¬ìƒ ëª¨ë‹¬ -->
    <div id="playModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="playTitle">ìŒì•… ì¬ìƒ</h2>
                <button class="close-btn" onclick="closePlayModal()">&times;</button>
            </div>

            <img id="playImage" class="album-cover" style="width: 100%; height: 300px; margin-bottom: 20px;">
            <p id="playArtist" style="text-align: center; color: #666; margin-bottom: 20px;"></p>
            <audio id="audioPlayer" class="audio-player" controls></audio>
        </div>
    </div>

    <script type="module">
        import {
            checkLoginStatus,
            logout,
            getMusicList,
            updateMusic,
            deleteMusic
        } from './src/utils/api.js';

        let allMusic = [];
        let currentUser = null;

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        window.addEventListener('DOMContentLoaded', async () => {
            try {
                const result = await checkLoginStatus();

                if (!result.success) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                    return;
                }

                // í¬ë¦¬ì—ì´í„° ë˜ëŠ” ê´€ë¦¬ì ê¶Œí•œ í™•ì¸
                if (result.data.role !== 'creator' && result.data.role !== 'admin') {
                    alert('í¬ë¦¬ì—ì´í„° ë˜ëŠ” ê´€ë¦¬ì ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = 'index.html';
                    return;
                }

                currentUser = result.data;
                document.getElementById('userEmail').textContent = result.data.email;

                // ìŒì•… ëª©ë¡ ë¡œë“œ
                await loadMusicList();

            } catch (error) {
                console.error('ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
                alert('í˜ì´ì§€ ë¡œë”© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        });

        // ìŒì•… ëª©ë¡ ë¡œë“œ
        async function loadMusicList() {
            try {
                const result = await getMusicList({
                    limitCount: 100,
                    orderField: 'createdAt',
                    orderDirection: 'desc'
                });

                if (result.success) {
                    allMusic = result.data.music;

                    // ê´€ë¦¬ìê°€ ì•„ë‹ˆë©´ ë³¸ì¸ ìŒì•…ë§Œ í‘œì‹œ
                    if (currentUser.role !== 'admin') {
                        allMusic = allMusic.filter(music => music.uploadedBy === currentUser.uid);
                    }

                    displayMusicList(allMusic);
                    updateStats(allMusic);
                }

            } catch (error) {
                console.error('ìŒì•… ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:', error);
                document.getElementById('musicList').innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">âš ï¸</div>
                        <p>ìŒì•… ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
                    </div>
                `;
            }
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(musicList) {
            const totalMusic = musicList.length;
            const totalPlays = musicList.reduce((sum, music) => sum + (music.playCount || 0), 0);
            const totalLikes = musicList.reduce((sum, music) => sum + (music.likeCount || 0), 0);

            document.getElementById('totalMusic').textContent = totalMusic;
            document.getElementById('totalPlays').textContent = totalPlays.toLocaleString();
            document.getElementById('totalLikes').textContent = totalLikes.toLocaleString();
        }

        // ìŒì•… ëª©ë¡ í‘œì‹œ
        function displayMusicList(musicList) {
            const container = document.getElementById('musicList');

            if (musicList.length === 0) {
                container.innerHTML = `
                    <div class="empty">
                        <div class="empty-icon">ğŸµ</div>
                        <p>ì•„ì§ ì—…ë¡œë“œí•œ ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤.</p>
                        <button class="btn btn-upload" onclick="window.location.href='creator-upload.html'">
                            ì²« ìŒì•… ì—…ë¡œë“œí•˜ê¸°
                        </button>
                    </div>
                `;
                return;
            }

            container.innerHTML = musicList.map(music => `
                <div class="music-item">
                    <img src="${music.imageUrl || 'https://via.placeholder.com/80?text=No+Image'}"
                         alt="${music.title}"
                         class="album-cover">

                    <div class="music-info">
                        <div class="music-title">${music.title}</div>
                        <div class="music-artist">${music.artist}</div>
                        <div class="music-meta">
                            <span class="badge badge-category">${getCategoryName(music.category)}</span>
                            ${music.recommended ? '<span class="badge badge-featured">ì¶”ì²œ</span>' : ''}
                            <span>ì¬ìƒ ${music.playCount || 0}</span>
                            <span>ì¢‹ì•„ìš” ${music.likeCount || 0}</span>
                        </div>
                    </div>

                    <div class="music-actions">
                        <button class="btn-icon btn-play" onclick="playMusic('${music.id}')"
                                title="ì¬ìƒ">
                            â–¶
                        </button>
                        <button class="btn-icon btn-edit" onclick="editMusic('${music.id}')"
                                title="ìˆ˜ì •">
                            âœ
                        </button>
                        <button class="btn-icon btn-delete" onclick="confirmDelete('${music.id}', '${music.title}')"
                                title="ì‚­ì œ">
                            ğŸ—‘
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // ì¹´í…Œê³ ë¦¬ ì´ë¦„
        function getCategoryName(category) {
            const names = {
                pop: 'íŒ',
                rock: 'ë¡',
                jazz: 'ì¬ì¦ˆ',
                classical: 'í´ë˜ì‹',
                hiphop: 'í™í•©',
                electronic: 'ì¼ë ‰íŠ¸ë¡œë‹‰',
                rnb: 'R&B',
                other: 'ê¸°íƒ€'
            };
            return names[category] || category;
        }

        // ê²€ìƒ‰
        window.handleSearch = () => {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            const filtered = allMusic.filter(music =>
                music.title.toLowerCase().includes(searchTerm) ||
                music.artist.toLowerCase().includes(searchTerm)
            );

            displayMusicList(filtered);
        };

        // ìŒì•… ì¬ìƒ
        window.playMusic = (id) => {
            const music = allMusic.find(m => m.id === id);
            if (!music) return;

            document.getElementById('playTitle').textContent = music.title;
            document.getElementById('playArtist').textContent = music.artist;
            document.getElementById('playImage').src = music.imageUrl || 'https://via.placeholder.com/300?text=No+Image';
            document.getElementById('audioPlayer').src = music.audioUrl;

            document.getElementById('playModal').classList.add('show');
        };

        window.closePlayModal = () => {
            document.getElementById('playModal').classList.remove('show');
            document.getElementById('audioPlayer').pause();
        };

        // ìŒì•… ìˆ˜ì •
        window.editMusic = (id) => {
            const music = allMusic.find(m => m.id === id);
            if (!music) return;

            document.getElementById('editMusicId').value = id;
            document.getElementById('editTitle').value = music.title;
            document.getElementById('editArtist').value = music.artist;
            document.getElementById('editCategory').value = music.category;
            document.getElementById('editClassification').value = music.classification;

            // autoplayTiming ê°’ ì„¤ì • (ìˆìœ¼ë©´ í‘œì‹œ, ì—†ìœ¼ë©´ ë¹ˆì¹¸)
            const autoplayTimingInput = document.getElementById('editAutoplayTiming');
            if (autoplayTimingInput) {
                autoplayTimingInput.value = music.autoplayTiming || '';
            }

            document.getElementById('editModal').classList.add('show');
        };

        window.closeEditModal = () => {
            document.getElementById('editModal').classList.remove('show');
        };

        // ìˆ˜ì • í¼ ì œì¶œ
        document.getElementById('editForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('editMusicId').value;
            const autoplayTimingValue = document.getElementById('editAutoplayTiming').value;

            const data = {
                title: document.getElementById('editTitle').value,
                artist: document.getElementById('editArtist').value,
                category: document.getElementById('editCategory').value,
                classification: document.getElementById('editClassification').value,
                recommended: document.getElementById('editClassification').value === 'featured'
            };

            // autoplayTiming ì²˜ë¦¬ (ê°’ì´ ìˆê³  ìœ íš¨í•œ ë²”ìœ„ë©´ ì¶”ê°€)
            if (autoplayTimingValue !== '') {
                const timing = parseInt(autoplayTimingValue);
                if (!isNaN(timing) && timing >= 1 && timing <= 60) {
                    data.autoplayTiming = timing;
                }
            }

            try {
                const result = await updateMusic(id, data);

                if (result.success) {
                    alert('ìŒì•… ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeEditModal();
                    await loadMusicList();
                }

            } catch (error) {
                console.error('ìˆ˜ì • ì˜¤ë¥˜:', error);
                alert('ìˆ˜ì • ì‹¤íŒ¨: ' + error.message);
            }
        });

        // ì‚­ì œ í™•ì¸
        window.confirmDelete = (id, title) => {
            if (confirm(`"${title}"ì„(ë¥¼) ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
                deleteMusic_confirm(id);
            }
        };

        // ìŒì•… ì‚­ì œ
        async function deleteMusic_confirm(id) {
            try {
                const result = await deleteMusic(id);

                if (result.success) {
                    alert('ìŒì•…ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    await loadMusicList();
                }

            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // ë¡œê·¸ì•„ì›ƒ
        window.handleLogout = async () => {
            if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                try {
                    await logout();
                    window.location.href = 'index.html';
                } catch (error) {
                    console.error('ë¡œê·¸ì•„ì›ƒ ì˜¤ë¥˜:', error);
                }
            }
        };
    </script>
</body>
</html>
