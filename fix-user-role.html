<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>사용자 Role 수정 도구</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 p-8">
    <div class="max-w-2xl mx-auto bg-white rounded-lg shadow-lg p-6">
        <h1 class="text-2xl font-bold mb-6 text-center">사용자 Role 수정 도구</h1>

        <div class="mb-6 p-4 bg-yellow-50 border border-yellow-200 rounded">
            <p class="text-sm text-yellow-800">
                ⚠️ <strong>주의:</strong> 이 도구는 관리자만 사용해야 합니다.<br>
                크리에이터 권한이 잘못 설정된 사용자의 role을 수정할 수 있습니다.
            </p>
        </div>

        <!-- 로그인 섹션 -->
        <div id="login-section" class="mb-6">
            <h2 class="text-xl font-semibold mb-4">1. 관리자 로그인</h2>
            <div class="space-y-3">
                <input type="email" id="admin-email" placeholder="관리자 이메일"
                    class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="password" id="admin-password" placeholder="비밀번호"
                    class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-blue-500">
                <button onclick="adminLogin()"
                    class="w-full bg-blue-500 text-white py-2 rounded hover:bg-blue-600 transition">
                    로그인
                </button>
            </div>
        </div>

        <!-- 사용자 정보 조회 섹션 -->
        <div id="search-section" class="mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4">2. 사용자 검색</h2>
            <div class="space-y-3">
                <input type="email" id="user-email" placeholder="수정할 사용자의 이메일"
                    class="w-full px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-green-500">
                <button onclick="searchUser()"
                    class="w-full bg-green-500 text-white py-2 rounded hover:bg-green-600 transition">
                    사용자 검색
                </button>
            </div>
        </div>

        <!-- 사용자 정보 표시 및 수정 섹션 -->
        <div id="user-info-section" class="mb-6 hidden">
            <h2 class="text-xl font-semibold mb-4">3. 사용자 정보</h2>
            <div id="user-info-display" class="mb-4 p-4 bg-gray-50 rounded"></div>

            <div class="space-y-3">
                <label class="block">
                    <span class="text-gray-700 font-medium">새로운 Role:</span>
                    <select id="new-role" class="w-full mt-1 px-4 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-purple-500">
                        <option value="user">일반 회원 (user)</option>
                        <option value="creator">크리에이터 (creator)</option>
                        <option value="admin">관리자 (admin)</option>
                    </select>
                </label>
                <button onclick="updateUserRole()"
                    class="w-full bg-purple-500 text-white py-2 rounded hover:bg-purple-600 transition">
                    Role 업데이트
                </button>
            </div>
        </div>

        <!-- 결과 메시지 -->
        <div id="result-message" class="hidden p-4 rounded mb-4"></div>

        <!-- 로그아웃 버튼 -->
        <button id="logout-btn" onclick="handleLogout()"
            class="w-full bg-red-500 text-white py-2 rounded hover:bg-red-600 transition hidden">
            로그아웃
        </button>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';

        // Firebase 설정
        const firebaseConfig = {
            apiKey: "AIzaSyAChI2Lr2RgLxIJWg-NCafGhbgo7MHfpLA",
            authDomain: "pixelplanet-95dd9.firebaseapp.com",
            projectId: "pixelplanet-95dd9",
            storageBucket: "pixelplanet-95dd9.firebasestorage.app",
            messagingSenderId: "895107624648",
            appId: "1:895107624648:web:f928b2e9156691fab97ffd",
            measurementId: "G-4JVYXYZPW0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 전역 변수로 할당
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseDoc = doc;
        window.firebaseGetDoc = getDoc;
        window.firebaseSetDoc = setDoc;
        window.firebaseCollection = collection;
        window.firebaseQuery = query;
        window.firebaseWhere = where;
        window.firebaseGetDocs = getDocs;
        window.firebaseSignInWithEmailAndPassword = signInWithEmailAndPassword;
        window.firebaseSignOut = signOut;

        let currentUserUid = null;
    </script>

    <script>
        function showMessage(message, type = 'success') {
            const msgDiv = document.getElementById('result-message');
            msgDiv.className = `p-4 rounded mb-4 ${type === 'success' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}`;
            msgDiv.textContent = message;
            msgDiv.classList.remove('hidden');
            setTimeout(() => msgDiv.classList.add('hidden'), 5000);
        }

        async function adminLogin() {
            const email = document.getElementById('admin-email').value;
            const password = document.getElementById('admin-password').value;

            if (!email || !password) {
                showMessage('이메일과 비밀번호를 입력하세요.', 'error');
                return;
            }

            try {
                const userCredential = await window.firebaseSignInWithEmailAndPassword(window.firebaseAuth, email, password);

                // 관리자 권한 확인
                const userDoc = await window.firebaseGetDoc(window.firebaseDoc(window.firebaseDb, 'users', userCredential.user.uid));
                if (!userDoc.exists() || userDoc.data().role !== 'admin') {
                    await window.firebaseSignOut(window.firebaseAuth);
                    showMessage('관리자 권한이 필요합니다.', 'error');
                    return;
                }

                showMessage('관리자 로그인 성공!', 'success');
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('search-section').classList.remove('hidden');
                document.getElementById('logout-btn').classList.remove('hidden');
            } catch (error) {
                console.error('로그인 실패:', error);
                showMessage('로그인 실패: ' + error.message, 'error');
            }
        }

        async function searchUser() {
            const email = document.getElementById('user-email').value;

            if (!email) {
                showMessage('사용자 이메일을 입력하세요.', 'error');
                return;
            }

            try {
                // Firestore에서 이메일로 사용자 검색
                const usersRef = window.firebaseCollection(window.firebaseDb, 'users');
                const q = window.firebaseQuery(usersRef, window.firebaseWhere('email', '==', email));
                const querySnapshot = await window.firebaseGetDocs(q);

                if (querySnapshot.empty) {
                    showMessage('해당 이메일의 사용자를 찾을 수 없습니다.', 'error');
                    return;
                }

                // 첫 번째 사용자 정보 가져오기
                const userDoc = querySnapshot.docs[0];
                currentUserUid = userDoc.id;
                const userData = userDoc.data();

                // 사용자 정보 표시
                const userInfoDiv = document.getElementById('user-info-display');
                userInfoDiv.innerHTML = `
                    <p><strong>UID:</strong> ${currentUserUid}</p>
                    <p><strong>이메일:</strong> ${userData.email}</p>
                    <p><strong>현재 Role:</strong> <span class="font-bold ${
                        userData.role === 'admin' ? 'text-red-600' :
                        userData.role === 'creator' ? 'text-blue-600' :
                        'text-gray-600'
                    }">${userData.role || 'user'}</span></p>
                    <p><strong>가입일:</strong> ${userData.createdAt ? new Date(userData.createdAt).toLocaleString('ko-KR') : '-'}</p>
                    <p><strong>포인트:</strong> 일일 ${userData.dailyPoints || 0}P / 지갑 ${userData.walletBalance || 0}P</p>
                `;

                // 현재 role을 선택
                document.getElementById('new-role').value = userData.role || 'user';

                document.getElementById('user-info-section').classList.remove('hidden');
                showMessage('사용자를 찾았습니다.', 'success');
            } catch (error) {
                console.error('검색 실패:', error);
                showMessage('검색 실패: ' + error.message, 'error');
            }
        }

        async function updateUserRole() {
            if (!currentUserUid) {
                showMessage('먼저 사용자를 검색하세요.', 'error');
                return;
            }

            const newRole = document.getElementById('new-role').value;

            if (!confirm(`사용자의 role을 "${newRole}"로 변경하시겠습니까?`)) {
                return;
            }

            try {
                const userDocRef = window.firebaseDoc(window.firebaseDb, 'users', currentUserUid);
                await window.firebaseSetDoc(userDocRef, { role: newRole }, { merge: true });

                showMessage(`Role이 "${newRole}"로 성공적으로 변경되었습니다!`, 'success');

                // 사용자 정보 다시 검색하여 표시
                setTimeout(() => searchUser(), 1000);
            } catch (error) {
                console.error('업데이트 실패:', error);
                showMessage('업데이트 실패: ' + error.message, 'error');
            }
        }

        async function handleLogout() {
            try {
                await window.firebaseSignOut(window.firebaseAuth);
                location.reload();
            } catch (error) {
                console.error('로그아웃 실패:', error);
            }
        }
    </script>
</body>
</html>
