<!DOCTYPE html>
<!-- Build: 2024-11-04-v11 | Time: 2024-11-04T04:00:00 | í¬ë¦¬ì—ì´í„° ê´€ë¦¬ í˜ì´ì§€ì— ìë™ì „í™˜ ì‹œê°„ ì„¤ì • UI ì¶”ê°€ -->
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="screen-orientation" content="portrait">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>PIXEL SUNDAY - Looks & Lines, Momentary, Chronicles</title>
    <meta name="description" content="PIXEL SUNDAY: LOOKS & LINES (í™”ë³´ì™€ ë£©ë¶ ì¤‘ì‹¬ì˜ ë¹„ì£¼ì–¼ ì½˜í…ì¸ ), MOMENTARY (ì§§ì€ ì—í”¼ì†Œë“œì™€ ê°ì •ì˜ ìˆœê°„), CHRONICLES (ì„œì‚¬ ì¤‘ì‹¬ì˜ ë“œë¼ë§ˆ ì‹œë¦¬ì¦ˆì™€ ì„¸ê³„ê´€ ì½˜í…ì¸ )">
    <meta name="keywords" content="í”½ì…€ì„ ë°ì´, PIXEL SUNDAY, í™”ë³´, ë£©ë¶, Looks & Lines, momentary, chronicles, ë¹„ì£¼ì–¼ ì½˜í…ì¸ , ì—í”¼ì†Œë“œ, ë“œë¼ë§ˆ">
    <meta property="og:title" content="PIXEL SUNDAY - Looks & Lines, Momentary, Chronicles">
    <meta property="og:description" content="í™”ë³´ì™€ ë£©ë¶, ì§§ì€ ì—í”¼ì†Œë“œ, ë“œë¼ë§ˆ ì‹œë¦¬ì¦ˆë¥¼ ë§Œë‚˜ë³´ì„¸ìš”">
    <meta property="og:type" content="website">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ğŸµ</text></svg>">
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js';
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, collection, addDoc, query, orderBy, getDocs, where, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js';
        import { getStorage, ref, uploadBytes, getDownloadURL, deleteObject } from 'https://www.gstatic.com/firebasejs/10.8.0/firebase-storage.js';

        // Firebase ì„¤ì •
        const firebaseConfig = {
            apiKey: "AIzaSyAChI2Lr2RgLxIJWg-NCafGhbgo7MHfpLA",
            authDomain: "pixelplanet-95dd9.firebaseapp.com",
            projectId: "pixelplanet-95dd9",
            storageBucket: "pixelplanet-95dd9.firebasestorage.app",
            messagingSenderId: "895107624648",
            appId: "1:895107624648:web:f928b2e9156691fab97ffd",
            measurementId: "G-4JVYXYZPW0"
        };

        // Firebase ì´ˆê¸°í™”
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const googleProvider = new GoogleAuthProvider();

        // Firestore ì˜¤í”„ë¼ì¸ ì§€ì†ì„± í™œì„±í™” (ì„ íƒì‚¬í•­)
        // enableIndexedDbPersistence(db).catch((err) => {
        //     if (err.code == 'failed-precondition') {
        //         console.warn('ì—¬ëŸ¬ íƒ­ì´ ì—´ë ¤ìˆì–´ ì˜¤í”„ë¼ì¸ ì§€ì†ì„±ì„ í™œì„±í™”í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        //     } else if (err.code == 'unimplemented') {
        //         console.warn('ë¸Œë¼ìš°ì €ê°€ ì˜¤í”„ë¼ì¸ ì§€ì†ì„±ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
        //     }
        // });

        // ì „ì—­ìœ¼ë¡œ ë…¸ì¶œ
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.firebaseStorage = storage;
        window.firebaseGoogleProvider = googleProvider;
        window.firebaseSignInWithEmailAndPassword = signInWithEmailAndPassword;
        window.firebaseCreateUserWithEmailAndPassword = createUserWithEmailAndPassword;
        window.firebaseSignInWithPopup = signInWithPopup;
        window.firebaseOnAuthStateChanged = onAuthStateChanged;
        window.firebaseSignOut = signOut;
        window.firebaseDoc = doc;
        window.firebaseSetDoc = setDoc;
        window.firebaseGetDoc = getDoc;
        window.firebaseDeleteDoc = deleteDoc;
        window.firebaseCollection = collection;
        window.firebaseAddDoc = addDoc;
        window.firebaseQuery = query;
        window.firebaseOrderBy = orderBy;
        window.firebaseGetDocs = getDocs;
        window.firebaseWhere = where;
        window.firebaseStorageRef = ref;
        window.firebaseUploadBytes = uploadBytes;
        window.firebaseGetDownloadURL = getDownloadURL;
        window.firebaseDeleteObject = deleteObject;
    </script>
    <style>
        /* Tailwind CSS ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼ */
        .gallery-item {
            transition: opacity 0.5s ease-in-out;
        }
        .gallery-item.active {
            opacity: 1;
        }
        .music-card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .music-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        /* ë²„íŠ¼ í˜¸ë²„ íš¨ê³¼ */
        .btn-play:hover {
            background-color: #2563eb;
        }
        .btn-share:hover {
            background-color: #7c3aed;
        }
        .btn-edit:hover {
            background-color: #d97706;
        }
        .btn-delete:hover {
            background-color: #dc2626;
        }

        /* ê°¤ëŸ¬ë¦¬ ì•„ì´í…œ ì¶”ê°€ ìŠ¤íƒ€ì¼ */
        .gallery-item {
            display: none;
            opacity: 0;
        }
        .gallery-item.active {
            display: block;
            opacity: 1;
        }



        /* ê³µìœ  ëª¨ë‹¬ íŒì—… ìŠ¤íƒ€ì¼ */
        #share-modal {
            position: fixed; /* í™”ë©´ì— ê³ ì • */
            z-index: 1000; /* ë‹¤ë¥¸ ìš”ì†Œë“¤ ìœ„ì— í‘œì‹œ */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(205, 117, 117, 0.6); /* ë°˜íˆ¬ëª… ë°°ê²½ */
            display: flex;
            align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            justify-content: center; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
            font-family: Arial, sans-serif;
        }

        .modal-content {
            background-color: #fefefe;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            position: relative;
            text-align: center;
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-button:hover,
        .close-button:focus {
            color: #333;
        }

        .modal-content h2 {
            margin-top: 0;
            color: #333;
            font-size: 1.5em;
        }

        .share-buttons {
            margin: 20px 0;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .share-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: #666;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .share-button:hover {
            background-color: #f0f0f0;
            color: #3498db;
            transform: scale(1.1);
        }

        .share-button svg {
            transition: stroke 0.2s ease;
        }

        .save-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            color: #666;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .save-button:hover {
            background-color: #f0f0f0;
            color: #e74c3c;
            transform: scale(1.1);
        }

        .save-button.saved {
            color: #e74c3c;
        }

        .save-button svg {
            transition: all 0.2s ease;
        }

        .play-button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            color: #333;
            font-size: 16px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 36px;
            height: 36px;
        }

        .play-button:hover {
            background-color: rgba(0, 0, 0, 0.1);
            transform: scale(1.1);
        }

        /* ëª¨ë°”ì¼ ê¸°ë³¸ ìŠ¤íƒ€ì¼ - ì„¸ë¡œëª¨ë“œ ê¸°ì¤€ */
        @media (max-width: 768px) {
            .play-button {
                background: transparent !important;
                color: #333 !important;
                text-shadow: none;
            }

            .play-button:hover {
                background: rgba(0, 0, 0, 0.1) !important;
                transform: scale(1.1);
            }

            .play-button svg {
                filter: none;
            }
        }

        /* ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œì—ì„œ í”Œë ˆì´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ - ê²€ì€ìƒ‰ */
        @media (max-width: 768px) and (orientation: landscape) {
            .play-button {
                background: transparent !important;
                color: #333 !important;
                text-shadow: none;
            }

            .play-button:hover {
                background: rgba(0, 0, 0, 0.1) !important;
                transform: scale(1.1);
            }

            .play-button svg {
                filter: none;
            }
        }

        .copy-link-container {
            display: flex;
            margin-top: 15px;
        }

        #share-link-input {
            flex-grow: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-right: none;
            border-radius: 8px 0 0 8px;
            font-size: 1em;
            background-color: #f5f5f5;
        }

        #copy-link-button {
            padding: 10px 15px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 0 8px 8px 0;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        #copy-link-button:hover {
            background-color: #2980b9;
        }

        /* ğŸ’¡ ì¶”ê°€ëœ ì¹´í…Œê³ ë¦¬ íƒ­ ìŠ¤íƒ€ì¼ */
        .category-tab {
            padding: 6px 8px;
            border: 1px solid #ccc;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #f0f0f0;
            font-weight: bold;
            color: #555;
            white-space: nowrap;
            text-align: center;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 16px;
            min-width: 0;
        }

        .category-tab:hover {
            background-color: #e0e0e0;
        }

        .category-tab.active {
            background-color: #3498db;
            color: white;
            border-color: #3498db;
        }

        /* ì¬ìƒ ì¤‘ì¸ ìŒì•…ì´ ìˆëŠ” ì¹´í…Œê³ ë¦¬ í‘œì‹œ */
        .category-tab.has-playing::after {
            content: 'â—';
            margin-left: 6px;
            color: #ff4757;
            font-size: 12px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.4; }
        }

        /* ìµœìƒìœ„ ë„¤ë¹„ê²Œì´ì…˜ ìŠ¤íƒ€ì¼ */
        .top-nav-item {
            padding: 10px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            border: 2px solid transparent;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .top-nav-item::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            opacity: 0.1;
            transition: opacity 0.3s ease;
        }

        /* LOOKS & LINES - Black & White Minimal */
        .top-nav-item[data-section="visual-mode"] {
            background: linear-gradient(135deg, #000000 0%, #2d3436 100%);
            border-color: #000000;
        }

        .top-nav-item[data-section="visual-mode"].active {
            border-color: #ffffff;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .top-nav-item[data-section="visual-mode"] .top-nav-title {
            color: #ffffff;
        }

        .top-nav-item[data-section="visual-mode"] .top-nav-desc {
            color: #b2bec3;
        }

        /* MOMENTARY - Soft Beige / Emotional */
        .top-nav-item[data-section="momentary"] {
            background: linear-gradient(135deg, #f5e6d3 0%, #d4a574 100%);
            border-color: #d4a574;
        }

        .top-nav-item[data-section="momentary"].active {
            border-color: #8b6f47;
            box-shadow: 0 4px 20px rgba(212, 165, 116, 0.4);
        }

        .top-nav-item[data-section="momentary"] .top-nav-title {
            color: #5a4a3a;
        }

        .top-nav-item[data-section="momentary"] .top-nav-desc {
            color: #7d6a5a;
        }

        /* CHRONICLES - Deep Violet / Cinematic */
        .top-nav-item[data-section="chronicles"] {
            background: linear-gradient(135deg, #5f27cd 0%, #341f97 100%);
            border-color: #5f27cd;
        }

        .top-nav-item[data-section="chronicles"].active {
            border-color: #a55eea;
            box-shadow: 0 4px 20px rgba(95, 39, 205, 0.4);
        }

        .top-nav-item[data-section="chronicles"] .top-nav-title {
            color: #ffffff;
        }

        .top-nav-item[data-section="chronicles"] .top-nav-desc {
            color: #c3aed6;
        }

        .top-nav-item:hover {
            transform: translateY(-2px);
        }

        .top-nav-title {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin: 0;
            text-transform: uppercase;
        }

        /* êµ¬ë… íŒì—… ìŠ¤íƒ€ì¼ */
        #subscription-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            padding: 20px;
            box-sizing: border-box;
        }

        .subscription-content {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            padding: 30px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            text-align: center;
        }

        .subscription-content h2 {
            color: #333;
            margin-bottom: 10px;
            font-size: 2em;
        }

        .subscription-content > p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1em;
        }

        .subscription-plans {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .plan-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            background: #fafafa;
        }

        .plan-card:hover {
            border-color: #ffd700;
            background: #fff;
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 215, 0, 0.3);
        }

        .plan-badge {
            position: absolute;
            top: -10px;
            right: 20px;
            background: linear-gradient(135deg, #ff6b6b, #ee5a6f);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .plan-card h3 {
            color: #333;
            margin: 0 0 15px 0;
            font-size: 1.4em;
        }

        .plan-price {
            font-size: 2.2em;
            font-weight: bold;
            color: #ffd700;
            margin-bottom: 5px;
        }

        .plan-price span {
            font-size: 0.5em;
            color: #666;
        }

        .plan-savings {
            color: #28a745;
            font-weight: bold;
            margin-bottom: 20px;
        }

        .plan-features {
            list-style: none;
            padding: 0;
            margin: 20px 0;
            text-align: left;
        }

        .plan-features li {
            padding: 8px 0;
            color: #555;
        }

        .subscribe-btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 15px;
        }

        .yearly-btn {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
        }

        .yearly-btn:hover {
            background: linear-gradient(135deg, #e6c200, #ffd700);
            transform: translateY(-2px);
        }

        .monthly-btn {
            background: linear-gradient(135deg, #6c757d, #5a6268);
            color: white;
        }

        .monthly-btn:hover {
            background: linear-gradient(135deg, #5a6268, #495057);
            transform: translateY(-2px);
        }

        .payment-info {
            border-top: 1px solid #e0e0e0;
            padding-top: 20px;
            color: #666;
        }

        .payment-info p {
            margin: 5px 0;
            font-size: 0.9em;
        }

        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) {
            .subscription-content {
                padding: 20px;
                margin: 10px;
            }

            .subscription-plans {
                grid-template-columns: 1fr;
            }

            .plan-card {
                padding: 20px;
            }
        }

        /* ì´ë¯¸ì§€ ì‚­ì œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .image-delete-button {
            position: absolute;
            top: 15px;
            left: 15px;
            background-color: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.1em;
            cursor: pointer;
            z-index: 30; /* 20ì—ì„œ 30ìœ¼ë¡œ ë³€ê²½ */
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3); /* ê·¸ë¦¼ì ì¶”ê°€ */
        }

        .image-delete-button:hover {
            background-color: rgba(192, 57, 43, 1);
            transform: scale(1.1);
        }

        .reorder-buttons {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 40;
        }

        .reorder-button {
            background-color: rgba(52, 152, 219, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            font-size: 1.2em;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reorder-button:hover {
            background-color: rgba(41, 128, 185, 1);
            transform: scale(1.1);
        }

        /* í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .toggle-button {
            background-color: #2c3e50 !important;
            opacity: 0.6 !important;
            width: 40px !important;
            height: 40px !important;
            padding: 8px !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 16px !important;
            border: none !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
        }

        .toggle-button.active {
            opacity: 1 !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .toggle-button:hover {
            background-color: #34495e !important;
            transform: scale(1.1) !important;
        }

        .toggle-button.active:hover {
            background-color: #34495e !important;
            transform: scale(1.1) !important;
        }

        /* ìŠ¬ë¼ì´ë“œ íƒ€ì´ë¨¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .slide-timer-button {
            background-color: #3498db !important;
            width: 40px !important;
            height: 40px !important;
            padding: 8px !important;
            border-radius: 50% !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            font-size: 18px !important;
            border: none !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            color: white !important;
        }

        .slide-timer-button:hover {
            background-color: #2980b9 !important;
            transform: scale(1.1) !important;
        }

        /* ì „ì²´ í™”ë©´ ëª¨ë“œì¼ ë•Œ ì‚¬ì´ë“œë°”ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤ */
        body.full-view-active .music-list-container {
            display: none;
        }

        /* ì „ì²´ í™”ë©´ ëª¨ë“œì¼ ë•Œ í”Œë ˆì´ì–´ë¥¼ ìˆ¨ê¹ë‹ˆë‹¤ */
        body.full-view-active .music-player-controls-container {
            display: none;
        }

        /* ê°¤ëŸ¬ë¦¬ ì»¨í…Œì´ë„ˆê°€ ì „ì²´ í™”ë©´ì„ ì°¨ì§€í•˜ë„ë¡ ë§Œë“­ë‹ˆë‹¤ */
        body.full-view-active .gallery-container {
            flex-grow: 1; /* ë‚¨ì€ ê³µê°„ì„ ëª¨ë‘ ì°¨ì§€í•˜ë„ë¡ ì„¤ì • */
            display: flex; /* ì´ë¯¸ì§€ë“¤ì„ ì¤‘ì•™ ì •ë ¬í•˜ê¸° ìœ„í•´ ì¶”ê°€ */
            justify-content: center; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
            align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            width: 100%; /* ë„ˆë¹„ë¥¼ 100%ë¡œ ì„¤ì • */
            height: 100vh; /* ë†’ì´ë¥¼ 100vhë¡œ ì„¤ì • */
            padding: 0; /* íŒ¨ë”© ì œê±° */
            margin: 0; /* ë§ˆì§„ ì œê±° */
            background-color: #000; /* ë°°ê²½ì„ ê²€ì€ìƒ‰ìœ¼ë¡œ ì„¤ì •í•˜ì—¬ ì´ë¯¸ì§€ì— ì§‘ì¤‘ */
        }

        /* ì „ì²´í™”ë©´ ëª¨ë“œì—ì„œ ê°¤ëŸ¬ë¦¬ ë˜í¼ */
        body.full-view-active #gallery-wrapper {
            width: 100%;
            height: 100vh;
            padding: 0;
            margin: 0;
        }

        /* ì „ì²´í™”ë©´ ëª¨ë“œì—ì„œ ì´ë¯¸ì§€ ê°¤ëŸ¬ë¦¬ */
        body.full-view-active #image-gallery {
            width: 100%;
            height: 100vh;
            padding: 0;
            margin: 0;
        }

        /* ì „ì²´í™”ë©´ ëª¨ë“œì—ì„œ ê°¤ëŸ¬ë¦¬ ì•„ì´í…œ */
        body.full-view-active .gallery-item {
            width: 100%;
            height: 100vh;
            padding: 0;
            margin: 0;
        }

        /* ì „ì²´í™”ë©´ ëª¨ë“œì—ì„œë„ ì´ë¯¸ì§€ ì „ì²´ê°€ ë³´ì´ë„ë¡ */
        body.full-view-active .gallery-item img {
            max-width: 100vw;
            max-height: 100vh;
            width: auto;
            height: 100vh; /* ì„¸ë¡œ ë†’ì´ë¥¼ 100vhë¡œ ì„¤ì • */
            object-fit: contain; /* ë¹„ìœ¨ ìœ ì§€í•˜ë©´ì„œ ì „ì²´ê°€ ë³´ì´ë„ë¡ */
        }

        /* ê°¤ëŸ¬ë¦¬ ë‚´ ì´ë¯¸ì§€ë“¤ì„ í’€ì‚¬ì´ì¦ˆë¡œ í‘œì‹œí•©ë‹ˆë‹¤ */
        body.full-view-active .gallery-image-wrapper {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        body.full-view-active .gallery-image-wrapper img {
            max-width: 100vw;
            max-height: 100vh;
            width: auto;
            height: auto;
            object-fit: contain; /* ì´ë¯¸ì§€ ì „ì²´ê°€ ë³´ì´ë„ë¡ */
        }

        /* ì´ë¯¸ì§€ ìˆœì„œ ë³€ê²½ ì…ë ¥ í•„ë“œ ë° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .image-control-container {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.5);
            padding: 5px;
            border-radius: 5px;
            display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
            align-items: center;
            gap: 5px;
            z-index: 10;
            flex-direction: column;
        }

        /* í™œì„±í™”ëœ ì´ë¯¸ì§€ì˜ ì»¨íŠ¸ë¡¤ë§Œ í‘œì‹œ */
        .gallery-item.active .image-control-container {
            display: flex;
        }

        /* ì´ë¯¸ì§€ ë²ˆí˜¸ ìŠ¤íƒ€ì¼ (ì‚¬ìš©ì ìš”ì²­ì— ë”°ë¼ ìœ„ì¹˜ ë° ëª¨ì–‘ ì¡°ì •) */
        .image-number {
            background-color: transparent; /* ë°°ê²½ìƒ‰ ì œê±° */
            color: white;
            padding: 5px 10px;
            border-radius: 50%; /* ì›í˜• ëª¨ì–‘ ìœ ì§€ */
            font-size: 14px;
            font-weight: bold;
            position: static; /* ë¶€ëª¨ ì»¨í…Œì´ë„ˆ ë‚´ì—ì„œ ìƒëŒ€ì  ìœ„ì¹˜ë¡œ ë³€ê²½ */
            top: auto;
            left: auto;
        }

        .reorder-input-container {
            display: flex;
            align-items: center;
        }

        .reorder-input {
            width: 40px;
            padding: 3px;
            text-align: center;
            border: 1px solid #ccc;
            border-radius: 3px;
            font-size: 12px;
        }

        /* ìˆ«ì ì…ë ¥ì°½ì˜ ì¦ê° ë²„íŠ¼ ì œê±° */
        .reorder-input::-webkit-outer-spin-button,
        .reorder-input::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .reorder-input[type=number] {
            -moz-appearance: textfield; /* Firefox */
        }

        .reorder-button {
            padding: 3px 8px;
            font-size: 12px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .reorder-button:hover {
            background-color: #0056b3;
        }

        /* ëª¨ë°”ì¼ ì „ì²´ - ì„¸ë¡œëª¨ë“œ ê³ ì •ìœ¼ë¡œ ê¸°ë³¸ì ìœ¼ë¡œ ì¢Œì¸¡íŒ¨ë„ë§Œ í‘œì‹œ */
        @media (max-width: 768px) {
            html, body {
                width: 100vw !important;
                height: 100vh !important;
                height: 100dvh !important; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ - ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € UI ê³ ë ¤ */
                transform: none !important;
                transform-origin: left top !important;
                overflow: hidden !important;
            }

            .main-container {
                display: block;
                width: 100vw;
                height: 100vh;
                height: 100dvh; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ */
                transform: none !important;
            }

            .music-list-container {
                width: 100%;
                height: 100vh;
                height: 100dvh; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ - ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € UI ê³ ë ¤ */
                border-right: none;
                border-bottom: none;
                position: relative;
                z-index: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; /* iOS ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
            }

            .gallery-container {
                display: none !important;
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
            }

            #gallery-placeholder {
                display: none !important;
            }

            /* ëª¨ë°”ì¼ ì „ì²´í™”ë©´ ê°¤ëŸ¬ë¦¬ */
            body.mobile-portrait-mode .music-list-container {
                display: none;
            }
            body.mobile-portrait-mode .gallery-container {
                display: flex !important;
                background-color: #000;
                position: fixed;
                top: 0;
                left: 0;
                width: 100vw;
                height: 100vh;
                height: 100dvh; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ - ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € UI ê³ ë ¤ */
                z-index: 1000;
            }

            /* ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œì—ì„œ ì´ë¯¸ì§€ê°€ ì „ì²´ ë·°í¬íŠ¸ë¥¼ ë®ë„ë¡ ìŠ¤ì¼€ì¼ë§ */
            body.mobile-portrait-mode .gallery-item {
                width: 100vw !important;
                height: 100vh !important;
                height: 100dvh !important;
                display: flex !important;
                align-items: center;
                justify-content: center;
                position: absolute;
                top: 0;
                left: 0;
            }

            body.mobile-portrait-mode .gallery-item img {
                width: 100vw !important;
                height: 100vh !important;
                height: 100dvh !important;
                max-width: none !important;
                max-height: none !important;
                object-fit: cover !important; /* ì „ì²´ ë·°í¬íŠ¸ë¥¼ ë®ë„ë¡ */
                object-position: center !important;
                user-select: none;
            }

            /* ëª¨ë°”ì¼ ì„¸ë¡œ ëª¨ë“œì—ì„œ í¼ ì»¨í…Œì´ë„ˆë¥¼ ì¢Œì¸¡ íŒ¨ë„ ì˜ì—­ì—ë§Œ í‘œì‹œ (í‘œì‹œë  ë•Œë§Œ) */
            body.mobile-portrait-mode #form-container[style*="flex"] {
                z-index: 1100 !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 50vw !important;
                height: 100vh !important;
                height: 100dvh !important; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ */
                background: rgba(0, 0, 0, 0.8) !important;
                justify-content: center !important;
                align-items: center !important;
            }

            /* ëª¨ë°”ì¼ ì„¸ë¡œ ëª¨ë“œì—ì„œ ë¡œê·¸ì¸ ì„¹ì…˜ì„ ì¢Œì¸¡ íŒ¨ë„ ìŠ¤íƒ€ì¼ë¡œ */
            body.mobile-portrait-mode #form-container .login-section,
            body.mobile-portrait-mode #form-container .upload-section,
            body.mobile-portrait-mode #form-container .edit-section {
                width: 90% !important;
                height: auto !important;
                max-width: 350px !important;
                margin: 0 !important;
                border-radius: 8px !important;
                background: white !important;
                padding: 20px !important;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3) !important;
                overflow-y: auto !important;
                max-height: 80vh !important;
            }

            /* ëª¨ë°”ì¼ ë¡œê·¸ì¸ íŒì—… ìŠ¤íƒ€ì¼ - ë¦¬ìŠ¤íŠ¸ íŒ¨ë„ ë‚´ë¶€ absolute ì˜¤ë²„ë ˆì´ */
            #mobile-login-popup {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                z-index: 2000;
                display: none;
                align-items: center;
                justify-content: center;
                padding: 20px;
                box-sizing: border-box;
            }

            #mobile-login-popup.show {
                display: flex !important;
            }

            #mobile-login-popup .login-section,
            #mobile-login-popup .upload-section,
            #mobile-login-popup .edit-section {
                width: 90%;
                max-width: 350px;
                height: auto;
                max-height: 80%;
                margin: 0;
                border-radius: 8px;
                background: white;
                padding: 20px;
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                overflow-y: auto;
                position: relative;
            }
        }

        /* ëª¨ë°”ì¼ ì „ì²´ëª¨ë“œì—ì„œë§Œ í‘œì‹œë˜ëŠ” ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .mobile-controls {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1001;
            display: none;
            gap: 15px;
            background: transparent;
            padding: 0;
            align-items: center;
        }

        /* PC/ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œì—ì„œ ê°¤ëŸ¬ë¦¬ê°€ í™œì„±í™”ë˜ë©´ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ í‘œì‹œ */
        body:not(.mobile-portrait-mode) .mobile-controls.active {
            display: flex;
        }

        /* ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œì—ì„œ ê°•ì œë¡œ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ í‘œì‹œ */
        @media (max-width: 768px) and (orientation: landscape) {
            .mobile-controls.active {
                display: flex !important;
            }
        }

        /* ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œì—ì„œëŠ” ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
        @media (max-width: 768px) and (orientation: portrait) {
            .mobile-controls {
                display: none !important;
            }

            /* ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œ + ê°¤ëŸ¬ë¦¬ ì „ì²´í™”ë©´ì—ì„œë§Œ í‘œì‹œ */
            body.mobile-portrait-mode .mobile-controls.active {
                display: flex !important;
            }
        }
        .mobile-controls button {
            padding: 12px 16px;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            color: white;
            font-weight: bold;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .mobile-controls .btn-exit {
            background: transparent;
        }

        .mobile-controls .btn-play {
            background: transparent;
            width: 60px;
            height: 60px;
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            font-size: 18px;
        }

        /* ì´ì „/ë‹¤ìŒ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .mobile-controls .btn-prev,
        .mobile-controls .btn-next {
            background: transparent;
            width: 55px;
            height: 55px;
            border-radius: 27.5px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
        }

        .mobile-controls .btn-exit:hover,
        .mobile-controls .btn-exit:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        .mobile-controls .btn-play:hover,
        .mobile-controls .btn-play:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }
        .mobile-controls .btn-prev:hover,
        .mobile-controls .btn-prev:active,
        .mobile-controls .btn-next:hover,
        .mobile-controls .btn-next:active {
            background: rgba(255, 255, 255, 0.2);
            transform: scale(1.05);
        }


        /* PCëª¨ë“œì—ì„œëŠ” ëª©ë¡ìœ¼ë¡œ ë²„íŠ¼ ìˆ¨ê¸°ê¸° ë° í”Œë ˆì´ ë²„íŠ¼ ìš°ì¸¡ íŒ¨ë„ ì¤‘ì•™ì •ë ¬ */
        @media (min-width: 769px) {
            .mobile-controls .btn-exit {
                display: none !important;
            }
            .mobile-controls {
                justify-content: center !important;
                align-items: center !important;
                /* ìš°ì¸¡ íŒ¨ë„(420px ì‹œì‘)ì˜ í•˜ë‹¨ ì¤‘ì•™ì— ë°°ì¹˜ */
                left: calc(420px + (100vw - 420px) / 2);
                bottom: 30px;
                transform: translateX(-50%);
            }
        }

        /* ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œì—ì„œë„ ëª©ë¡ìœ¼ë¡œ ë²„íŠ¼ ìˆ¨ê¸°ê¸° ë° í”Œë ˆì´ ë²„íŠ¼ ìš°ì¸¡ íŒ¨ë„ ì¤‘ì•™ì •ë ¬ */
        @media (max-width: 768px) and (orientation: landscape) {
            .mobile-controls .btn-exit {
                display: none !important;
            }
            .mobile-controls {
                justify-content: center;
                /* ìš°ì¸¡ íŒ¨ë„ì˜ í•˜ë‹¨ ì¤‘ì•™ì— ë°°ì¹˜ (í™”ë©´ì˜ 50%~100% ì˜ì—­ì˜ ì¤‘ì•™ = 75%) */
                left: 75%;
                bottom: 30px;
                transform: translateX(-50%);
            }
        }

        /* Full view ëª¨ë“œì—ì„œ í”Œë ˆì´ ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
        body.full-view-mode .mobile-controls {
            display: none !important;
        }

        /* ì „ì²´í™”ë©´ ì „í™˜ ì•Œë¦¼ ë©”ì‹œì§€ ìŠ¤íƒ€ì¼ */
        .fullscreen-notification {
            position: fixed;
            bottom: 50px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px 25px;
            border-radius: 25px;
            font-size: 16px;
            font-weight: bold;
            backdrop-filter: blur(10px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            z-index: 2000;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
        }

        .fullscreen-notification.show {
            opacity: 1;
        }

        /* form-container ê¸°ë³¸ ìŠ¤íƒ€ì¼ - PCì—ì„œëŠ” ì „ì²´ ìœˆë„ìš° ì¤‘ì•™ì— í‘œì‹œ */
        #form-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            padding: 20px;
            box-sizing: border-box;
        }

        .login-section, .upload-section, .edit-section {
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            padding: 20px;
            max-width: 400px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .close-button {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 30px;
            height: 30px;
            background: none;
            border: none;
            font-size: 20px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s, color 0.2s;
        }

        .close-button:hover {
            background-color: #f0f0f0;
            color: #333;
        }

        .login-section h2, .upload-section h2, .edit-section h2 {
            margin-top: 0;
            margin-bottom: 20px;
            text-align: center;
            color: #333;
        }

        .login-section form, .upload-section form, .edit-section form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .login-section input, .login-section label, .login-section select,
        .upload-section input, .upload-section label,
        .edit-section input, .edit-section label {
            margin: 5px 0;
        }

        .login-section input[type="text"], .login-section input[type="email"], .login-section input[type="password"],
        .login-section input[type="file"], .login-section select,
        .upload-section input[type="text"], .upload-section input[type="file"],
        .edit-section input[type="text"], .edit-section input[type="file"] {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .login-section button, .upload-section button, .edit-section button {
            padding: 12px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }

        .login-section button:hover, .upload-section button:hover, .edit-section button:hover {
            background-color: #0056b3;
        }

        /* ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œì—ì„œ í¼ ì»¨í…Œì´ë„ˆ ìµœì í™” (ê¸°ë³¸ ìŠ¤íƒ€ì¼ ì‚¬ìš©) */

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ ë ˆì´ì•„ì›ƒ */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            color: #333;
            background-color: #f0f2f5;
        }


        .main-container {
            display: flex;
            height: 100vh;
            background-color: #fff;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        /* ì™¼ìª½ - ìŒì•… ì¬ìƒ ëª©ë¡ ì»¨í…Œì´ë„ˆ */
        .music-list-container {
            width: 420px;
            padding: 12px 8px; /* íŒ¨ë”© ëŒ€í­ ì¶•ì†Œ */
            background-color: #f8f9fa;
            border-right: 1px solid #e0e0e0;
            overflow-y: auto;
            position: relative;
            display: flex;
            flex-direction: column;
        }

        /* ì˜¤ë¥¸ìª½ - ê°¤ëŸ¬ë¦¬/ì—…ë¡œë“œ ì»¨í…Œì´ë„ˆ */
        .gallery-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 0;
            position: relative;
            width: 100%;
            height: 100vh;
        }

        /* ì¸ë„¤ì¼ ì´ë¯¸ì§€ ìŠ¤íƒ€ì¼ */
        .music-thumbnail {
            width: 60px;
            height: 78px;
            border-radius: 8px;
            object-fit: cover;
            margin-right: 15px;
            flex-shrink: 0; /* ì´ë¯¸ì§€ê°€ ì¶•ì†Œë˜ì§€ ì•Šë„ë¡ */
            max-width: 60px; /* ìµœëŒ€ í¬ê¸° ì œí•œ */
            max-height: 60px; /* ìµœëŒ€ í¬ê¸° ì œí•œ */
        }

        /* ìŒì•… ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .music-card {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background-color: #fff;
            border-radius: 8px; /* ëª¨ì„œë¦¬ ë°˜ê²½ ì¶•ì†Œ */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.06); /* ê·¸ë¦¼ì ì¶•ì†Œ */
            margin-bottom: 8px; /* ì¹´ë“œ ê°„ê²© ëŒ€í­ ì¶•ì†Œ */
            padding: 10px 12px; /* íŒ¨ë”© ëŒ€í­ ì¶•ì†Œ */
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            min-height: 64px; /* ìµœì†Œ ë†’ì´ ì¶•ì†Œ */
        }

        .music-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
        }

        /* ì¬ìƒ ì¤‘ì¸ ìŒì•… ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .music-card.playing {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 0 4px 20px rgba(102, 126, 234, 0.4);
            border: 2px solid #667eea;
        }

        .music-card.playing .music-info h3,
        .music-card.playing .category-text {
            color: white !important;
        }

        .music-card.playing .music-info {
            color: white;
        }

        /* ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ */
        .button-container {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-left: 15px;
        }

        /* ì‚¬ê°í˜• ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .square-button {
            width: 36px !important;
            height: 36px !important;
            border-radius: 6px !important;
            border: none !important;
            cursor: pointer !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            transition: all 0.2s ease !important;
            font-size: 14px !important;
        }

        .square-button:hover {
            transform: scale(1.1) !important;
        }

        /* ê° ë²„íŠ¼ë³„ ìƒ‰ìƒ */
        .play-button.square-button {
            background-color: #3498db !important;
            color: white !important;
        }

        .share-button.square-button {
            background-color: #9b59b6 !important;
            color: white !important;
        }

        .save-button.square-button {
            background-color: #e67e22 !important;
            color: white !important;
        }

        .edit-button.square-button {
            background-color: #f39c12 !important;
            color: white !important;
        }

        .delete-button.square-button {
            background-color: #e74c3c !important;
            color: white !important;
        }

        .music-info {
            display: flex;
            align-items: center;
            flex-grow: 1;
            min-width: 0; /* í…ìŠ¤íŠ¸ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€ */
        }

        .music-info > div {
            flex-grow: 1;
            min-width: 0; /* í…ìŠ¤íŠ¸ ì˜¤ë²„í”Œë¡œìš° ë°©ì§€ */
        }

        .music-info h3 {
            margin: 0;
            font-size: 1.1em;
            color: #2c3e50;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* ê°¤ëŸ¬ë¦¬ ìŠ¤íƒ€ì¼ */
        #gallery-placeholder {
            text-align: center;
            color: #999;
        }

        #gallery-wrapper {
            position: relative;
            width: 100%;
            height: 100%;
            border-radius: 0;
            box-shadow: none;
            overflow: hidden;
            display: none;
            background-color: #2c3e50;
        }

        #gallery-wrapper.active {
            display: flex;
        }

        #image-gallery {
            width: 100%;
            height: 100%;
            position: relative;
            display: flex;
            align-items: stretch; /* stretchë¡œ ë³€ê²½í•˜ì—¬ ë†’ì´ë¥¼ ì™„ì „íˆ ì±„ì›€ */
            justify-content: center;
        }

        /* ìŒì•… í”Œë ˆì´ì–´ íƒ€ì´í‹€ ì»¨í…Œì´ë„ˆ */
        .music-player-title-container {
            position: relative;
            background-color: #f8f9fa;
            margin-bottom: 12px; /* ë§ˆì§„ ì¶•ì†Œ */
            z-index: 10;
        }

        .music-player-title-container h1 {
            font-size: 2em;
            color: #2c3e50;
            margin: 0 0 10px 0;
        }

        /* ë¡œê·¸ì¸ ìƒíƒœ ì»¨í…Œì´ë„ˆ */
        .login-status {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            margin-top: 10px;
            gap: 10px;
        }

        .login-status button {
            padding: 8px 16px;
            background-color: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }

        .login-status button:hover {
            background-color: #2980b9;
        }

        /* í¬ì¸íŠ¸ í‘œì‹œ ì˜ì—­ */
        .points-display {
            display: flex;
            align-items: center;
            gap: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 8px 16px;
            border-radius: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .username-display:hover {
            opacity: 0.8;
            text-decoration: underline;
        }

        .points-item {
            display: flex;
            align-items: center;
            gap: 5px;
            color: white;
            font-weight: 600;
            font-size: 14px;
        }

        .points-item .icon {
            font-size: 16px;
        }

        .daily-bonus-btn {
            padding: 6px 12px !important;
            background-color: #e74c3c !important;
            font-size: 12px !important;
            animation: pulse 2s infinite;
        }

        .daily-bonus-btn:hover {
            background-color: #c0392b !important;
        }

        .daily-bonus-btn:disabled {
            background-color: #95a5a6 !important;
            cursor: not-allowed;
            animation: none;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .username-display {
            color: white;
            font-weight: 600;
            font-size: 14px;
            margin-left: auto; /* ìš°ì¸¡ìœ¼ë¡œ ë°€ì–´ëƒ„ */
            padding-left: 10px;
        }

        /* ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œì—ì„œ íƒ€ì´í‹€ê³¼ ë¡œê·¸ì¸ ì˜ì—­ ìµœì í™” */
        @media (max-width: 768px) and (orientation: landscape) {
            .music-player-title-container {
                margin-bottom: 15px;
            }

            .music-player-title-container h1 {
                font-size: 1.5em;
                margin: 0 0 8px 0;
            }

            .login-status {
                margin-top: 5px;
            }

            .login-status button {
                padding: 6px 12px;
                font-size: 12px;
            }
        }

        /* ê°¤ëŸ¬ë¦¬ ì•„ì´í…œ ìŠ¤íƒ€ì¼ */
        .gallery-item {
            display: none;
            width: 100%;
            height: 100%;
            position: absolute;
            top: 0;
            left: 0;
            cursor: pointer;
            align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            justify-content: center; /* ê°€ë¡œ ì¤‘ì•™ ì •ë ¬ */
        }

        .gallery-item.active {
            display: flex; /* activeì¼ ë•Œë„ flex ìœ ì§€ */
        }

        .gallery-item img {
            max-width: 100%;
            max-height: 100%; /* ì»¨í…Œì´ë„ˆ ë†’ì´ë¥¼ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ */
            width: auto;
            height: auto;
            object-fit: contain; /* ì´ë¯¸ì§€ ì „ì²´ê°€ ë³´ì´ë„ë¡ */
            user-select: none;
            object-position: center; /* ì´ë¯¸ì§€ì˜ ì¤‘ì•™ ë¶€ë¶„ì„ í‘œì‹œ */
        }

        /* ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œ - 50:50 ë ˆì´ì•„ì›ƒ */
        @media (max-width: 768px) and (orientation: landscape) {
            html, body {
                width: 100vw !important;
                height: 100vh !important;
                height: 100dvh !important; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ - ëª¨ë°”ì¼ ë¸Œë¼ìš°ì € UI ê³ ë ¤ */
                transform: none !important;
                transform-origin: left top !important;
                overflow: hidden !important;
            }

            .main-container {
                display: flex !important;
                flex-direction: row !important;
                width: 100vw;
                height: 100vh;
                height: 100dvh; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ */
                min-height: 100vh; /* ìµœì†Œ ë†’ì´ ë³´ì¥ */
                min-height: 100dvh;
            }

            .music-list-container {
                width: 50% !important;
                height: 100vh !important;
                height: 100dvh !important;
                min-height: 100vh;
                min-height: 100dvh;
                border-right: 1px solid #e0e0e0;
                border-bottom: none;
                position: relative;
                z-index: 1;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch; /* iOS ë¶€ë“œëŸ¬ìš´ ìŠ¤í¬ë¡¤ */
                display: flex !important;
                flex-direction: column;
                /* ìŠ¤í¬ë¡¤ë°” ì˜ì—­ í™•ë³´ */
                scrollbar-width: thin;
                scrollbar-color: rgba(0,0,0,0.3) transparent;
            }

            /* ì›¹í‚· ë¸Œë¼ìš°ì €ìš© ìŠ¤í¬ë¡¤ë°” ìŠ¤íƒ€ì¼ */
            .music-list-container::-webkit-scrollbar {
                width: 6px;
            }

            .music-list-container::-webkit-scrollbar-track {
                background: transparent;
            }

            .music-list-container::-webkit-scrollbar-thumb {
                background: rgba(0,0,0,0.3);
                border-radius: 3px;
            }

            /* ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œì—ì„œ ìŒì•… ë¦¬ìŠ¤íŠ¸ ì»´íŒ©íŠ¸ ë ˆì´ì•„ì›ƒ */
            .music-list-container {
                padding: 8px 6px !important; /* íŒ¨ë”© ëŒ€í­ ì¶•ì†Œ */
            }

            .music-card {
                margin-bottom: 6px !important; /* ì¹´ë“œ ê°„ê²© ëŒ€í­ ì¶•ì†Œ */
                min-height: 60px !important; /* ìµœì†Œ ë†’ì´ ëŒ€í­ ì¶•ì†Œ */
                padding: 4px 10px !important; /* ìƒí•˜ íŒ¨ë”© ì¶•ì†Œ */
            }

            /* ì œëª©ê³¼ ë¡œê·¸ì¸ ì˜ì—­ ì»´íŒ©íŠ¸í•˜ê²Œ */
            .music-player-title-container {
                margin-bottom: 10px !important;
            }

            .music-player-title-container h1 {
                font-size: 1.3em !important; /* í°íŠ¸ ì‚¬ì´ì¦ˆ ì•½ê°„ ì¶•ì†Œ */
                margin-bottom: 8px !important;
            }

            /* ì¹´í…Œê³ ë¦¬ íƒ­ ì»´íŒ©íŠ¸í•˜ê²Œ */
            #category-tabs {
                margin-bottom: 15px !important;
                gap: 4px !important;
                display: grid !important;
                grid-template-columns: repeat(3, 1fr) !important;
            }

            .category-tab {
                padding: 5px 6px !important; /* íƒ­ íŒ¨ë”© ë” ì¶•ì†Œ */
                font-size: 18px !important;
            }

            /* ìŠ¤í¬ë¡¤ ì˜ì—­ì— ì¶”ê°€ ì—¬ë°± í™•ë³´ */
            .music-list-container::after {
                content: "";
                display: block;
                height: 20px; /* ë§ˆì§€ë§‰ì— ì—¬ë°± ì¶”ê°€ */
            }

            .gallery-container {
                display: flex !important;
                width: 50% !important;
                height: 100vh !important;
                height: 100dvh !important;
                min-height: 100vh;
                min-height: 100dvh;
                background-color: #2c3e50;
                position: relative;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                overflow: hidden; /* ê°¤ëŸ¬ë¦¬ ì»¨í…Œì´ë„ˆ ì˜¤ë²„í”Œë¡œìš° ì œì–´ */
            }

            #gallery-placeholder {
                display: flex !important;
                color: #999;
                text-align: center;
                align-items: center;
                justify-content: center;
                width: 100%;
                height: 100%;
            }

            /* ê°¤ëŸ¬ë¦¬ê°€ í™œì„±í™”ë˜ë©´ í”Œë ˆì´ìŠ¤í™€ë” ìˆ¨ê¹€ */
            .gallery-container:has(#gallery-wrapper.active) #gallery-placeholder {
                display: none !important;
            }

            /* ëŒ€ì•ˆ ë°©ë²•: ê°¤ëŸ¬ë¦¬ wrapperê°€ í‘œì‹œë  ë•Œ í”Œë ˆì´ìŠ¤í™€ë” ìˆ¨ê¹€ */
            #gallery-wrapper {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 2;
                overflow: hidden; /* ê°¤ëŸ¬ë¦¬ ë˜í¼ ì˜¤ë²„í”Œë¡œìš° ì œì–´ */
            }

            #gallery-placeholder {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                z-index: 1;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            /* ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œì—ì„œ ê°¤ëŸ¬ë¦¬ ì´ë¯¸ì§€ ìµœì í™” */
            .gallery-item {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                position: absolute;
                top: 0;
                left: 0;
            }

            .gallery-item img {
                max-width: calc(100% - 20px); /* ì¢Œìš° ì—¬ë°± í™•ë³´ */
                max-height: calc(100% - 20px); /* ìƒí•˜ ì—¬ë°± í™•ë³´ */
                width: auto;
                height: auto;
                object-fit: contain;
                object-position: center;
            }

            #gallery-wrapper {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
            }

            #image-gallery {
                width: 100%;
                height: 100%;
                display: flex;
                align-items: center;
                justify-content: center;
                position: relative;
            }
        }

        /* PCì™€ ê°€ë¡œëª¨ë“œì—ì„œ ê°¤ëŸ¬ë¦¬ ìµœì í™” */
        @media (orientation: landscape) {
            /* ê°€ë¡œ ëª¨ë“œì—ì„œ ì´ë¯¸ì§€ ì „ì²´ê°€ ë³´ì´ë„ë¡ */
            .gallery-item img {
                max-width: 100%;
                max-height: 100%; /* ì»¨í…Œì´ë„ˆ ë†’ì´ë¥¼ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ */
                width: auto;
                height: auto;
                object-fit: contain; /* ì´ë¯¸ì§€ ì „ì²´ê°€ ë³´ì´ë„ë¡ */
                object-position: center;
            }

            /* ê°¤ëŸ¬ë¦¬ ì»¨í…Œì´ë„ˆë„ ë†’ì´ë¥¼ ì™„ì „íˆ í™œìš© */
            .gallery-container {
                height: 100vh;
                height: 100dvh; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì‚¬ìš© */
            }

            #gallery-wrapper {
                height: 100vh;
                height: 100dvh; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì‚¬ìš© */
            }

            #image-gallery {
                height: 100vh;
                height: 100dvh; /* ë™ì  ë·°í¬íŠ¸ ë†’ì´ ì‚¬ìš© */
                align-items: center; /* ì„¸ë¡œ ì¤‘ì•™ ì •ë ¬ */
            }
        }



        /* ê°¤ëŸ¬ë¦¬ ë©”ì‹œì§€ í‘œì‹œ ìŠ¤íƒ€ì¼ */
        .gallery-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: transparent;
            color: white;
            font-size: 17px;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease-in-out;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            white-space: pre-line;
            text-align: center;
        }

        .gallery-message.show {
            opacity: 1;
        }

        /* ë°ìŠ¤í¬í†±ì—ì„œ ì´ë¯¸ì§€ ì „ì²´ê°€ ë³´ì´ë„ë¡ ìµœì í™” */
        @media (min-width: 769px) {
            .gallery-item img {
                max-width: 100%;
                max-height: 100%; /* ì»¨í…Œì´ë„ˆ ë†’ì´ë¥¼ ì´ˆê³¼í•˜ì§€ ì•Šë„ë¡ */
                width: auto;
                height: auto;
                object-fit: contain; /* ì´ë¯¸ì§€ ì „ì²´ê°€ ë³´ì´ë„ë¡ */
                object-position: center;
            }
        }


    </style>
</head>
<body>
    <!-- ë²„ì „ í‘œì‹œ (ìš°ì¸¡ í•˜ë‹¨) -->
    <div id="version-display" style="position: fixed; bottom: 5px; right: 5px; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 5px; font-size: 11px; z-index: 9999; font-family: monospace;">
        v2024-11-05-v18
    </div>

    <div class="main-container">
        <div class="music-list-container">
            <div class="music-player-title-container">
                <h1>ğŸµ PIXEL SUNDAY </h1>
                <div class="login-status" id="login-status">
                </div>
            </div>

            <!-- ìµœìƒìœ„ ë„¤ë¹„ê²Œì´ì…˜ -->
            <div id="top-navigation" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 16px;">
                <div class="top-nav-item" data-section="visual-mode" onclick="selectTopSection('visual-mode')">
                    <div class="top-nav-title">Looks & Lines</div>
                </div>
                <div class="top-nav-item" data-section="momentary" onclick="selectTopSection('momentary')">
                    <div class="top-nav-title">MOMENTARY</div>
                </div>
                <div class="top-nav-item" data-section="chronicles" onclick="selectTopSection('chronicles')">
                    <div class="top-nav-title">CHRONICLES</div>
                </div>
            </div>

            <!-- ì¹´í…Œê³ ë¦¬ íƒ­ (ê° ì„¹ì…˜ì˜ í•˜ìœ„ ì¹´í…Œê³ ë¦¬ í‘œì‹œ) -->
            <div id="category-tabs" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; margin-bottom: 12px;"></div>
            <div id="mobile-login-popup"></div>
            <div id="music-player-container">
            </div>
            <div id="pagination-container">
            </div>
        </div>

        <div class="gallery-container">
            <div id="gallery-placeholder">
                <p>ìŒì•…ì„ í´ë¦­í•˜ë©´ ì´ë¯¸ì§€ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤.</p>
            </div>
            <div id="gallery-wrapper">
                <div id="image-gallery">
                </div>
                <!-- ìŒì› ë‚¨ì€ ì‹œê°„ í‘œì‹œ -->
                <div id="audio-timer" style="display: none; position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 8px 16px; border-radius: 20px; font-size: 14px; font-weight: 600; z-index: 9998; font-family: monospace; backdrop-filter: blur(10px);">
                    <span id="audio-current-time">0:00</span> / <span id="audio-duration">0:00</span>
                </div>
            </div>
            <div id="form-container" style="display: none;"></div>

        </div>
    </div>
    
    <div id="share-modal" style="display: none;">
        <div class="modal-content">
            <span class="close-button" onclick="hideShareModal()">&times;</span>
            <h2>ìŒì•… ê³µìœ í•˜ê¸°</h2>
            <p>ë§í¬ë¥¼ ë³µì‚¬í•˜ì—¬ ê³µìœ í•˜ì„¸ìš”.</p>
            <div class="copy-link-container">
                <input type="text" id="share-link-input" readonly>
                <button id="copy-link-button">ë³µì‚¬</button>
            </div>
        </div>
    </div>

    <!-- ì„±ì¸ ì¸ì¦ í•„ìš” ëª¨ë‹¬ -->
    <div id="adult-verification-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 10000; justify-content: center; align-items: center;">
        <div class="modal-content" style="background: white; border-radius: 12px; padding: 30px; max-width: 450px; width: 90%; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
            <div style="font-size: 50px; margin-bottom: 20px;">ğŸ”</div>
            <h2 style="font-size: 24px; font-weight: bold; margin-bottom: 10px; color: #333;">ì„±ì¸ ì¸ì¦</h2>
            <p style="font-size: 14px; color: #666; margin-bottom: 25px;">
                ë§Œ 19ì„¸ ì´ìƒ ì„±ì¸ ì½˜í…ì¸  ì´ìš©ì„ ìœ„í•´<br>íœ´ëŒ€í° ë³¸ì¸ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤.
            </p>

            <!-- íœ´ëŒ€í° ë²ˆí˜¸ ì…ë ¥ -->
            <div style="margin-bottom: 20px; text-align: left;">
                <label style="display: block; font-size: 14px; font-weight: 600; color: #333; margin-bottom: 8px;">íœ´ëŒ€í° ë²ˆí˜¸</label>
                <div style="display: flex; gap: 8px;">
                    <input type="tel" id="phone-number-input" placeholder="010-0000-0000" maxlength="13"
                           style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px;"
                           onkeyup="formatPhoneNumber(this)">
                    <button onclick="sendVerificationCode()" id="send-code-btn"
                            style="background: #3b82f6; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                        ì¸ì¦ë²ˆí˜¸ ë°œì†¡
                    </button>
                </div>
            </div>

            <!-- ì¸ì¦ë²ˆí˜¸ ì…ë ¥ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
            <div id="verification-code-section" style="display: none; margin-bottom: 20px; text-align: left;">
                <label style="display: block; font-size: 14px; font-weight: 600; color: #333; margin-bottom: 8px;">ì¸ì¦ë²ˆí˜¸</label>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="verification-code-input" placeholder="ì¸ì¦ë²ˆí˜¸ 6ìë¦¬" maxlength="6"
                           style="flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 15px;">
                    <span id="timer" style="color: #ef4444; font-weight: 600; padding: 12px; font-size: 14px; white-space: nowrap;">3:00</span>
                </div>
                <p style="font-size: 12px; color: #666; margin-top: 8px;">
                    ì¸ì¦ë²ˆí˜¸ê°€ ì˜¤ì§€ ì•Šìœ¼ë©´ <a href="#" onclick="sendVerificationCode(); return false;" style="color: #3b82f6; text-decoration: underline;">ì¬ë°œì†¡</a>
                </p>
            </div>

            <!-- ì£¼ì˜ì‚¬í•­ -->
            <div style="background: #f3f4f6; padding: 15px; border-radius: 8px; margin-bottom: 20px; text-align: left;">
                <p style="font-size: 12px; color: #666; line-height: 1.6; margin: 0;">
                    âš ï¸ ë³¸ì¸ ëª…ì˜ì˜ íœ´ëŒ€í°ìœ¼ë¡œë§Œ ì¸ì¦ ê°€ëŠ¥í•©ë‹ˆë‹¤.<br>
                    ğŸ“± ì¸ì¦ë²ˆí˜¸ëŠ” SMSë¡œ ë°œì†¡ë©ë‹ˆë‹¤.<br>
                    ğŸ”’ ì…ë ¥í•˜ì‹  ì •ë³´ëŠ” ì•ˆì „í•˜ê²Œ ë³´í˜¸ë©ë‹ˆë‹¤.
                </p>
            </div>

            <!-- ë²„íŠ¼ -->
            <div style="display: flex; gap: 10px;">
                <button onclick="closeAdultVerificationModal()"
                        style="flex: 1; background: #e5e7eb; color: #333; border: none; padding: 14px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer;">
                    ì·¨ì†Œ
                </button>
                <button onclick="submitAdultVerification()" id="submit-verification-btn" disabled
                        style="flex: 1; background: #3b82f6; color: white; border: none; padding: 14px; border-radius: 8px; font-size: 15px; font-weight: 600; cursor: pointer; opacity: 0.5;">
                    ì¸ì¦ ìš”ì²­
                </button>
            </div>
        </div>
    </div>

    <script>
        // ë²„ì „ í™•ì¸ - ë°°í¬ í™•ì¸ìš©
        const APP_VERSION = '2024-11-05-v17';
        console.clear(); // ì½˜ì†” ì´ˆê¸°í™”
        console.log('========================================');
        console.log('ì• í”Œë¦¬ì¼€ì´ì…˜ ë²„ì „:', APP_VERSION);
        console.log('ë¡œë“œ ì‹œê°„:', new Date().toISOString());
        console.log('UPDATE: í¬ë¦¬ì—ì´í„° ê´€ë¦¬ í˜ì´ì§€ì— ìë™ì „í™˜ ì‹œê°„ ì„¤ì • UI ì¶”ê°€');
        console.log('INFO: creator-manage.htmlì—ì„œ ê°¤ëŸ¬ë¦¬ë³„ ìë™ì „í™˜ ì‹œê°„ ìˆ˜ì • ê°€ëŠ¥');
        console.log('========================================');

        // í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ ì‹œ alert í‘œì‹œ
        window.addEventListener('load', function() {
            console.log('í˜ì´ì§€ ë¡œë“œ ì™„ë£Œ!');

            // ì´ˆê¸° ë¡œë“œ ì‹œ Looks & Lines í™œì„±í™”
            setTimeout(() => {
                selectTopSection('visual-mode');
            }, 500);
        });

        let mySunoMusic = []; // ì „ì²´ ìŒì•… ëª©ë¡
        let mySavedMusic = []; // ì €ì¥í•œ ìŒì•… ëª©ë¡
        let allMusicData = []; // ëª¨ë“  ìŒì•… ë°ì´í„° (ì¹´í…Œê³ ë¦¬ ë¬´ê´€)
        let isShowingLiked = false; // ì¢‹ì•„ìš” ëª©ë¡ì„ ë³´ì—¬ì£¼ëŠ” ìƒíƒœì¸ì§€ ì¶”ì 
        let isShowingRecommended = false; // ì¶”ì²œ ê°¤ëŸ¬ë¦¬ ëª©ë¡ì„ ë³´ì—¬ì£¼ëŠ” ìƒíƒœì¸ì§€ ì¶”ì 
        let isShowingSaved = false; // ì €ì¥ëœ ìŒì•… ëª©ë¡ì„ ë³´ì—¬ì£¼ëŠ” ìƒíƒœì¸ì§€ ì¶”ì 
        let isShowingUserInfo = false; // ì‚¬ìš©ì ì •ë³´ë¥¼ ë³´ì—¬ì£¼ëŠ” ìƒíƒœì¸ì§€ ì¶”ì 
        let currentAudio = null;
        let currentMusicIndex = -1; // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ìŒì•…ì˜ ì¸ë±ìŠ¤ ì¶”ê°€
        let currentGalleryInfo = null; // í˜„ì¬ ê°¤ëŸ¬ë¦¬ì— í‘œì‹œì¤‘ì¸ ìŒì› ì •ë³´ { musicId, audioSrc, images }
        let currentImageInterval = null;
        let userRole = null;
        let userName = null;
        let isAdultVerified = false; // ì„±ì¸ ì¸ì¦ ìƒíƒœ
        let itemsPerPage = 8; // í•œ í˜ì´ì§€ì— í‘œì‹œí•  í•­ëª© ìˆ˜
        let totalItems = 0;
        let totalPages = 0;
        let currentPage = 1;
        let currentImageIndex = 0; // í˜„ì¬ ì´ë¯¸ì§€ ì¸ë±ìŠ¤ ì¶”ê°€
        let currentCategory = null; // ğŸ’¡ í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ ìƒíƒœ (ì²« ë¡œë“œ ì‹œ ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬ë¡œ ì„¤ì •ë¨)
        let currentTopSection = 'visual-mode'; // í˜„ì¬ ì„ íƒëœ ìµœìƒìœ„ ì„¹ì…˜ (visual-mode, momentary, chronicles)
        let galleryInterval = null; // ìë™ ì „í™˜ íƒ€ì´ë¨¸ë¥¼ ì œì–´í•˜ê¸° ìœ„í•œ ë³€ìˆ˜
        let isAutoTransitioning = true; // í˜„ì¬ ìë™ ì „í™˜ ìƒíƒœë¥¼ ì¶”ì í•˜ëŠ” í”Œë˜ê·¸
        let autoOpenGallery = false; // ì¹´í…Œê³ ë¦¬ ì„ íƒ í›„ ê°¤ëŸ¬ë¦¬ ìë™ ì˜¤í”ˆ í”Œë˜ê·¸
        let isInitialLoad = true; // ì•± ì‹œì‘ì‹œ ì²«ë²ˆì§¸ ì´ë¯¸ì§€ ìë™ ì„ íƒ í”Œë˜ê·¸
        let isFullViewMode = false; // ì „ì²´í™”ë©´ ë³´ê¸° ëª¨ë“œ ìƒíƒœ ì¶”ì 
        let currentAutoplayTiming = 3000; // ê¸°ë³¸ê°’ 3ì´ˆ
        let isMobilePortraitMode = false; // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œ ìƒíƒœ ì¶”ì 
        let currentGalleryName = ''; // í˜„ì¬ ê°¤ëŸ¬ë¦¬ëª… ì €ì¥

        // ëª¨ë°”ì¼ ê°ì§€ ë° ì œì–´ í•¨ìˆ˜
        function checkMobileOrientation() {
            const isMobile = window.innerWidth <= 768;
            const isLandscape = window.innerWidth > window.innerHeight;

            // í”Œë ˆì´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
            updatePlayButtonStyles(isMobile, isLandscape);

            // ì „ì²´í™”ë©´ ë²„íŠ¼ ìˆ¨ê¹€/í‘œì‹œ
            const fullViewButton = document.getElementById('full-view-button');
            if (fullViewButton) {
                if (isMobile) {
                    fullViewButton.style.display = 'none';
                } else {
                    fullViewButton.style.display = '';
                }
            }

            if (isMobile && isLandscape) {
                // ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œì—ì„œëŠ” 50:50 ë ˆì´ì•„ì›ƒ (CSSë¡œ ì²˜ë¦¬ë¨)
                if (isMobilePortraitMode) {
                    disableMobilePortraitMode();
                }

                // ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œì—ì„œ ê°¤ëŸ¬ë¦¬ê°€ í‘œì‹œ ì¤‘ì´ë©´ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ í™œì„±í™”
                const galleryWrapper = document.getElementById('gallery-wrapper');
                const isGalleryVisible = galleryWrapper && galleryWrapper.style.display !== 'none' && galleryWrapper.classList.contains('active');

                if (isGalleryVisible) {
                    if (!document.getElementById('mobile-controls')) {
                        addMobileControls();
                    } else {
                        const existingControls = document.getElementById('mobile-controls');
                        existingControls.style.display = 'flex';
                        existingControls.classList.add('active');
                    }
                }
            } else if (isMobile && !isLandscape) {
                // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œì—ì„œëŠ” ê³¡ì´ ì¬ìƒ ì¤‘ì´ê±°ë‚˜ ê°¤ëŸ¬ë¦¬ê°€ í‘œì‹œ ì¤‘ì¼ ë•Œ ì „ì²´í™”ë©´ìœ¼ë¡œ ì „í™˜
                const galleryWrapper = document.getElementById('gallery-wrapper');
                const isGalleryVisible = galleryWrapper && galleryWrapper.style.display !== 'none' && galleryWrapper.classList.contains('active');

                if (!isMobilePortraitMode && ((currentAudio && !currentAudio.paused) || isGalleryVisible)) {
                    enableMobilePortraitMode();
                }
                // ì¼ì‹œì •ì§€ ìƒíƒœì´ê³  ê°¤ëŸ¬ë¦¬ê°€ ë³´ì´ì§€ ì•Šì„ ë•ŒëŠ” ëª©ë¡ í™”ë©´ ìœ ì§€
            } else {
                // PCì—ì„œëŠ” ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œë§Œ í•´ì œ (ì»¨íŠ¸ë¡¤ì€ ìœ ì§€)
                if (isMobilePortraitMode) {
                    isMobilePortraitMode = false;
                    document.body.classList.remove('mobile-portrait-mode');
                }
            }
        }

        // í”Œë ˆì´ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updatePlayButtonStyles(isMobile, isLandscape) {
            const playButtons = document.querySelectorAll('.play-button');
            playButtons.forEach(button => {
                if (isMobile) {
                    if (isLandscape) {
                        // ê°€ë¡œëª¨ë“œ: ê²€ì€ìƒ‰
                        button.style.color = '#333';
                        button.style.textShadow = 'none';
                        if (button.querySelector('svg')) {
                            button.querySelector('svg').style.filter = 'none';
                        }
                    } else {
                        // ì„¸ë¡œëª¨ë“œ: ê²€ì€ìƒ‰
                        button.style.color = '#333';
                        button.style.textShadow = 'none';
                        if (button.querySelector('svg')) {
                            button.querySelector('svg').style.filter = 'none';
                        }
                    }
                } else {
                    // ë°ìŠ¤í¬í†±: ê¸°ë³¸ ìŠ¤íƒ€ì¼
                    button.style.color = '#333';
                    button.style.textShadow = 'none';
                    if (button.querySelector('svg')) {
                        button.querySelector('svg').style.filter = 'none';
                    }
                }
            });
        }

        function enableMobilePortraitMode() {
            if (isMobilePortraitMode) return; // ì´ë¯¸ í™œì„±í™”ëœ ê²½ìš° ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€

            isMobilePortraitMode = true;
            document.body.classList.add('mobile-portrait-mode');

            // ê¸°ì¡´ ì»¨íŠ¸ë¡¤ì´ ìˆìœ¼ë©´ ë‹¤ì‹œ ë³´ì´ë„ë¡ í•˜ê³ , ì—†ìœ¼ë©´ ìƒˆë¡œ ìƒì„±
            const existingControls = document.getElementById('mobile-controls');
            if (existingControls) {
                existingControls.style.display = 'flex';
                existingControls.classList.add('active');
            } else {
                addMobileControls();
            }

            // íˆìŠ¤í† ë¦¬ì— ìƒíƒœ ì¶”ê°€ (ë’¤ë¡œê°€ê¸° ì§€ì›)
            window.history.pushState({ galleryOpen: true, timestamp: Date.now() }, '');
        }

        function disableMobilePortraitMode() {
            isMobilePortraitMode = false;
            document.body.classList.remove('mobile-portrait-mode');

            // ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ìˆ¨ê¸°ê¸° (ì œê±°í•˜ì§€ ì•Šê³  ìˆ¨ê¹€)
            const mobileControls = document.getElementById('mobile-controls');
            if (mobileControls) {
                mobileControls.style.display = 'none';
                mobileControls.classList.remove('active');
            }
        }

        function addMobileControls() {
            // ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì»¨íŠ¸ë¡¤ì´ ìˆë‹¤ë©´ ìƒì„±í•˜ì§€ ì•ŠìŒ
            if (document.getElementById('mobile-controls')) {
                return;
            }

            const mobileControls = document.createElement('div');
            mobileControls.id = 'mobile-controls';
            mobileControls.className = 'mobile-controls active';

            // í˜„ì¬ ì¬ìƒ ìƒíƒœì— ë”°ë¼ ë²„íŠ¼ SVG ì•„ì´ì½˜ ê²°ì •
            const playButtonIcon = (currentAudio && !currentAudio.paused) ?
                `<svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                </svg>` :
                `<svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                    <path d="M8 5v14l11-7z"/>
                </svg>`;

            mobileControls.innerHTML = `
                <button onclick="playPreviousMusic()" class="btn-play btn-prev" title="ì´ì „ ê°¤ëŸ¬ë¦¬">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M6 6h2v12H6zm3.5 6l8.5 6V6z"/>
                    </svg>
                </button>
                <button onclick="toggleMobilePlayPause()" class="btn-play" id="mobile-play-btn">
                    ${playButtonIcon}
                </button>
                <button onclick="playNextMusic()" class="btn-play btn-next" title="ë‹¤ìŒ ê°¤ëŸ¬ë¦¬">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M6 18l8.5-6L6 6v12zM16 6v12h2V6h-2z"/>
                    </svg>
                </button>
            `;
            document.body.appendChild(mobileControls);

            // Media Session API ì„¤ì • (ë¸”ë£¨íˆ¬ìŠ¤/í—¤ë“œí° ì»¨íŠ¸ë¡¤ ì—°ë™)
            setupMediaSession();
        }

        function exitMobilePortraitMode() {
            disableMobilePortraitMode();
            hideGallery();
        }

        function toggleMobilePlayPause() {
            if (currentAudio) {
                const musicId = currentAudio.id.replace('audio-', '');
                const listButton = document.querySelector(`.music-card[data-music-id="${musicId}"] .play-button`);
                const mobileButton = document.getElementById('mobile-play-btn');

                if (currentAudio.paused) {
                    currentAudio.play();
                    if (mobileButton) {
                        mobileButton.innerHTML = `
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                            </svg>
                        `;
                    }
                    if (listButton) {
                        listButton.innerHTML = `
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                            </svg>
                        `;
                    }
                } else {
                    currentAudio.pause();
                    if (mobileButton) {
                        mobileButton.innerHTML = `
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        `;
                    }
                    if (listButton) {
                        listButton.innerHTML = `
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        `;
                    }
                    // ì¼ì‹œì •ì§€ ì‹œì—ëŠ” ê°¤ëŸ¬ë¦¬ì— ê·¸ëŒ€ë¡œ ë‚¨ìŒ (ëª¨ë°”ì¼ ëª¨ë“œ ìœ ì§€)
                }
            } else {
                // currentAudioê°€ ì—†ëŠ” ê²½ìš° í˜„ì¬ ê°¤ëŸ¬ë¦¬ì˜ ìŒì•…ì„ ì¬ìƒ
                if (currentGalleryInfo && currentGalleryInfo.musicId && currentGalleryInfo.audioSrc) {
                    // ê°¤ëŸ¬ë¦¬ì— í‘œì‹œëœ ìŒì›ì´ ìˆëŠ” ê²½ìš°, í•´ë‹¹ ìŒì› ì¬ìƒ
                    console.log('ê°¤ëŸ¬ë¦¬ í”Œë ˆì´ ë²„íŠ¼: ê°¤ëŸ¬ë¦¬ ìŒì› ì¬ìƒ', currentGalleryInfo);

                    // ê¸°ì¡´ì— ì¬ìƒ ì¤‘ì¸ ë‹¤ë¥¸ ìŒì›ì´ ìˆìœ¼ë©´ ì¤‘ì§€
                    if (currentAudio && !currentAudio.paused) {
                        currentAudio.pause();
                        console.log('ê¸°ì¡´ ìŒì› ì¤‘ì§€');
                    }

                    togglePlay(currentGalleryInfo.musicId, currentGalleryInfo.audioSrc, currentGalleryInfo.images);
                } else {
                    // ê°¤ëŸ¬ë¦¬ ì •ë³´ê°€ ì—†ëŠ” ê²½ìš° ê¸°ì¡´ ë°©ì‹ìœ¼ë¡œ í´ë°±
                    const musicList = isShowingLiked ? mySavedMusic : mySunoMusic;
                    if (musicList.length > 0) {
                        const targetIndex = (currentMusicIndex >= 0 && currentMusicIndex < musicList.length) ? currentMusicIndex : 0;
                        const targetMusic = musicList[targetIndex];
                        const musicId = targetMusic.musicId || targetMusic.id;
                        const audioSrc = targetMusic.audioSrc;
                        const images = targetMusic.images;

                        if (musicId && audioSrc && images) {
                            console.log('ê°¤ëŸ¬ë¦¬ í”Œë ˆì´ ë²„íŠ¼: í´ë°±ìœ¼ë¡œ ìŒì•… ì¬ìƒ', { targetIndex, musicId });
                            togglePlay(musicId, audioSrc, images);
                        }
                    }
                }
            }
        }

        // 'ì¢‹ì•„ìš” ë³´ê¸°' ë²„íŠ¼ ìƒíƒœë¥¼ í† ê¸€í•˜ëŠ” í•¨ìˆ˜
        function toggleLikedView() {
            if (isFullViewMode) {
                isFullViewMode = false;
                updateButtonStyles();
            }

            // ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ í•´ì œ
            if (isShowingLiked) {
                isShowingLiked = false;
                loadMusicDataFromServer();
                updateCategoryTabsActive();
            } else {
                // í™œì„±í™”
                isShowingLiked = true;
                // ì¶”ì²œ ëª¨ë“œ í•´ì œ
                if (isShowingRecommended) {
                    isShowingRecommended = false;
                }
                // ì €ì¥ ëª©ë¡ ëª¨ë“œ í•´ì œ
                if (isShowingSaved) {
                    isShowingSaved = false;
                }
                loadSavedMusic();
                // ì¢‹ì•„ìš” ë³´ê¸°ì¼ ë•Œ ì¹´í…Œê³ ë¦¬ íƒ­ë“¤ì˜ active í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('.category-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
            }
            updateButtonStyles();
        }

        // ì¢‹ì•„ìš” ëª©ë¡ ë¡œë“œ í›„ ì²« ë²ˆì§¸ ê³¡ ì¬ìƒ ë° ê°¤ëŸ¬ë¦¬ í‘œì‹œ
        function startPlayingLikedMusic() {
            if (mySavedMusic && mySavedMusic.length > 0) {
                const firstMusic = mySavedMusic[0];
                if (firstMusic && firstMusic.images && firstMusic.images.length > 0) {
                    currentMusicIndex = 0;
                    const musicId = firstMusic.musicId || firstMusic.id;
                    const audioSrc = firstMusic.audioSrc;
                    const images = firstMusic.images;

                    if (musicId && audioSrc && images) {
                        console.log('ì¢‹ì•„ìš” ëª©ë¡ ì²« ë²ˆì§¸ ê³¡ ì¬ìƒ:', firstMusic.name);

                        // ê¸°ì¡´ ì˜¤ë””ì˜¤ ì¤‘ì§€
                        if (currentAudio) {
                            currentAudio.pause();
                        }

                        // ìƒˆ ì˜¤ë””ì˜¤ ìƒì„± ë° ì¬ìƒ
                        currentAudio = new Audio(audioSrc);
                        currentAudio.id = `audio-${musicId}`;

                        // ì˜¤ë””ì˜¤ ì—ëŸ¬ ì²˜ë¦¬
                        currentAudio.addEventListener('error', (e) => {
                            console.error('ì˜¤ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜:', e);
                        });

                        currentAudio.play().catch(error => {
                            console.warn('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜ (ë¬´ì‹œí•˜ê³  ê³„ì†):', error);
                        });
                        currentAudio.addEventListener('ended', playNextMusic);

                        // ê°¤ëŸ¬ë¦¬ í‘œì‹œ
                        showGallery(musicId, images);

                        // ì¬ìƒ ë²„íŠ¼ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
                        const button = document.querySelector(`.music-card[data-music-id="${musicId}"] .play-button`);
                        if (button) {
                            button.innerHTML = `
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                </svg>
                            `;
                        }

                        // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œ ì „í™˜
                        const isMobile = window.innerWidth <= 768;
                        const isPortrait = window.innerHeight > window.innerWidth;
                        if (isMobile && isPortrait && !isMobilePortraitMode) {
                            enableMobilePortraitMode();
                        }
                    }
                }
            }
        }

        // 'ëª©ë¡ ë³´ê¸°' ë²„íŠ¼ (ğŸ“‹) - ì €ì¥ëœ ìŒì•… ëª©ë¡ í† ê¸€
        function toggleListView() {
            if (isFullViewMode) {
                isFullViewMode = false;
                updateButtonStyles();
            }

            // ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ í•´ì œ
            if (isShowingSaved) {
                isShowingSaved = false;
                loadMusicDataFromServer();
                updateCategoryTabsActive();
            } else {
                // í™œì„±í™”
                isShowingSaved = true;
                // ì¢‹ì•„ìš” ëª¨ë“œ í•´ì œ
                if (isShowingLiked) {
                    isShowingLiked = false;
                }
                // ì¶”ì²œ ëª¨ë“œ í•´ì œ
                if (isShowingRecommended) {
                    isShowingRecommended = false;
                }
                loadSavedMusicList();
                // ì €ì¥ ëª©ë¡ ë³´ê¸°ì¼ ë•Œ ì¹´í…Œê³ ë¦¬ íƒ­ë“¤ì˜ active í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('.category-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
            }
            updateButtonStyles();
        }

        // ì €ì¥ ëª©ë¡ ë¡œë“œ í›„ ì²« ë²ˆì§¸ ê³¡ ì¬ìƒ ë° ê°¤ëŸ¬ë¦¬ í‘œì‹œ
        function startPlayingSavedMusic() {
            if (mySavedMusic && mySavedMusic.length > 0) {
                const firstMusic = mySavedMusic[0];
                if (firstMusic && firstMusic.images && firstMusic.images.length > 0) {
                    currentMusicIndex = 0;
                    const musicId = firstMusic.musicId || firstMusic.id;
                    const audioSrc = firstMusic.audioSrc;
                    const images = firstMusic.images;

                    if (musicId && audioSrc && images) {
                        console.log('ì €ì¥ ëª©ë¡ ì²« ë²ˆì§¸ ê³¡ ì¬ìƒ:', firstMusic.name);

                        // ê¸°ì¡´ ì˜¤ë””ì˜¤ ì¤‘ì§€
                        if (currentAudio) {
                            currentAudio.pause();
                        }

                        // ìƒˆ ì˜¤ë””ì˜¤ ìƒì„± ë° ì¬ìƒ
                        currentAudio = new Audio(audioSrc);
                        currentAudio.id = `audio-${musicId}`;

                        // ì˜¤ë””ì˜¤ ì—ëŸ¬ ì²˜ë¦¬
                        currentAudio.addEventListener('error', (e) => {
                            console.error('ì˜¤ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜:', e);
                        });

                        currentAudio.play().catch(error => {
                            console.warn('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜ (ë¬´ì‹œí•˜ê³  ê³„ì†):', error);
                        });
                        currentAudio.addEventListener('ended', playNextMusic);

                        // ê°¤ëŸ¬ë¦¬ í‘œì‹œ
                        showGallery(musicId, images);

                        // ì¬ìƒ ë²„íŠ¼ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸
                        const button = document.querySelector(`.music-card[data-music-id="${musicId}"] .play-button`);
                        if (button) {
                            button.innerHTML = `
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                    <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                                </svg>
                            `;
                        }

                        // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œ ì „í™˜
                        const isMobile = window.innerWidth <= 768;
                        const isPortrait = window.innerHeight > window.innerWidth;
                        if (isMobile && isPortrait && !isMobilePortraitMode) {
                            enableMobilePortraitMode();
                        }
                    }
                }
            }
        }

        // Firestoreì—ì„œ ì €ì¥ëœ ìŒì•… ëª©ë¡ ë¡œë“œ
        async function loadSavedMusicFromFirestore() {
            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    mySavedMusic = [];
                    return;
                }

                // Firestoreì—ì„œ ì €ì¥ëœ ìŒì•… ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const savedMusicRef = window.firebaseCollection(window.firebaseDb, 'savedMusic');
                const querySnapshot = await window.firebaseGetDocs(
                    window.firebaseQuery(savedMusicRef,
                        window.firebaseWhere('userId', '==', user.uid)
                    )
                );

                const savedMusicData = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    savedMusicData.push({
                        musicId: data.musicId,
                        createdAt: data.createdAt
                    });
                });

                // createdAtìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
                savedMusicData.sort((a, b) => {
                    const dateA = new Date(a.createdAt || 0);
                    const dateB = new Date(b.createdAt || 0);
                    return dateB - dateA;
                });

                const savedMusicIds = savedMusicData.map(item => item.musicId);

                // ì „ì²´ ìŒì•… ëª©ë¡ì—ì„œ ì €ì¥ëœ ìŒì•…ë§Œ í•„í„°ë§ (ì •ë ¬ ìˆœì„œ ìœ ì§€)
                mySavedMusic = savedMusicIds
                    .map(id => allMusicData.find(music => music.id === id || music.musicId === id))
                    .filter(music => music !== undefined);

                console.log('Firestoreì—ì„œ ì €ì¥ ëª©ë¡ ë¡œë“œ ì™„ë£Œ:', mySavedMusic.length);
                updateMusicListUI(mySavedMusic, false);

                // ì €ì¥ ëª©ë¡ ë¡œë“œ ì‹œ ìë™ ì¬ìƒ ë¹„í™œì„±í™”
                // setTimeout(() => {
                //     startPlayingSavedMusic();
                // }, 100);
            } catch (error) {
                console.error("Firestore ì €ì¥ ëª©ë¡ ë¡œë“œ ì˜¤ë¥˜:", error);
                mySavedMusic = [];
                updateMusicListUI([], false);
            }
        }

        // ì €ì¥ëœ ìŒì•… ëª©ë¡ ë¡œë“œ (ìŒì•… ë‹¨ìœ„) - ì´ì „ API ë²„ì „ ìœ ì§€ (í˜¸í™˜ì„±)
        function loadSavedMusicList() {
            loadSavedMusicFromFirestore();
        }

        // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ í† ê¸€
        function toggleUserInfo() {
            if (isFullViewMode) {
                isFullViewMode = false;
                updateButtonStyles();
            }

            // ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ í•´ì œ
            if (isShowingUserInfo) {
                isShowingUserInfo = false;
                loadMusicDataFromServer();
                updateCategoryTabsActive();
            } else {
                // í™œì„±í™”
                isShowingUserInfo = true;
                // ë‹¤ë¥¸ ëª¨ë“œ í•´ì œ
                if (isShowingLiked) isShowingLiked = false;
                if (isShowingRecommended) isShowingRecommended = false;
                if (isShowingSaved) isShowingSaved = false;

                loadUserInfo();
                // ì¹´í…Œê³ ë¦¬ íƒ­ë“¤ì˜ active í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('.category-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
            }
            updateButtonStyles();
        }

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ë° í‘œì‹œ
        async function loadUserInfo() {
            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                // Firestoreì—ì„œ ì‚¬ìš©ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const userDocRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                const userDoc = await window.firebaseGetDoc(userDocRef);

                if (!userDoc.exists()) {
                    alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const userData = userDoc.data();

                // ì‚¬ìš©ì ì •ë³´ ê°ì²´ ìƒì„±
                const userInfo = {
                    email: userData.email || user.email,
                    joinDate: userData.createdAt || new Date().toISOString(),
                    dailyPoints: userData.dailyPoints || 0,
                    walletPoints: userData.walletBalance || 0,
                    likeCount: 0,  // ì¶”í›„ êµ¬í˜„
                    savedCount: 0  // ì¶”í›„ êµ¬í˜„
                };

                displayUserInfo(userInfo);
            } catch (error) {
                console.error("ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:", error);
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‚¬ìš©ì ì •ë³´ UI í‘œì‹œ
        function displayUserInfo(userInfo) {
            const musicPlayerContainer = document.getElementById('music-player-container');

            // ê°€ì…ì¼ì í¬ë§·íŒ…
            const joinDate = new Date(userInfo.joinDate);
            const formattedDate = joinDate.toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            musicPlayerContainer.innerHTML = `
                <div style="padding: 30px; text-align: center; max-width: 600px; margin: 0 auto;">
                    <h2 style="margin-bottom: 30px; color: #333;">My Page</h2>
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 25px; color: white; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1);">
                        <div style="font-size: 18px; margin-bottom: 10px;">ğŸ“§ ${userInfo.email}</div>
                        <div style="font-size: 14px; opacity: 0.9;">ê°€ì…ì¼: ${formattedDate}</div>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 20px;">
                        <div id="like-count-card" style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            <div style="font-size: 32px; margin-bottom: 10px;">â¤ï¸</div>
                            <div style="font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 5px;">${userInfo.likeCount}</div>
                            <div style="font-size: 14px; color: #666;">ì¢‹ì•„ìš”</div>
                        </div>

                        <div id="saved-count-card" style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            <div style="font-size: 32px; margin-bottom: 10px;">ğŸ“‹</div>
                            <div style="font-size: 24px; font-weight: bold; color: #667eea; margin-bottom: 5px;">${userInfo.savedCount}</div>
                            <div style="font-size: 14px; color: #666;">ì €ì¥ ëª©ë¡</div>
                        </div>

                        <div style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            <div style="font-size: 32px; margin-bottom: 10px;">âš¡</div>
                            <div style="font-size: 24px; font-weight: bold; color: #f39c12; margin-bottom: 5px;">${userInfo.dailyPoints}P</div>
                            <div style="font-size: 14px; color: #666;">ì¼ì¼ í¬ì¸íŠ¸</div>
                        </div>

                        <div id="wallet-points-card" style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                            <div style="font-size: 32px; margin-bottom: 10px;">ğŸ’</div>
                            <div style="font-size: 24px; font-weight: bold; color: #27ae60; margin-bottom: 5px;">${userInfo.walletPoints}P</div>
                            <div style="font-size: 14px; color: #666;">ì§€ê°‘ í¬ì¸íŠ¸</div>
                        </div>
                    </div>

                    <div id="purchase-history-list" style="display: none; background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 20px; text-align: left;">
                        <h3 style="margin-bottom: 15px; color: #333; text-align: center;">êµ¬ë§¤ì´ë ¥</h3>
                        <div id="history-content" style="max-height: 300px; overflow-y: auto;">
                            <div style="text-align: center; padding: 20px; color: #999;">ë¡œë”© ì¤‘...</div>
                        </div>
                    </div>

                    <div style="background: #fff; border-radius: 12px; padding: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.08); margin-bottom: 20px;">
                        <h3 style="margin-bottom: 15px; color: #333;">âš™ï¸ ì„¤ì •</h3>
                        <div style="display: flex; gap: 10px; align-items: center; justify-content: center; margin-bottom: 10px;">
                            <span style="font-size: 14px; color: #666;">ìë™ ì¬ìƒ ì‹œê°„:</span>
                            <input type="number" id="user-autoplay-timing-input" value="3" min="1" max="99" style="width: 50px; padding: 5px; border: 1px solid #ddd; border-radius: 5px; text-align: center;">
                            <span style="font-size: 14px; color: #666;">ì´ˆ</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                        <button onclick="toggleUserInfo()" style="background: #667eea; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; cursor: pointer;">
                            ëŒì•„ê°€ê¸°
                        </button>
                        <button onclick="handleLogout()" style="background: #e74c3c; color: white; border: none; padding: 12px 30px; border-radius: 8px; font-size: 16px; cursor: pointer;">
                            ë¡œê·¸ì•„ì›ƒ
                        </button>
                    </div>
                </div>
            `;

            // ì¢‹ì•„ìš” ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            const likeCountCard = document.getElementById('like-count-card');
            if (likeCountCard) {
                likeCountCard.addEventListener('click', () => {
                    // ì‚¬ìš©ì ì •ë³´ ëª¨ë“œ í•´ì œí•˜ê³  ì¢‹ì•„ìš” ëª©ë¡ìœ¼ë¡œ ì´ë™
                    isShowingUserInfo = false;
                    if (!isShowingLiked) {
                        toggleLikedView();
                    } else {
                        loadMusicDataFromServer();
                        updateCategoryTabsActive();
                        updateButtonStyles();
                    }
                });
            }

            // ì €ì¥ ëª©ë¡ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
            const savedCountCard = document.getElementById('saved-count-card');
            if (savedCountCard) {
                savedCountCard.addEventListener('click', () => {
                    // ì‚¬ìš©ì ì •ë³´ ëª¨ë“œ í•´ì œí•˜ê³  ì €ì¥ ëª©ë¡ìœ¼ë¡œ ì´ë™
                    isShowingUserInfo = false;
                    if (!isShowingSaved) {
                        toggleListView();
                    } else {
                        loadMusicDataFromServer();
                        updateCategoryTabsActive();
                        updateButtonStyles();
                    }
                });
            }

            // ì§€ê°‘ í¬ì¸íŠ¸ ì¹´ë“œ í´ë¦­ ì´ë²¤íŠ¸ëŠ” ì œê±° (ì •ë³´ í‘œì‹œë§Œ í•¨)

            // ìë™ ì¬ìƒ ì‹œê°„ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ì¶”ê°€
            const userAutoplayInput = document.getElementById('user-autoplay-timing-input');
            if (userAutoplayInput) {
                // í˜„ì¬ ì„¤ì •ëœ ê°’ìœ¼ë¡œ ì´ˆê¸°í™”
                userAutoplayInput.value = currentAutoplayTiming / 1000;

                userAutoplayInput.addEventListener('change', (e) => {
                    let value = parseInt(e.target.value);
                    if (value < 1) value = 1;
                    if (value > 99) value = 99;
                    currentAutoplayTiming = value * 1000;
                    e.target.value = value;
                    console.log('ìë™ ì¬ìƒ ì‹œê°„ ë³€ê²½:', value, 'ì´ˆ');
                });
            }
        }

        // êµ¬ë§¤ì´ë ¥ í† ê¸€ í•¨ìˆ˜
        function togglePurchaseHistory() {
            const historyList = document.getElementById('purchase-history-list');
            if (!historyList) return;

            if (historyList.style.display === 'none') {
                historyList.style.display = 'block';
                loadPurchaseHistory();
            } else {
                historyList.style.display = 'none';
            }
        }

        // êµ¬ë§¤ì´ë ¥ ë¡œë“œ í•¨ìˆ˜
        function loadPurchaseHistory() {
            const historyContent = document.getElementById('history-content');
            if (!historyContent) return;

            fetch('api.php', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ action: 'getPurchaseHistory' })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.transactions && data.transactions.length > 0) {
                    let html = '';
                    data.transactions.forEach(transaction => {
                        const date = new Date(transaction.created_at);
                        const formattedDate = date.toLocaleDateString('ko-KR', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });

                        const amountColor = transaction.amount > 0 ? '#27ae60' : '#e74c3c';
                        const amountSign = transaction.amount > 0 ? '+' : '';

                        html += `
                            <div style="border-bottom: 1px solid #eee; padding: 12px 0; display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 14px; color: #333; margin-bottom: 4px;">${transaction.description}</div>
                                    <div style="font-size: 12px; color: #999;">${formattedDate}</div>
                                </div>
                                <div style="font-size: 18px; font-weight: bold; color: ${amountColor};">
                                    ${amountSign}${transaction.amount}P
                                </div>
                            </div>
                        `;
                    });
                    historyContent.innerHTML = html;
                } else {
                    historyContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #999;">êµ¬ë§¤ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
                }
            })
            .catch(error => {
                console.error('êµ¬ë§¤ì´ë ¥ ë¡œë“œ ì˜¤ë¥˜:', error);
                historyContent.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">êµ¬ë§¤ì´ë ¥ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>';
            });
        }

        // 'ì¶”ì²œ ê°¤ëŸ¬ë¦¬' ë²„íŠ¼ (â­)
        function toggleRecommendedView() {
            if (isFullViewMode) {
                isFullViewMode = false;
                updateButtonStyles();
            }

            // ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ í•´ì œ
            if (isShowingRecommended) {
                isShowingRecommended = false;
                loadMusicDataFromServer();
                updateCategoryTabsActive();
            } else {
                // í™œì„±í™”
                isShowingRecommended = true;
                // ì¢‹ì•„ìš” ëª¨ë“œ í•´ì œ
                if (isShowingLiked) {
                    isShowingLiked = false;
                }
                // ì €ì¥ ëª©ë¡ ëª¨ë“œ í•´ì œ
                if (isShowingSaved) {
                    isShowingSaved = false;
                }
                loadRecommendedMusic();
                // ì¶”ì²œ ë³´ê¸°ì¼ ë•Œ ì¹´í…Œê³ ë¦¬ íƒ­ë“¤ì˜ active í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('.category-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
            }
            updateButtonStyles();
        }

        // ì¶”ì²œ ëª©ë¡ ë¡œë“œ í›„ ì²« ë²ˆì§¸ ê³¡ ì¬ìƒ
        function startPlayingRecommendedMusic() {
            if (mySunoMusic && mySunoMusic.length > 0) {
                const firstMusic = mySunoMusic[0];
                if (firstMusic && firstMusic.images && firstMusic.images.length > 0) {
                    currentMusicIndex = 0;
                    const musicId = firstMusic.musicId || firstMusic.id;
                    const audioSrc = firstMusic.audioSrc;
                    const images = firstMusic.images;

                    if (musicId && audioSrc && images) {
                        console.log('ì¶”ì²œ ëª©ë¡ ì²« ë²ˆì§¸ ê³¡ ì¬ìƒ:', firstMusic.name);
                        togglePlay(musicId, audioSrc, images);
                    }
                }
            }
        }

        // ì¶”ì²œ ê°¤ëŸ¬ë¦¬ ëª©ë¡ ë¡œë“œ
        async function loadRecommendedMusic() {
            try {
                // Firestoreì—ì„œ ì¶”ì²œ ìŒì•…ë§Œ ê°€ì ¸ì˜¤ê¸°
                const musicCollection = window.firebaseCollection(window.firebaseDb, 'music');
                const recommendedQuery = window.firebaseQuery(
                    musicCollection,
                    window.firebaseWhere('isRecommended', '==', 1),
                    window.firebaseOrderBy('uploadedAt', 'desc')
                );

                const querySnapshot = await window.firebaseGetDocs(recommendedQuery);
                const musicList = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();

                    // ì‚­ì œëœ ìŒì•…ì€ ì œì™¸
                    if (data.deleted) return;

                    musicList.push({
                        id: doc.id,
                        musicId: doc.id,
                        name: data.name,
                        audioSrc: data.audioSrc,
                        category: data.category,
                        isRecommended: data.isRecommended || 0,
                        images: data.images.map((img, idx) => {
                            const randomLikes = Math.floor(Math.random() * 101) + 100; // 100~200 ì‚¬ì´ì˜ ëœë¤ê°’
                            return {
                                id: `${doc.id}_${idx}`,
                                imageSrc: img.imageSrc,
                                order: img.order || idx,
                                isLiked: 0,
                                likeCount: randomLikes,
                                defaultLikes: randomLikes,
                                serverLikeCount: 0
                            };
                        })
                    });
                });

                mySunoMusic = musicList;
                totalItems = mySunoMusic.length;
                totalPages = Math.ceil(totalItems / itemsPerPage);
                currentPage = 1;
                updateMusicListUI(mySunoMusic, false);

                // ì²« ë²ˆì§¸ ì¶”ì²œ ê°¤ëŸ¬ë¦¬ ìë™ ì˜¤í”ˆ
                if (mySunoMusic.length > 0 && mySunoMusic[0].images && mySunoMusic[0].images.length > 0) {
                    showGallery(mySunoMusic[0].musicId || mySunoMusic[0].id, mySunoMusic[0].images);
                }

                // ì¶”ì²œ ëª©ë¡ ë¡œë“œ ì‹œ ìë™ ì¬ìƒ ë¹„í™œì„±í™”
                // setTimeout(() => {
                //     startPlayingRecommendedMusic();
                // }, 100);
            } catch (error) {
                console.error('ì¶”ì²œ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì¶”ì²œ ê°¤ëŸ¬ë¦¬ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì „ì²´í™”ë©´ ì•Œë¦¼ ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function showFullscreenNotification() {
            // ê¸°ì¡´ ì•Œë¦¼ì´ ìˆìœ¼ë©´ ì œê±°
            const existingNotification = document.querySelector('.fullscreen-notification');
            if (existingNotification) {
                existingNotification.remove();
            }

            // ìƒˆ ì•Œë¦¼ ë©”ì‹œì§€ ìƒì„±
            const notification = document.createElement('div');
            notification.className = 'fullscreen-notification';
            notification.textContent = 'F11 : Full Window Mode / ESC : Full View Exit';
            document.body.appendChild(notification);

            // ì• ë‹ˆë©”ì´ì…˜ìœ¼ë¡œ í‘œì‹œ
            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            // 3ì´ˆ í›„ í˜ì´ë“œì•„ì›ƒ ë° ì œê±°
            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // ì „ì²´ í™”ë©´ ë³´ê¸° ëª¨ë“œë¥¼ í† ê¸€í•˜ëŠ” í•¨ìˆ˜
        function toggleFullView() {
            const body = document.body;
            const toggleButton = document.getElementById('toggle-full-view');

            // ì „ì²´ í™”ë©´ ëª¨ë“œ ë³€ìˆ˜ í† ê¸€
            isFullViewMode = !isFullViewMode;

            // bodyì™€ ë²„íŠ¼ì— CSS í´ë˜ìŠ¤ ì¶”ê°€/ì œê±°
            body.classList.toggle('full-view-active', isFullViewMode);
            body.classList.toggle('full-view-mode', isFullViewMode);
            if (toggleButton) {
                toggleButton.classList.toggle('toggled-on', isFullViewMode);
            }

            // ì „ì²´í™”ë©´ ëª¨ë“œë¡œ ì „í™˜í•  ë•Œ ì•Œë¦¼ ë©”ì‹œì§€ í‘œì‹œ
            if (isFullViewMode) {
                showFullscreenNotification();
            }

            // ì¢‹ì•„ìš” ë³´ê¸° ëª¨ë“œê°€ í™œì„±í™”ë˜ì–´ ìˆë‹¤ë©´ í•´ì œ
            if (isShowingLiked) {
                isShowingLiked = false;
                updateButtonStyles();
            }
        }

        // ìë™ì „í™˜ ì†ë„ ì„¤ì • í•¨ìˆ˜ (êµ¬ë²„ì „ í˜¸í™˜ìš©)
        function setAutoplaySpeed(seconds) {
            // ì†ë„ ì„¤ì •
            currentAutoplayTiming = seconds * 1000;

            // ë²„íŠ¼ í™œì„±í™” ìƒíƒœ ì—…ë°ì´íŠ¸
            document.querySelectorAll('.speed-button').forEach(btn => {
                btn.classList.remove('active');
            });
            const activeButton = document.getElementById(`speed-${seconds}`);
            if (activeButton) {
                activeButton.classList.add('active');
            }

            // í˜„ì¬ ìë™ ì „í™˜ ì¤‘ì´ë¼ë©´ ì¬ì‹œì‘
            if (isAutoTransitioning && currentImageInterval) {
                clearInterval(currentImageInterval);
                currentImageInterval = setInterval(() => {
                    const items = document.querySelectorAll('#image-gallery .gallery-item');
                    if (items.length > 1 && isAutoTransitioning) {
                        items[currentImageIndex].classList.remove('active');
                        currentImageIndex = (currentImageIndex + 1) % items.length;
                        items[currentImageIndex].classList.add('active');
                        updateImageOrderDisplay();
                    }
                }, currentAutoplayTiming);
            }

            // ë©”ì‹œì§€ í‘œì‹œ
            showGalleryMessage(`ìë™ì „í™˜ ì†ë„: ${seconds}ì´ˆ`);
        }

        // ìŠ¬ë¼ì´ë“œ íƒ€ì´ë¨¸ í† ê¸€ í•¨ìˆ˜ (3ì´ˆ â†’ 5ì´ˆ â†’ 10ì´ˆ ìˆœí™˜)
        function toggleSlideSpeed() {
            const timerButton = document.getElementById('slide-timer-button');
            if (!timerButton) return;

            const currentSeconds = parseInt(timerButton.getAttribute('data-seconds') || '3');
            let nextSeconds;

            // 3ì´ˆ â†’ 5ì´ˆ â†’ 10ì´ˆ â†’ 3ì´ˆ ìˆœí™˜
            if (currentSeconds === 3) {
                nextSeconds = 5;
            } else if (currentSeconds === 5) {
                nextSeconds = 10;
            } else {
                nextSeconds = 3;
            }

            // ì†ë„ ì„¤ì •
            currentAutoplayTiming = nextSeconds * 1000;
            timerButton.setAttribute('data-seconds', nextSeconds);

            // í˜„ì¬ ìë™ ì „í™˜ ì¤‘ì´ë¼ë©´ ì¬ì‹œì‘
            if (isAutoTransitioning && currentImageInterval) {
                clearInterval(currentImageInterval);
                currentImageInterval = setInterval(() => {
                    const items = document.querySelectorAll('#image-gallery .gallery-item');
                    if (items.length > 1 && isAutoTransitioning) {
                        items[currentImageIndex].classList.remove('active');
                        currentImageIndex = (currentImageIndex + 1) % items.length;
                        items[currentImageIndex].classList.add('active');
                        updateImageOrderDisplay();
                    }
                }, currentAutoplayTiming);
            }

            // ë©”ì‹œì§€ í‘œì‹œ
            showGalleryMessage(`ìŠ¬ë¼ì´ë“œ ìë™ì „í™˜: ${nextSeconds}ì´ˆ`);
        }

        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ì„ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function updateButtonStyles() {
            const fullViewButton = document.getElementById('full-view-button');

            // ìƒë‹¨ ë²„íŠ¼ë“¤
            const listViewButtonTop = document.getElementById('list-view-button-top');
            const likedListButtonTop = document.getElementById('liked-list-button-top');
            const recommendedButtonTop = document.getElementById('recommended-list-button-top');

            // ëª©ë¡ ë³´ê¸° ë²„íŠ¼ (ğŸ“‹) - ì €ì¥ëœ ëª©ë¡ í‘œì‹œ
            if (listViewButtonTop) {
                if (isShowingSaved) {
                    listViewButtonTop.classList.add('active');
                } else {
                    listViewButtonTop.classList.remove('active');
                }
            }

            // ì¢‹ì•„ìš” ëª©ë¡ ë²„íŠ¼ (â¤ï¸)
            if (likedListButtonTop) {
                if (isShowingLiked) {
                    likedListButtonTop.classList.add('active');
                } else {
                    likedListButtonTop.classList.remove('active');
                }
            }

            // ì¶”ì²œ ê°¤ëŸ¬ë¦¬ ë²„íŠ¼ (â­)
            if (recommendedButtonTop) {
                if (isShowingRecommended) {
                    recommendedButtonTop.classList.add('active');
                } else {
                    recommendedButtonTop.classList.remove('active');
                }
            }

            if (fullViewButton) {
                if (isFullViewMode) {
                    fullViewButton.classList.add('active');
                    fullViewButton.innerHTML = 'ğŸ”™';
                } else {
                    fullViewButton.classList.remove('active');
                    fullViewButton.innerHTML = 'â›¶';
                }
            }
        }

        // ìƒˆë¡œìš´ í•¨ìˆ˜: í˜„ì¬ ì„ íƒëœ ì¹´í…Œê³ ë¦¬ íƒ­ì„ í™œì„±í™” ìƒíƒœë¡œ ì—…ë°ì´íŠ¸
        function updateCategoryTabsActive() {
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('active');
                if (tab.textContent === currentCategory) {
                    tab.classList.add('active');
                }
            });
        }        

        // ê°¤ëŸ¬ë¦¬ ì˜ì—­ì„ ë³´ì´ê²Œ í•˜ê³  ìŠ¤í¬ë¡¤ë¡œ í¬ì»¤ì‹±
        function focusGallery() {
            const wrapper = document.getElementById('gallery-wrapper');
            if (!wrapper) return;
            wrapper.style.display = 'flex';
            wrapper.classList.add('active');

            // ëª¨ë°”ì¼ ë°˜ì‘í˜• ì²´í¬
            checkMobileOrientation();

            // showGallery()ê°€ DOMì„ ê·¸ë¦° ë’¤ ë¶€ë“œëŸ½ê²Œ ìŠ¤í¬ë¡¤
            requestAnimationFrame(() => {
                if (!isMobilePortraitMode) {
                    wrapper.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
        }

        async function loadMusicDataFromServer() {
            try {
                // Firestoreì—ì„œ ìŒì•… ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const musicCollection = window.firebaseCollection(window.firebaseDb, 'music');
                let musicQuery;

                // ëª¨ë“  ìŒì•… ê°€ì ¸ì˜¤ê¸° (ì¸ë±ìŠ¤ ì—†ì´ë„ ì‘ë™)
                musicQuery = window.firebaseQuery(
                    musicCollection
                );

                const querySnapshot = await window.firebaseGetDocs(musicQuery);
                const musicList = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();

                    // ì‚­ì œëœ ìŒì•…ì€ ì œì™¸
                    if (data.deleted) return;

                    musicList.push({
                        id: doc.id,
                        musicId: doc.id,
                        name: data.name,
                        audioSrc: data.audioSrc,
                        category: data.category,
                        uploadedAt: data.uploadedAt, // ì •ë ¬ì„ ìœ„í•´ ì¶”ê°€
                        isRecommended: data.isRecommended || 0,
                        images: data.images.map((img, idx) => {
                            const randomLikes = Math.floor(Math.random() * 101) + 100; // 100~200 ì‚¬ì´ì˜ ëœë¤ê°’
                            return {
                                id: img.id || `${doc.id}_${idx}`, // Firestoreì— ì €ì¥ëœ ID ìš°ì„  ì‚¬ìš©
                                imageSrc: img.imageSrc,
                                order: img.order || idx,
                                isLiked: 0,
                                likeCount: randomLikes,
                                defaultLikes: randomLikes,
                                serverLikeCount: 0
                            };
                        })
                    });
                });

                // í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ í•„í„°ë§ ë° ì •ë ¬
                let filteredMusicList = musicList;

                // topSectionì— í•´ë‹¹í•˜ëŠ” ì¹´í…Œê³ ë¦¬ ëª©ë¡ êµ¬í•˜ê¸°
                const filteredCategoryDetails = allCategoryDetails.filter(cat =>
                    cat.topSection === currentTopSection
                );
                const topSectionCategories = filteredCategoryDetails.map(cat => cat.name);

                // 1. topSectionì— ì†í•˜ëŠ” ìŒì•…ë§Œ ë¨¼ì € í•„í„°ë§
                if (!isShowingLiked) {
                    filteredMusicList = musicList.filter(music => topSectionCategories.includes(music.category));
                }

                // 2. íŠ¹ì • ì¹´í…Œê³ ë¦¬ í•„í„°ë§
                if (!isShowingLiked && currentCategory && currentCategory !== 'all') {
                    filteredMusicList = filteredMusicList.filter(music => music.category === currentCategory);
                }

                // uploadedAtìœ¼ë¡œ ì •ë ¬ (ìµœì‹ ìˆœ)
                filteredMusicList.sort((a, b) => {
                    // uploadedAtì´ ì—†ëŠ” ê²½ìš°ë¥¼ ëŒ€ë¹„
                    const dateA = a.uploadedAt || new Date(0);
                    const dateB = b.uploadedAt || new Date(0);
                    return new Date(dateB) - new Date(dateA);
                });

                // ì‚¬ìš©ìê°€ ë¡œê·¸ì¸í•œ ê²½ìš° ì¢‹ì•„ìš” ì •ë³´ ë³‘í•©
                const user = window.firebaseAuth.currentUser;
                if (user) {
                    try {
                        const userLikesRef = window.firebaseDoc(window.firebaseDb, 'userLikes', user.uid);
                        const userLikesDoc = await window.firebaseGetDoc(userLikesRef);

                        if (userLikesDoc.exists()) {
                            const likedImages = userLikesDoc.data().images || [];
                            const likedImageIds = new Set(likedImages.map(img => img.id));

                            filteredMusicList.forEach(music => {
                                music.images.forEach(image => {
                                    if (likedImageIds.has(image.id)) {
                                        image.isLiked = 1;
                                    }
                                });
                            });
                        }
                    } catch (userLikesError) {
                        console.warn('ì¢‹ì•„ìš” ì •ë³´ ë¡œë“œ ì‹¤íŒ¨ (ë¬´ì‹œí•˜ê³  ê³„ì†):', userLikesError);
                        // ì¢‹ì•„ìš” ì •ë³´ ë¡œë“œ ì‹¤íŒ¨í•´ë„ ìŒì•… ëª©ë¡ì€ í‘œì‹œ
                    }
                }

                // filteredMusicListë¥¼ mySunoMusicì— í• ë‹¹
                mySunoMusic = filteredMusicList;

                // ì „ì²´ ë°ì´í„°ë¥¼ í•­ìƒ ì €ì¥ (ì¹´í…Œê³ ë¦¬ ê°„ ì´ë™ì„ ìœ„í•´ í•„ìš”)
                if (!isShowingLiked) {
                    allMusicData = musicList; // í•„í„°ë§ë˜ì§€ ì•Šì€ ì „ì²´ ë¦¬ìŠ¤íŠ¸ ì €ì¥
                    console.log('ì „ì²´ ìŒì•… ë°ì´í„° ì €ì¥:', allMusicData.length, 'ê°œ');
                }

                totalItems = mySunoMusic.length;
                totalPages = Math.ceil(totalItems / itemsPerPage);

                // ì¹´í…Œê³ ë¦¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                // 1. Firestore categories ì»¬ë ‰ì…˜ì—ì„œ ë¡œë“œí•œ ì¹´í…Œê³ ë¦¬
                // 2. ìŒì•… ë°ì´í„°ì—ì„œ ì¶”ì¶œí•œ ì¹´í…Œê³ ë¦¬
                // ë‘ ê°€ì§€ë¥¼ í•©ì³ì„œ ì‚¬ìš© (ì¤‘ë³µ ì œê±°)
                const musicCategories = [...new Set(musicList.map(m => m.category))].filter(Boolean);
                const allCategoriesSet = new Set([...allCategories, ...musicCategories]);
                let categories = Array.from(allCategoriesSet).filter(Boolean);

                // í˜„ì¬ topSectionì— í•´ë‹¹í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë§Œ í•„í„°ë§ (ìœ„ì—ì„œ ì´ë¯¸ ê³„ì‚°í•œ ë³€ìˆ˜ ì¬ì‚¬ìš©)
                categories = categories.filter(cat => topSectionCategories.includes(cat));

                console.log('ì¹´í…Œê³ ë¦¬ ë¡œë“œ:', {
                    fromFirestore: allCategories,
                    fromMusic: musicCategories,
                    combined: categories,
                    currentTopSection: currentTopSection,
                    filteredByTopSection: categories
                });

                if (categories.length > 0) {
                    // ì¹´í…Œê³ ë¦¬ íƒ­ ë¨¼ì € ë Œë”ë§ (ìŒì•…ì´ ì—†ì–´ë„ ì¹´í…Œê³ ë¦¬ëŠ” í‘œì‹œ)
                    renderCategoryTabs(categories, filteredCategoryDetails);

                    // ì²« ë¡œë“œì´ê³  í˜„ì¬ ì¹´í…Œê³ ë¦¬ê°€ nullì´ë©´ ì ‘ê·¼ ê°€ëŠ¥í•œ ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬ë¥¼ ê¸°ë³¸ê°’ìœ¼ë¡œ ì„¤ì •
                    if (currentCategory === null) {
                        currentCategory = findAccessibleDefaultCategory(categories);
                        setTimeout(() => {
                            loadMusicDataFromServer();
                        }, 100);
                        return;
                    }
                }

                updateMusicListUI(mySunoMusic);

                // ì¹´í…Œê³ ë¦¬ ì„ íƒ í›„ ìë™ ê°¤ëŸ¬ë¦¬ ì˜¤í”ˆ ë˜ëŠ” ì•± ì‹œì‘ì‹œ ì²«ë²ˆì§¸ ì ‘ê·¼ ê°€ëŠ¥í•œ ì´ë¯¸ì§€ ìë™ ì„ íƒ
                if ((autoOpenGallery || isInitialLoad) && !isShowingLiked) {
                    let firstWithImages = findAccessibleFirstContent(mySunoMusic);

                    if (firstWithImages) {
                        showGallery(firstWithImages.musicId || firstWithImages.id, firstWithImages.images);

                        if (autoOpenGallery && firstWithImages.audioSrc) {
                            togglePlay(firstWithImages.musicId || firstWithImages.id, firstWithImages.audioSrc, firstWithImages.images || []);
                        }

                        const isMobile = window.innerWidth <= 768;
                        const isPortrait = window.innerHeight > window.innerWidth;
                        if (!isMobile || (isMobile && !isPortrait)) {
                            focusGallery();
                        }
                    }
                    autoOpenGallery = false;
                    isInitialLoad = false;
                }

            } catch (error) {
                console.error("ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
                mySunoMusic = [];
                totalItems = 0;
                totalPages = 0;
                updateMusicListUI(mySunoMusic);
            }
        }

        // ì „ì²´ ìŒì•… ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜ (Firestore)
        async function fetchAllMusicData() {
            try {
                const musicCollection = window.firebaseCollection(window.firebaseDb, 'music');
                const querySnapshot = await window.firebaseGetDocs(musicCollection);

                const musicList = [];
                querySnapshot.forEach(doc => {
                    const data = doc.data();
                    musicList.push({
                        id: doc.id,
                        name: data.name || data.title,
                        category: data.category,
                        images: data.images || [],
                        ...data
                    });
                });

                // ì „ì²´ ìŒì•… ë°ì´í„°ì—ë„ ì¢‹ì•„ìš” ì´ˆê¸°ê°’ ì„¤ì • (100~200 ì‚¬ì´ ëœë¤)
                allMusicData = musicList.map(music => {
                    if (music.images && Array.isArray(music.images)) {
                        music.images = music.images.map(image => {
                            // ì´ë¯¸ì§€ ID ê¸°ë°˜ìœ¼ë¡œ ê³ ì •ëœ default ì¢‹ì•„ìš” ìˆ˜ ìƒì„± (100-200)
                            const seed = image.id ? parseInt(image.id) : 0;
                            const defaultLikes = 100 + (seed % 101); // 100~200 ì‚¬ì´ ê³ ì •ê°’

                            // ì„œë²„ì—ì„œ ë°›ì€ ì¶”ê°€ ì¢‹ì•„ìš” ìˆ˜ (serverLikeCount)
                            // isLikedê°€ trueì¸ ê²½ìš° ìµœì†Œ 1ê°œëŠ” ìˆì–´ì•¼ í•¨
                            const serverLikes = image.serverLikeCount || (image.isLiked ? 1 : 0);

                            // ì´ ì¢‹ì•„ìš” ìˆ˜ = default + ì„œë²„ ì¢‹ì•„ìš”
                            image.likeCount = defaultLikes + serverLikes;
                            image.defaultLikes = defaultLikes; // default ê°’ ë³„ë„ ì €ì¥
                            image.serverLikeCount = serverLikes; // ì„œë²„ ì¢‹ì•„ìš” ìˆ˜ ë³„ë„ ì €ì¥

                            return image;
                        });
                    }
                    return music;
                });

                console.log('Loaded music data from Firestore:', allMusicData.length, 'items');
            } catch (error) {
                console.error("ì „ì²´ ë°ì´í„° ë¡œë“œ ì˜¤ë¥˜:", error);
            }
        }

        // ì¢‹ì•„ìš”í•œ ì´ë¯¸ì§€ë§Œ ì„œë²„ì—ì„œ ê°€ì ¸ì™€ ë Œë”ë§
        async function loadSavedMusic() {
            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    mySavedMusic = [];
                    updateMusicListUI([], false);
                    return;
                }

                // Firestoreì—ì„œ ì¢‹ì•„ìš”í•œ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
                const likedImagesRef = window.firebaseDoc(window.firebaseDb, 'userLikes', user.uid);
                const likedImagesDoc = await window.firebaseGetDoc(likedImagesRef);

                if (!likedImagesDoc.exists()) {
                    console.log('ì¢‹ì•„ìš” ë¬¸ì„œê°€ ì•„ì§ ì—†ìŠµë‹ˆë‹¤.');
                    mySavedMusic = [];
                    updateMusicListUI([], false);
                    return;
                }

                const likedImages = likedImagesDoc.data().images || [];

                // ì¢‹ì•„ìš”í•œ ì´ë¯¸ì§€ë¥¼ ìŒì•…ë³„ë¡œ ê·¸ë£¹í™”
                const musicMap = {};
                likedImages.forEach(imageData => {
                    const musicId = imageData.musicId;
                    if (!musicMap[musicId]) {
                        musicMap[musicId] = {
                            id: musicId,
                            musicId: musicId,
                            name: imageData.musicName,
                            audioSrc: imageData.audioSrc,
                            images: []
                        };
                    }

                    // ì´ë¯¸ì§€ ë°ì´í„° ì²˜ë¦¬
                    const seed = imageData.id ? parseInt(imageData.id) : 0;
                    const defaultLikes = 100 + (seed % 101);
                    const serverLikes = imageData.likeCount || 0;

                    musicMap[musicId].images.push({
                            id: imageData.id,
                            imageSrc: imageData.imageSrc,
                            likeCount: defaultLikes + serverLikes,
                            defaultLikes: defaultLikes,
                            serverLikeCount: serverLikes,
                            isLiked: 1
                        });
                    });

                mySavedMusic = Object.values(musicMap);
                updateMusicListUI(mySavedMusic, false);

                // ì¢‹ì•„ìš” ëª©ë¡ ë¡œë“œ ì‹œ ìë™ ì¬ìƒ ë¹„í™œì„±í™”
                // setTimeout(() => {
                //     startPlayingLikedMusic();
                // }, 100);
            } catch (error) {
                console.error("ì¢‹ì•„ìš” ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:", error);
                updateMusicListUI([], false);
            }
        }
        
        // ğŸ’¡ ìƒˆë¡œìš´ í•¨ìˆ˜: ì¹´í…Œê³ ë¦¬ íƒ­ì„ ë™ì ìœ¼ë¡œ ë Œë”ë§
        // ì „ì—­ ë³€ìˆ˜ë¡œ ì¹´í…Œê³ ë¦¬ ìƒì„¸ ì •ë³´ ì €ì¥
        let categoryClassificationMap = {};
        let allCategories = []; // ì „ì²´ ì¹´í…Œê³ ë¦¬ ëª©ë¡ ì €ì¥
        let allCategoryDetails = []; // ì „ì²´ ì¹´í…Œê³ ë¦¬ ìƒì„¸ ì •ë³´ ì €ì¥

        // ë¶„ë¥˜ë³„ ìƒ‰ìƒ ë§¤í•‘ í•¨ìˆ˜
        function getClassificationColor(classification) {
            const colors = {
                'ì¸ë¬¼': '#3B82F6', // íŒŒë€ìƒ‰
                'íŒ¨ì…˜': '#EC4899', // í•‘í¬ìƒ‰
                'í™”ë³´': '#10B981', // ì´ˆë¡ìƒ‰
                'ì‹œë„¤ë§ˆí‹±': '#8B5CF6'  // ë³´ë¼ìƒ‰
            };
            return colors[classification] || '#6B7280'; // ê¸°ë³¸ íšŒìƒ‰
        }

        function renderCategoryTabs(categories, categoryDetails) {
            const categoryTabsContainer = document.getElementById('category-tabs');
            categoryTabsContainer.innerHTML = '';

            console.log('Rendering categories:', categories);
            console.log('Category details:', categoryDetails);
            console.log('Current topSection:', currentTopSection);

            // âš ï¸ ì£¼ì˜: allCategoriesì™€ allCategoryDetailsëŠ” ì „ì²´ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì´ë¯€ë¡œ
            // ì—¬ê¸°ì„œ ë®ì–´ì“°ë©´ ì•ˆ ë©ë‹ˆë‹¤. loadCategoriesFromFirestore()ì—ì„œë§Œ ì„¤ì •ë©ë‹ˆë‹¤.
            // allCategories = categories || [];  // ì´ ì¤„ì„ ì œê±°!
            // allCategoryDetails = categoryDetails || [];  // ì´ ì¤„ì„ ì œê±°!

            // categoryClassificationMapë„ loadCategoriesFromFirestore()ì—ì„œ ì„¤ì •ë˜ë¯€ë¡œ
            // ì—¬ê¸°ì„œ ë‹¤ì‹œ ì„¤ì •í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.
            // if (categoryDetails && categoryDetails.length > 0) {
            //     categoryClassificationMap = {};
            //     categoryDetails.forEach(cat => {
            //         categoryClassificationMap[cat.name] = cat.classification;
            //     });
            // }

            // Adult ì¹´í…Œê³ ë¦¬ë¥¼ ë§¨ ë’¤ë¡œ ì •ë ¬
            const sortedCategories = [...categories].sort((a, b) => {
                if (a === 'Adult') return 1;
                if (b === 'Adult') return -1;
                return 0;
            });

            sortedCategories.forEach(category => {
                const tab = document.createElement('div');
                let tabClasses = `category-tab ${(currentCategory === category && !isShowingLiked) ? 'active' : ''}`;

                tab.className = tabClasses;

                // ì¹´í…Œê³ ë¦¬ì˜ ë¶„ë¥˜ ê°€ì ¸ì˜¤ê¸°
                const classification = categoryClassificationMap[category];
                const categoryColor = getClassificationColor(classification);

                tab.style.borderColor = categoryColor;
                if (currentCategory === category && !isShowingLiked) {
                    tab.style.backgroundColor = categoryColor;
                    tab.style.color = '#FFFFFF';
                } else {
                    tab.style.backgroundColor = categoryColor + '20'; // 20% íˆ¬ëª…ë„
                    tab.style.color = categoryColor;
                }

                // ê¸€ììˆ˜ 12ìë¡œ ì œí•œ
                const displayText = category.length > 12 ? category.substring(0, 12) + '...' : category;

                tab.textContent = displayText;
                tab.title = category; // ì „ì²´ í…ìŠ¤íŠ¸ë¥¼ íˆ´íŒìœ¼ë¡œ í‘œì‹œ
                tab.onclick = () => selectCategory(category);
                categoryTabsContainer.appendChild(tab);
            });
        }


        // ğŸ’¡ ìƒˆë¡œìš´ í•¨ìˆ˜: ê° ì¹´í…Œê³ ë¦¬ì˜ ì²« ë²ˆì§¸ ê°¤ëŸ¬ë¦¬ì¸ì§€ í™•ì¸
        function isFirstGalleryInCategory(musicId, category) {
            if (!category || !mySunoMusic) {
                console.log('isFirstGalleryInCategory: category ë˜ëŠ” mySunoMusicì´ ì—†ìŒ', {category, hasMySunoMusic: !!mySunoMusic});
                return false;
            }

            // í˜„ì¬ ì¹´í…Œê³ ë¦¬ì˜ ê°¤ëŸ¬ë¦¬ë“¤ì„ ì°¾ì•„ì„œ ì²« ë²ˆì§¸ì¸ì§€ í™•ì¸
            const categoryGalleries = mySunoMusic.filter(music =>
                music.category === category &&
                Array.isArray(music.images) &&
                music.images.length > 0
            );

            const isFirst = categoryGalleries.length > 0 &&
                   (categoryGalleries[0].musicId || categoryGalleries[0].id) === musicId;

            console.log('isFirstGalleryInCategory ì²´í¬:', {
                musicId,
                category,
                categoryGalleriesCount: categoryGalleries.length,
                firstGalleryId: categoryGalleries.length > 0 ? (categoryGalleries[0].musicId || categoryGalleries[0].id) : null,
                isFirst
            });

            return isFirst;
        }

        // ğŸ’¡ ìƒˆë¡œìš´ í•¨ìˆ˜: ë‹¹ì¼ ì‹œì²­í•œ ê°¤ëŸ¬ë¦¬ì¸ì§€ í™•ì¸
        function hasViewedGalleryToday(musicId) {
            const today = new Date().toDateString();
            const viewedGalleries = JSON.parse(localStorage.getItem(`viewedGalleries_${userName}_${today}`) || '[]');
            return viewedGalleries.includes(musicId);
        }

        // ğŸ’¡ ìƒˆë¡œìš´ í•¨ìˆ˜: ê°¤ëŸ¬ë¦¬ë¥¼ ì‹œì²­í•œ ê²ƒìœ¼ë¡œ ê¸°ë¡
        function markGalleryAsViewed(musicId) {
            const today = new Date().toDateString();
            const storageKey = `viewedGalleries_${userName}_${today}`;
            const viewedGalleries = JSON.parse(localStorage.getItem(storageKey) || '[]');

            if (!viewedGalleries.includes(musicId)) {
                viewedGalleries.push(musicId);
                localStorage.setItem(storageKey, JSON.stringify(viewedGalleries));
            }
        }

        // ğŸ’¡ ìƒˆë¡œìš´ í•¨ìˆ˜: í¬ì¸íŠ¸ ì°¨ê° ì—¬ë¶€ ê²°ì •
        function shouldChargePointsForGallery(musicId, musicItem) {
            console.log('shouldChargePointsForGallery í˜¸ì¶œ:', {musicId, musicItem: !!musicItem, category: musicItem?.category, userRole});

            if (!musicItem) {
                console.log('shouldChargePointsForGallery: musicItemì´ ì—†ìŒ');
                return false;
            }

            // í¬ë¦¬ì—ì´í„° ë˜ëŠ” ê´€ë¦¬ìëŠ” í¬ì¸íŠ¸ ì°¨ê° ì—†ìŒ
            if (userRole === 'creator' || userRole === 'admin') {
                console.log('shouldChargePointsForGallery: í¬ë¦¬ì—ì´í„°/ê´€ë¦¬ìëŠ” ë¬´ë£Œ');
                return false;
            }

            // ê° ì¹´í…Œê³ ë¦¬ì˜ ì²« ë²ˆì§¸ ê°¤ëŸ¬ë¦¬ëŠ” ë¬´ë£Œ
            const isFirst = isFirstGalleryInCategory(musicId, musicItem.category);
            if (isFirst) {
                console.log('shouldChargePointsForGallery: ì²« ë²ˆì§¸ ê°¤ëŸ¬ë¦¬ì´ë¯€ë¡œ ë¬´ë£Œ');
                return false;
            }

            // ë‹¹ì¼ ì´ë¯¸ ë³¸ ê°¤ëŸ¬ë¦¬ëŠ” ë¬´ë£Œ
            const hasViewed = hasViewedGalleryToday(musicId);
            if (hasViewed) {
                console.log('shouldChargePointsForGallery: ë‹¹ì¼ ì´ë¯¸ ë³¸ ê°¤ëŸ¬ë¦¬ì´ë¯€ë¡œ ë¬´ë£Œ');
                return false;
            }

            // ê·¸ ì™¸ì˜ ê²½ìš°ëŠ” í¬ì¸íŠ¸ ì°¨ê°
            console.log('shouldChargePointsForGallery: í¬ì¸íŠ¸ ì°¨ê° í•„ìš”');
            return true;
        }

        // ğŸ’¡ ìƒˆë¡œìš´ í•¨ìˆ˜: ë¹„íšŒì›ì´ ì œí•œëœ ì½˜í…ì¸ ì¸ì§€ í™•ì¸
        function isNonMemberRestrictedContent(musicId, musicItem) {
            console.log('ë¹„íšŒì› ì œí•œ ì²´í¬:', {
                musicId: musicId,
                category: musicItem?.category,
                userName: userName,
                userRole: userRole,
                isLoggedIn: !!(userName && userRole)
            });

            // ë¡œê·¸ì¸í•œ ì‚¬ìš©ìëŠ” ì œí•œ ì—†ìŒ
            if (userName && userRole) {
                console.log('-> ë¡œê·¸ì¸í•œ ì‚¬ìš©ì, ë¹„íšŒì› ì œí•œ ì—†ìŒ');
                return false;
            }

            // musicItemì´ ì—†ìœ¼ë©´ ì œí•œ
            if (!musicItem) {
                console.log('-> musicItem ì—†ìŒ, ì œí•œ');
                return true;
            }

            // ì„±ì¸ ì¹´í…Œê³ ë¦¬ëŠ” ì²« ë²ˆì§¸ ê°¤ëŸ¬ë¦¬ë„ ë¹„íšŒì› ì œí•œ
            const categoryDetail = allCategoryDetails.find(cat => cat.name === musicItem.category);
            if (categoryDetail && categoryDetail.isAdult) {
                console.log('-> ì„±ì¸ ì¹´í…Œê³ ë¦¬, ë¹„íšŒì› ì œí•œ');
                return true; // ì„±ì¸ ì¹´í…Œê³ ë¦¬ëŠ” ë¬´ì¡°ê±´ ë¹„íšŒì› ì œí•œ
            }

            // ì¼ë°˜ ì¹´í…Œê³ ë¦¬ì˜ ì²« ë²ˆì§¸ ê°¤ëŸ¬ë¦¬ëŠ” ë¹„íšŒì›ë„ ì ‘ê·¼ ê°€ëŠ¥
            if (isFirstGalleryInCategory(musicId, musicItem.category)) {
                console.log('-> ì¼ë°˜ ì¹´í…Œê³ ë¦¬ ì²« ë²ˆì§¸ ê°¤ëŸ¬ë¦¬, ì ‘ê·¼ í—ˆìš©');
                return false;
            }

            // ê·¸ ì™¸ì˜ ê²½ìš°ëŠ” ë¹„íšŒì› ì œí•œ
            console.log('-> ì¼ë°˜ ì¹´í…Œê³ ë¦¬ ë‘ ë²ˆì§¸ ì´í›„ ê°¤ëŸ¬ë¦¬, ë¹„íšŒì› ì œí•œ');
            return true;
        }

        // ì„±ì¸ ì½˜í…ì¸  í™•ì¸ í•¨ìˆ˜
        function isAdultRestrictedContent(musicItem) {
            console.log('=== ì„±ì¸ ì½˜í…ì¸  ì²´í¬ ì‹œì‘ ===');

            // musicItemì´ ì—†ê±°ë‚˜ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìœ¼ë©´ ì œí•œ ì—†ìŒ
            if (!musicItem || !musicItem.category) {
                console.log('-> musicItem ë˜ëŠ” category ì—†ìŒ, ì œí•œ ì—†ìŒ');
                return false;
            }

            // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ì„±ì¸ ì—¬ë¶€ í™•ì¸
            const categoryDetail = allCategoryDetails.find(cat => cat.name === musicItem.category);
            console.log('ì„±ì¸ ì½˜í…ì¸  ì²´í¬ ìƒì„¸:', {
                category: musicItem.category,
                categoryDetail: categoryDetail,
                isAdult: categoryDetail?.isAdult,
                isAdultVerified: isAdultVerified,
                userName: userName,
                userRole: userRole,
                allCategoryDetailsLength: allCategoryDetails.length
            });

            if (categoryDetail && categoryDetail.isAdult) {
                // ì„±ì¸ ì¹´í…Œê³ ë¦¬ì´ê³  ì‚¬ìš©ìê°€ ì„±ì¸ ì¸ì¦ì„ í•˜ì§€ ì•Šì€ ê²½ìš°
                const shouldBlock = !isAdultVerified;
                console.log('-> ì„±ì¸ ì¹´í…Œê³ ë¦¬ì…ë‹ˆë‹¤. ì°¨ë‹¨ ì—¬ë¶€:', shouldBlock);
                return shouldBlock;
            }

            console.log('-> ì¼ë°˜ ì¹´í…Œê³ ë¦¬, ì œí•œ ì—†ìŒ');
            return false;
        }

        // ğŸ’¡ ìƒˆë¡œìš´ í•¨ìˆ˜: ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
        function findAccessibleDefaultCategory(categories) {
            if (!categories || categories.length === 0) {
                return 'all';
            }

            // ì„±ì¸ ì¸ì¦ëœ ì‚¬ìš©ìëŠ” ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬ ì‚¬ìš© (ì„±ì¸ ì¹´í…Œê³ ë¦¬ í¬í•¨)
            if (isAdultVerified) {
                return categories[0];
            }

            // ë¡œê·¸ì¸í–ˆì§€ë§Œ ì„±ì¸ ì¸ì¦ ì•ˆ ëœ ì‚¬ìš©ì: ì„±ì¸ì´ ì•„ë‹Œ ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
            if (userName && userRole) {
                for (const categoryName of categories) {
                    const categoryDetail = allCategoryDetails.find(cat => cat.name === categoryName);
                    if (!categoryDetail || !categoryDetail.isAdult) {
                        return categoryName; // ì„±ì¸ ì¹´í…Œê³ ë¦¬ê°€ ì•„ë‹Œ ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬
                    }
                }
            }

            // ë¹„ë¡œê·¸ì¸ ì‚¬ìš©ì: ì„±ì¸ì´ ì•„ë‹Œ ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
            for (const categoryName of categories) {
                const categoryDetail = allCategoryDetails.find(cat => cat.name === categoryName);
                if (!categoryDetail || !categoryDetail.isAdult) {
                    return categoryName; // ì„±ì¸ ì¹´í…Œê³ ë¦¬ê°€ ì•„ë‹Œ ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬
                }
            }

            // ëª¨ë“  ì¹´í…Œê³ ë¦¬ê°€ ì„±ì¸ìš©ì¸ ê²½ìš° ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬ ë°˜í™˜ (ë¡œê·¸ì¸ ìœ ë„)
            return categories[0];
        }

        // ğŸ’¡ ìƒˆë¡œìš´ í•¨ìˆ˜: ì ‘ê·¼ ê°€ëŠ¥í•œ ì²« ë²ˆì§¸ ê°¤ëŸ¬ë¦¬ ì½˜í…ì¸  ì°¾ê¸°
        function findAccessibleFirstContent(musicList) {
            if (!musicList || musicList.length === 0) {
                return null;
            }

            // ëª¨ë“  ì•„ì´í…œì„ ìˆœíšŒí•˜ë©° ì´ë¯¸ì§€ê°€ ìˆëŠ” ì²« ë²ˆì§¸ ì½˜í…ì¸  ì°¾ê¸° (ê¶Œí•œ ë¬´ê´€)
            for (const item of musicList) {
                // ì´ë¯¸ì§€ê°€ ìˆëŠ”ì§€ í™•ì¸ (ê¶Œí•œì— ê´€ê³„ì—†ì´ ê°¤ëŸ¬ë¦¬ëŠ” ë³¼ ìˆ˜ ìˆìŒ)
                if (item && Array.isArray(item.images) && item.images.length > 0) {
                    return item;
                }
            }

            return null;
        }

        // ğŸ’¡ ìµœìƒìœ„ ì„¹ì…˜ ì„ íƒ í•¨ìˆ˜
        function selectTopSection(section) {
            console.log('ìµœìƒìœ„ ì„¹ì…˜ ë³€ê²½:', section);

            currentTopSection = section;

            // UI ì—…ë°ì´íŠ¸ - active í´ë˜ìŠ¤
            document.querySelectorAll('.top-nav-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.top-nav-item[data-section="${section}"]`).classList.add('active');

            const categoryTabsContainer = document.getElementById('category-tabs');
            const musicPlayerContainer = document.getElementById('music-player-container');
            const paginationContainer = document.getElementById('pagination-container');

            if (section === 'visual-mode') {
                // Looks & Lines: ê¸°ì¡´ ì¹´í…Œê³ ë¦¬ ì‹œìŠ¤í…œ í‘œì‹œ
                categoryTabsContainer.style.display = 'grid';

                // ì„¹ì…˜ ë³€ê²½ ì‹œ í˜„ì¬ ì¹´í…Œê³ ë¦¬ë¥¼ nullë¡œ ì´ˆê¸°í™” (ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬ ìë™ ì„ íƒ)
                currentCategory = null;
                loadMusicDataFromServer();

            } else if (section === 'momentary') {
                // MOMENTARY: ì¹´í…Œê³ ë¦¬ ì‹œìŠ¤í…œ í‘œì‹œ
                categoryTabsContainer.style.display = 'grid';

                // ì„¹ì…˜ ë³€ê²½ ì‹œ í˜„ì¬ ì¹´í…Œê³ ë¦¬ë¥¼ nullë¡œ ì´ˆê¸°í™”
                currentCategory = null;
                loadMusicDataFromServer();

            } else if (section === 'chronicles') {
                // CHRONICLES: ì¹´í…Œê³ ë¦¬ ì‹œìŠ¤í…œ í‘œì‹œ
                categoryTabsContainer.style.display = 'grid';

                // ì„¹ì…˜ ë³€ê²½ ì‹œ í˜„ì¬ ì¹´í…Œê³ ë¦¬ë¥¼ nullë¡œ ì´ˆê¸°í™”
                currentCategory = null;
                loadMusicDataFromServer();
            }
        }

        // ğŸ’¡ ìƒˆë¡œìš´ í•¨ìˆ˜: ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ëª©ë¡ ì—…ë°ì´íŠ¸
        function selectCategory(category) {
            if (currentCategory === category && !isShowingLiked) return;

            // ì„±ì¸ ì¹´í…Œê³ ë¦¬ ì²´í¬ - ë¡œê·¸ì¸í–ˆì§€ë§Œ ì„±ì¸ ì¸ì¦ì´ ì•ˆ ëœ ê²½ìš° ì°¨ë‹¨
            const categoryDetail = allCategoryDetails.find(cat => cat.name === category);
            if (categoryDetail && categoryDetail.isAdult && !isAdultVerified) {
                console.log('-> ì„±ì¸ ì¹´í…Œê³ ë¦¬ ì ‘ê·¼ ì‹œë„, ì„±ì¸ ì¸ì¦ í•„ìš”');

                // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš° ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ
                if (!userName || !userRole) {
                    showLoginSection();
                    return;
                }

                // ë¡œê·¸ì¸í–ˆì§€ë§Œ ì„±ì¸ ì¸ì¦ ì•ˆ ëœ ê²½ìš° ì„±ì¸ ì¸ì¦ ëª¨ë‹¬ í‘œì‹œ
                showAdultVerificationModal();
                return;
            }

            // ë¹„íšŒì›ë„ ëª¨ë“  ì¹´í…Œê³ ë¦¬ì˜ ì²« ë²ˆì§¸ ê°¤ëŸ¬ë¦¬ë¥¼ ë³¼ ìˆ˜ ìˆë„ë¡ ë³€ê²½

            if (isShowingLiked) {
                isShowingLiked = false;
                updateButtonStyles();
            }
            currentCategory = category;
            currentPage = 1; // ì¹´í…Œê³ ë¦¬ ë³€ê²½ ì‹œ 1í˜ì´ì§€ë¡œ ë¦¬ì…‹
            autoOpenGallery = false; // ì¹´í…Œê³ ë¦¬ ì„ íƒ ì‹œ ìë™ ì¬ìƒ ë¹„í™œì„±í™”
            loadMusicDataFromServer();
        }

        // UI ë Œë”ë§ì„ ë‹´ë‹¹í•˜ëŠ” ê³µí†µ í•¨ìˆ˜
        function updateMusicListUI(data, isLikedView = false) {
            const container = document.getElementById('music-player-container');
            container.innerHTML = '';

            if (data.length === 0) {
                container.innerHTML = `<p style="text-align: center; color: #999; margin-top: 50px;">
                                        ${isLikedView ? 'ì €ì¥ëœ ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤.' : 'ë“±ë¡ëœ ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤.'}
                                      </p>`;
                document.getElementById('pagination-container').innerHTML = '';
                return;
            }

            // í˜ì´ì§€ë„¤ì´ì…˜ ë¡œì§ì€ ì „ì²´ ëª©ë¡ì—ë§Œ ì ìš©
            if (!isLikedView) {
                totalItems = data.length;
                totalPages = Math.ceil(totalItems / itemsPerPage);
                const start = (currentPage - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const paginatedItems = data.slice(start, end);
                renderMusicList(paginatedItems, isLikedView);
                renderPagination();
            } else {
                renderMusicList(data, isLikedView);
                document.getElementById('pagination-container').innerHTML = '';
            }
        }

        // ëª©ë¡ ì¹´ë“œ ë Œë”ë§ í•¨ìˆ˜
        function renderMusicList(data, isLikedView = false) {
            const container = document.getElementById('music-player-container');
            container.innerHTML = '';
            data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'music-card';
                card.setAttribute('data-music-id', item.musicId || item.id);

                let thumbnailSrc;
                let images;
                let imageId;
                let musicName;
                let audioSrc;

                if (isLikedView) {
                    thumbnailSrc = item.imageSrc;
                    images = [item];
                    imageId = item.id;
                    musicName = item.musicName;
                    audioSrc = item.audioSrc;
                } else {
                    images = item.images;
                    thumbnailSrc = (images && images.length > 0)
                        ? images[0].imageSrc
                        : 'https://via.placeholder.com/60/999999/FFFFFF?text=No+Img';
                    imageId = (images && images.length > 0) ? images[0].id : null;
                    musicName = item.name;
                    audioSrc = item.audioSrc;
                }

                const musicInfo = document.createElement('div');
                musicInfo.className = 'music-info';

                let likeHtml = '';
                let likeButton = null;
                if (images && images.length > 0) {
                    const isLiked = isLikedView || (images[0].isLiked > 0);

                    // ì¢‹ì•„ìš” ì»¨í…Œì´ë„ˆ ìƒì„±
                    const likeContainer = document.createElement('div');
                    likeContainer.className = 'like-info';

                    // ì¢‹ì•„ìš” ë²„íŠ¼ ìƒì„±
                    likeButton = document.createElement('button');
                    likeButton.className = 'like-button';
                    likeButton.textContent = isLiked ? 'â¤ï¸' : 'ğŸ¤';

                    // ì¢‹ì•„ìš” ìˆ˜ ìŠ¤íŒ¬ ìƒì„±
                    const likeCount = document.createElement('span');
                    likeCount.textContent = images[0].likeCount;

                    likeContainer.appendChild(likeButton);
                    likeContainer.appendChild(likeCount);

                    // ì„ì‹œë¡œ HTMLë¡œ ë³€í™˜ (ë‚˜ì¤‘ì— appendChildë¡œ ì¶”ê°€í•  ì˜ˆì •)
                    likeHtml = likeContainer.outerHTML;
                }

                musicInfo.innerHTML = `
                    <img src="${thumbnailSrc}" class="music-thumbnail" alt="ìŒì•… ì¸ë„¤ì¼">
                    <div>
                        <h3>${musicName}</h3>
                        ${!isLikedView && item.category ? `<span class="category-text">${item.category}</span>` : ''}
                        ${likeHtml}
                    </div>
                `;

                const audio = document.createElement('audio');
                audio.id = `audio-${item.musicId || item.id}`;
                audio.src = audioSrc;

                // ë²„íŠ¼ ì»¨í…Œì´ë„ˆ ìƒì„±
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'button-container';

                const playButton = document.createElement('button');
                playButton.className = 'play-button square-button';
                playButton.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                `;

                playButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    console.log('=== ì¬ìƒ ë²„íŠ¼ í´ë¦­ ===', { musicId: item.musicId || item.id, category: item.category });

                    // ë¹„íšŒì› ì œí•œ ì²´í¬ (ì„±ì¸ ì¹´í…Œê³ ë¦¬ëŠ” ì²« ë²ˆì§¸ë„ ì œí•œ)
                    if (isNonMemberRestrictedContent(item.musicId || item.id, item)) {
                        console.log('-> ë¹„íšŒì› ì œí•œ, ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ');
                        showLoginSection();
                        return;
                    }

                    // ì„±ì¸ ì½˜í…ì¸  ì œí•œ ì²´í¬ (ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì¤‘ ì„±ì¸ ì¸ì¦ ì•ˆ ëœ ê²½ìš°)
                    if (isAdultRestrictedContent(item)) {
                        console.log('-> ì„±ì¸ ì½˜í…ì¸  ì œí•œ, ì„±ì¸ ì¸ì¦ ëª¨ë‹¬ í‘œì‹œ');
                        showAdultVerificationModal();
                        return;
                    }

                    console.log('-> ì œí•œ ì—†ìŒ, ìŒì•… ì¬ìƒ');
                    togglePlay(item.musicId || item.id, audioSrc, images);
                    focusGallery();
                });


                // **ìˆ˜ì •ëœ ë¶€ë¶„: ê°¤ëŸ¬ë¦¬ë¥¼ í˜¸ì¶œí•˜ê³  ìŒì•…ë„ ì¬ìƒí•˜ëŠ” í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ**
                card.addEventListener('click', () => {
                    console.log('=== ì¹´ë“œ í´ë¦­ ===', { musicId: item.musicId || item.id, category: item.category });

                    // ë¹„íšŒì› ì œí•œ ì²´í¬ (ì„±ì¸ ì¹´í…Œê³ ë¦¬ëŠ” ì²« ë²ˆì§¸ë„ ì œí•œ)
                    if (isNonMemberRestrictedContent(item.musicId || item.id, item)) {
                        console.log('-> ë¹„íšŒì› ì œí•œ, ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ');
                        showLoginSection();
                        return;
                    }

                    // ì„±ì¸ ì½˜í…ì¸  ì œí•œ ì²´í¬ (ë¡œê·¸ì¸í•œ ì‚¬ìš©ì ì¤‘ ì„±ì¸ ì¸ì¦ ì•ˆ ëœ ê²½ìš°)
                    if (isAdultRestrictedContent(item)) {
                        console.log('-> ì„±ì¸ ì½˜í…ì¸  ì œí•œ, ì„±ì¸ ì¸ì¦ ëª¨ë‹¬ í‘œì‹œ');
                        showAdultVerificationModal();
                        return;
                    }

                    console.log('-> ì œí•œ ì—†ìŒ, ê°¤ëŸ¬ë¦¬ í‘œì‹œ');
                    let imagesToShow = [];
                    if (isShowingLiked) {
                        const fullMusicItem = allMusicData.find(music => music.id === item.musicId);
                        if (fullMusicItem && fullMusicItem.images) {
                            imagesToShow = fullMusicItem.images; // í•´ë‹¹ ìŒì•…ì˜ ëª¨ë“  ì´ë¯¸ì§€
                        } else {
                            imagesToShow = [item];
                        }
                    } else {
                        imagesToShow = images;
                    }

                    // ê°¤ëŸ¬ë¦¬ í‘œì‹œ
                    showGallery(item.musicId || item.id, imagesToShow);

                    // ìŒì•… ì¬ìƒ
                    togglePlay(item.musicId || item.id, audioSrc, images);

                    // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œì—ì„œ ì¹´ë“œ í´ë¦­ ì‹œ ê°¤ëŸ¬ë¦¬ë¡œ ì´ë™
                    const isMobile = window.innerWidth <= 768;
                    const isPortrait = window.innerHeight > window.innerWidth;
                    if (isMobile && isPortrait && !isMobilePortraitMode) {
                        enableMobilePortraitMode();
                    }

                    // ê°¤ëŸ¬ë¦¬ í¬ì»¤ì‹±
                    focusGallery();
                });

                // ì €ì¥ ë²„íŠ¼ ì¶”ê°€
                const saveButton = document.createElement('button');
                saveButton.className = 'save-button square-button';
                const isSaved = mySavedMusic.some(liked => (liked.musicId || liked.id) === (item.musicId || item.id));

                if (isSaved) {
                    saveButton.classList.add('saved');
                }

                saveButton.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="${isSaved ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                `;
                saveButton.addEventListener('click', (event) => {
                    event.stopPropagation();
                    console.log('ì €ì¥ ë²„íŠ¼ í´ë¦­ë¨:', item.musicId || item.id, item.name || item.title);
                    toggleSave(item.musicId || item.id, item, saveButton);
                });

                // ê¸°ë³¸ ë²„íŠ¼ë“¤ì„ ì»¨í…Œì´ë„ˆì— ì¶”ê°€
                buttonContainer.appendChild(playButton);
                buttonContainer.appendChild(saveButton);

                card.appendChild(musicInfo);
                card.appendChild(audio);

                if ((userRole === 'creator' || userRole === 'admin') && !isLikedView) {
                    // ì¶”ì²œ ë²„íŠ¼ ì¶”ê°€
                    const recommendButton = document.createElement('button');
                    recommendButton.className = 'recommend-button square-button';
                    const isRecommended = item.recommended === 1;
                    recommendButton.textContent = isRecommended ? 'â­' : 'â˜†';
                    recommendButton.style.color = isRecommended ? '#FFD700' : '#999';
                    recommendButton.addEventListener('click', (event) => {
                        event.stopPropagation();
                        toggleRecommended(item.musicId || item.id, !isRecommended, recommendButton);
                    });
                    buttonContainer.appendChild(recommendButton);

                    const editButton = document.createElement('button');
                    editButton.className = 'edit-button square-button';
                    editButton.textContent = 'âœ';
                    editButton.addEventListener('click', (event) => {
                        event.stopPropagation();
                        showEditForm(item);
                    });
                    buttonContainer.appendChild(editButton);

                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'delete-button square-button';
                    deleteButton.textContent = 'X';
                    deleteButton.addEventListener('click', (event) => {
                        event.stopPropagation();
                        deleteMusic(item.musicId || item.id);
                    });
                    buttonContainer.appendChild(deleteButton);
                }

                // ë²„íŠ¼ ì»¨í…Œì´ë„ˆë¥¼ ì¹´ë“œì— ì¶”ê°€
                card.appendChild(buttonContainer);
                container.appendChild(card);

                // ì¢‹ì•„ìš” ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (ì¹´ë“œê°€ DOMì— ì¶”ê°€ëœ í›„)
                if (images && images.length > 0) {
                    const addedLikeButton = card.querySelector('.like-button');
                    if (addedLikeButton) {
                        addedLikeButton.addEventListener('click', (event) => {
                            event.stopPropagation();
                            console.log('ì¢‹ì•„ìš” ë²„íŠ¼ í´ë¦­ë¨:', imageId);
                            toggleLike(imageId);
                        });
                    }
                }
            });

            // ìƒˆë¡œ ìƒì„±ëœ í”Œë ˆì´ ë²„íŠ¼ë“¤ì— ì˜¬ë°”ë¥¸ ìŠ¤íƒ€ì¼ ì ìš©
            setTimeout(() => {
                const isMobile = window.innerWidth <= 768;
                const isLandscape = window.innerWidth > window.innerHeight;
                updatePlayButtonStyles(isMobile, isLandscape);

                // í˜„ì¬ ì¬ìƒì¤‘ì¸ ìŒì•…ì´ ìˆìœ¼ë©´ ê°•ì¡° í‘œì‹œ ë³µì›
                if (currentGalleryInfo && currentGalleryInfo.musicId) {
                    const musicList = (isShowingLiked || isShowingSaved) ? mySavedMusic : (allMusicData || mySunoMusic);
                    const currentMusic = musicList.find(music =>
                        (music.musicId || music.id) === currentGalleryInfo.musicId
                    );
                    if (currentMusic) {
                        updatePlayingHighlight(currentGalleryInfo.musicId, currentMusic.category);
                    }
                }
            }, 100);
        }

        function renderPagination() {
            const paginationContainer = document.getElementById('pagination-container');
            paginationContainer.innerHTML = '';
            if (totalPages <= 1) return;

            // ì´ì „ í˜ì´ì§€ ë²„íŠ¼
            const prevButton = document.createElement('button');
            prevButton.textContent = 'ì´ì „';
            prevButton.disabled = currentPage === 1;
            prevButton.onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    loadMusicDataFromServer();
                }
            };
            paginationContainer.appendChild(prevButton);

            // í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
            for (let i = 1; i <= totalPages; i++) {
                const pageButton = document.createElement('button');
                pageButton.textContent = i;
                pageButton.className = i === currentPage ? 'active' : '';
                pageButton.onclick = () => {
                    currentPage = i;
                    loadMusicDataFromServer();
                };
                paginationContainer.appendChild(pageButton);
            }

            // ë‹¤ìŒ í˜ì´ì§€ ë²„íŠ¼
            const nextButton = document.createElement('button');
            nextButton.textContent = 'ë‹¤ìŒ';
            nextButton.disabled = currentPage === totalPages;
            nextButton.onclick = () => {
                if (currentPage < totalPages) {
                    currentPage++;
                    loadMusicDataFromServer();
                }
            };
            paginationContainer.appendChild(nextButton);
        }


        // ì¢‹ì•„ìš” ë²„íŠ¼ í† ê¸€ í•¨ìˆ˜
        // ì¶”ì²œ ê°¤ëŸ¬ë¦¬ í† ê¸€ í•¨ìˆ˜
        async function toggleRecommended(musicId, recommended, buttonElement) {
            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                // Firestoreì—ì„œ ìŒì•… ë¬¸ì„œ ì—…ë°ì´íŠ¸
                const musicRef = window.firebaseDoc(window.firebaseDb, 'music', musicId);
                await window.firebaseSetDoc(musicRef, {
                    isRecommended: recommended ? 1 : 0
                }, { merge: true });

                // ë²„íŠ¼ UI ì—…ë°ì´íŠ¸
                buttonElement.textContent = recommended ? 'â­' : 'â˜†';
                buttonElement.style.color = recommended ? '#FFD700' : '#999';

                // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadMusicDataFromServer();
            } catch (error) {
                console.error('ì¶”ì²œ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì¶”ì²œ ìƒíƒœ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // Firestoreì— ì¢‹ì•„ìš” ì €ì¥ í•¨ìˆ˜
        async function saveToggleLikeToFirestore(imageId, isLiked, musicItem) {
            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) return false;

                const userLikesRef = window.firebaseDoc(window.firebaseDb, 'userLikes', user.uid);
                const userLikesDoc = await window.firebaseGetDoc(userLikesRef);

                let likedImages = [];
                if (userLikesDoc.exists()) {
                    likedImages = userLikesDoc.data().images || [];
                }

                if (isLiked > 0) {
                    // ì¢‹ì•„ìš” ì¶”ê°€
                    const imageData = {
                        id: imageId,
                        musicId: musicItem.musicId || musicItem.id,
                        musicName: musicItem.name || musicItem.title,
                        audioSrc: musicItem.audioSrc,
                        imageSrc: musicItem.images.find(img => img.id == imageId)?.imageSrc,
                        likeCount: 1,
                        timestamp: new Date().toISOString()
                    };

                    // ì¤‘ë³µ ì²´í¬
                    const existingIndex = likedImages.findIndex(img => img.id == imageId);
                    if (existingIndex === -1) {
                        likedImages.push(imageData);
                    }
                } else {
                    // ì¢‹ì•„ìš” ì·¨ì†Œ
                    likedImages = likedImages.filter(img => img.id != imageId);
                }

                // Firestore ì—…ë°ì´íŠ¸
                await window.firebaseSetDoc(userLikesRef, { images: likedImages }, { merge: true });
                return true;
            } catch (error) {
                console.error('Firestore ì¢‹ì•„ìš” ì €ì¥ ì˜¤ë¥˜:', error);
                return false;
            }
        }

        // UI ì—…ë°ì´íŠ¸ í—¬í¼ í•¨ìˆ˜
        function updateLikeUI(imageId, targetImage) {
            // ê°¤ëŸ¬ë¦¬ UI ì—…ë°ì´íŠ¸
            const galleryLikeButton = document.querySelector(`.gallery-item[data-image-id="${imageId}"] .gallery-like-button`);
            const galleryLikeCount = document.querySelector(`.gallery-item[data-image-id="${imageId}"] .gallery-like-count`);
            if (galleryLikeButton) {
                galleryLikeButton.innerHTML = targetImage.isLiked > 0 ? 'â¤ï¸' : 'ğŸ¤';
            }
            if (galleryLikeCount) {
                galleryLikeCount.textContent = targetImage.likeCount;
            }

            // ëª©ë¡ ë·° UI ì—…ë°ì´íŠ¸
            const listLikeButtons = document.querySelectorAll('.like-button');
            listLikeButtons.forEach((btn) => {
                const parentCard = btn.closest('.music-card');
                if (parentCard) {
                    const musicId = parentCard.getAttribute('data-music-id');
                    const music = mySunoMusic.find(m => (m.musicId || m.id) == musicId);
                    if (music && music.images && music.images.some(img => img.id == imageId)) {
                        btn.textContent = targetImage.isLiked > 0 ? 'â¤ï¸' : 'ğŸ¤';
                        const likeInfo = btn.parentElement;
                        const countSpan = likeInfo.querySelector('span');
                        if (countSpan) {
                            countSpan.textContent = targetImage.likeCount;
                        }
                    }
                }
            });
        }

        // ë¡¤ë°± í—¬í¼ í•¨ìˆ˜
        function rollbackLike(targetImage) {
            if (targetImage.isLiked > 0) {
                targetImage.serverLikeCount = Math.max(0, targetImage.serverLikeCount - 1);
                targetImage.likeCount = (targetImage.defaultLikes || 0) + targetImage.serverLikeCount;
                targetImage.isLiked = 0;
            } else {
                targetImage.serverLikeCount = targetImage.serverLikeCount + 1;
                targetImage.likeCount = (targetImage.defaultLikes || 0) + targetImage.serverLikeCount;
                targetImage.isLiked = 1;
            }
        }

        function toggleLike(imageId) {
            // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìëŠ” ì¢‹ì•„ìš” ê¸°ëŠ¥ ì œí•œ
            if (!userRole) {
                showLoginSection();
                return;
            }

            // í˜„ì¬ ì´ë¯¸ì§€ê°€ ì†í•œ ì¹´í…Œê³ ë¦¬ í™•ì¸ í•„ìš”
            const currentMusicList = isShowingLiked ? mySavedMusic : mySunoMusic;
            const musicItem = currentMusicList.find(music => {
                if (music.images && Array.isArray(music.images)) {
                    return music.images.some(img => img.id == imageId);
                }
                return false;
            });

            // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì¦‰ì‹œ ì¢‹ì•„ìš” ìˆ˜ ì—…ë°ì´íŠ¸
            if (musicItem && musicItem.images) {
                const targetImage = musicItem.images.find(img => img.id == imageId);
                if (targetImage) {
                    const wasLiked = targetImage.isLiked > 0;
                    console.log('ì¢‹ì•„ìš” ìƒíƒœ ë³€ê²½ ì „ - wasLiked:', wasLiked, 'serverLikeCount:', targetImage.serverLikeCount, 'totalLikeCount:', targetImage.likeCount);

                    if (!wasLiked) {
                        // ì¢‹ì•„ìš” ì¶”ê°€
                        targetImage.serverLikeCount = (targetImage.serverLikeCount || 0) + 1;
                        targetImage.likeCount = (targetImage.defaultLikes || 0) + targetImage.serverLikeCount;
                        targetImage.isLiked = 1;
                        console.log('ì¢‹ì•„ìš” ì¶”ê°€ í›„ - serverLikeCount:', targetImage.serverLikeCount, 'totalLikeCount:', targetImage.likeCount);
                    } else {
                        // ì¢‹ì•„ìš” ì·¨ì†Œ
                        targetImage.serverLikeCount = Math.max(0, (targetImage.serverLikeCount || 0) - 1);
                        targetImage.likeCount = (targetImage.defaultLikes || 0) + targetImage.serverLikeCount;
                        targetImage.isLiked = 0;
                        console.log('ì¢‹ì•„ìš” ì·¨ì†Œ í›„ - serverLikeCount:', targetImage.serverLikeCount, 'totalLikeCount:', targetImage.likeCount);
                    }

                    // allMusicDataì—ì„œë„ ë™ì¼í•˜ê²Œ ì—…ë°ì´íŠ¸
                    const allMusicItem = allMusicData.find(music => {
                        if (music.images && Array.isArray(music.images)) {
                            return music.images.some(img => img.id == imageId);
                        }
                        return false;
                    });

                    if (allMusicItem && allMusicItem.images) {
                        const allTargetImage = allMusicItem.images.find(img => img.id == imageId);
                        if (allTargetImage) {
                            allTargetImage.serverLikeCount = targetImage.serverLikeCount;
                            allTargetImage.likeCount = targetImage.likeCount;
                            allTargetImage.isLiked = targetImage.isLiked;
                        }
                    }

                    // ê°¤ëŸ¬ë¦¬ì˜ ì¢‹ì•„ìš” ë²„íŠ¼ê³¼ ì¹´ìš´íŠ¸ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    const galleryLikeButton = document.querySelector(`.gallery-item[data-image-id="${imageId}"] .gallery-like-button`);
                    const galleryLikeCount = document.querySelector(`.gallery-item[data-image-id="${imageId}"] .gallery-like-count`);

                    if (galleryLikeButton) {
                        galleryLikeButton.innerHTML = targetImage.isLiked > 0 ? 'â¤ï¸' : 'ğŸ¤';
                    }
                    if (galleryLikeCount) {
                        galleryLikeCount.textContent = targetImage.likeCount;
                        console.log('ê°¤ëŸ¬ë¦¬ UI ì—…ë°ì´íŠ¸ë¨ - í‘œì‹œëœ ì¹´ìš´íŠ¸:', targetImage.likeCount);
                    }

                    // ëª©ë¡ ë·°ì˜ ì¢‹ì•„ìš” ë²„íŠ¼ê³¼ ì¹´ìš´íŠ¸ ì¦‰ì‹œ ì—…ë°ì´íŠ¸
                    const listLikeButtons = document.querySelectorAll('.like-button');

                    listLikeButtons.forEach((btn, index) => {
                        // í´ë¦­ëœ ì´ë¯¸ì§€ IDì™€ ë§¤ì¹­ë˜ëŠ” ë²„íŠ¼ ì°¾ê¸°
                        const parentCard = btn.closest('.music-card');
                        if (parentCard) {
                            const musicId = parentCard.getAttribute('data-music-id');
                            const music = mySunoMusic.find(m => (m.musicId || m.id) == musicId);
                            if (music && music.images && music.images.some(img => img.id == imageId)) {
                                btn.textContent = targetImage.isLiked > 0 ? 'â¤ï¸' : 'ğŸ¤';
                                const likeInfo = btn.parentElement;
                                const countSpan = likeInfo.querySelector('span');
                                if (countSpan) {
                                    countSpan.textContent = targetImage.likeCount;
                                }
                            }
                        }
                    });

                    // ì¢‹ì•„ìš” ë³´ê¸° ëª¨ë“œì¼ ë•Œë§Œ ë¦¬ìŠ¤íŠ¸ ìƒˆë¡œê³ ì¹¨ (ì¼ë°˜ ëª¨ë“œì—ì„œëŠ” ìœ„ì—ì„œ ì´ë¯¸ UI ì—…ë°ì´íŠ¸ë¨)
                    if (isShowingLiked) {
                        loadSavedMusic();
                    }
                }
            }

            // Firestoreì— ì¢‹ì•„ìš” ìƒíƒœ ì €ì¥
            if (musicItem && musicItem.images) {
                const targetImage = musicItem.images.find(img => img.id == imageId);
                if (targetImage) {
                    console.log('ì¢‹ì•„ìš” í† ê¸€ - imageId:', imageId, 'isLiked:', targetImage.isLiked);

                    // Firestoreì— ì €ì¥
                    saveToggleLikeToFirestore(imageId, targetImage.isLiked, musicItem)
                    .then(success => {
                        if (success) {
                            console.log('ì¢‹ì•„ìš” í† ê¸€ ì„±ê³µ');

                            // allMusicDataë„ ì—…ë°ì´íŠ¸
                            const allMusicItem = allMusicData.find(music => {
                                if (music.images && Array.isArray(music.images)) {
                                    return music.images.some(img => img.id == imageId);
                                }
                                return false;
                            });
                            if (allMusicItem && allMusicItem.images) {
                                const allTargetImage = allMusicItem.images.find(img => img.id == imageId);
                                if (allTargetImage) {
                                    allTargetImage.serverLikeCount = targetImage.serverLikeCount;
                                    allTargetImage.likeCount = targetImage.likeCount;
                                    allTargetImage.isLiked = targetImage.isLiked;
                                }
                            }

                            // UI ì—…ë°ì´íŠ¸
                            updateLikeUI(imageId, targetImage);
                        } else {
                            console.error('Firestore ì¢‹ì•„ìš” í† ê¸€ ì‹¤íŒ¨');
                            // ì‹¤íŒ¨ ì‹œ ë¡¤ë°±
                            rollbackLike(targetImage);
                        }
                    })
                    .catch(error => {
                        console.error('ì¢‹ì•„ìš” í† ê¸€ ì˜¤ë¥˜:', error);
                        rollbackLike(targetImage);
                    });
                }
            }
        }

        async function toggleSave(musicId, musicItem, buttonElement) {
            console.log('toggleSave í•¨ìˆ˜ í˜¸ì¶œë¨:', musicId, musicItem?.name || musicItem?.title, userName, userRole);

            // ë¹„íšŒì›ì¼ ë•Œ íšŒì›ê°€ì… ëª¨ë‹¬ í‘œì‹œ
            if (!userName || !userRole) {
                console.log('ë¹„íšŒì› - ë¡œê·¸ì¸ ëª¨ë‹¬ í‘œì‹œ');
                showLoginSection();
                return;
            }

            const user = window.firebaseAuth.currentUser;
            if (!user) {
                console.log('Firebase ì‚¬ìš©ì ì—†ìŒ');
                showLoginSection();
                return;
            }

            const isCurrentlySaved = mySavedMusic.some(liked => (liked.musicId || liked.id) === musicId);
            console.log('í˜„ì¬ ì €ì¥ ìƒíƒœ:', isCurrentlySaved, 'mySavedMusic ê¸¸ì´:', mySavedMusic.length);

            // í´ë¼ì´ì–¸íŠ¸ ì¸¡ì—ì„œ ì¦‰ì‹œ UI ì—…ë°ì´íŠ¸
            if (isCurrentlySaved) {
                // ì €ì¥ í•´ì œ
                mySavedMusic = mySavedMusic.filter(liked => (liked.musicId || liked.id) !== musicId);
                buttonElement.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                `;
                buttonElement.classList.remove('saved');
                console.log(`ë‚´ëª©ë¡ì—ì„œ ì œê±°: ${musicId}`);
            } else {
                // ì €ì¥ ì¶”ê°€
                console.log('ëª©ë¡ì— ì¶”ê°€ ì¤‘:', musicItem);
                mySavedMusic.push(musicItem);
                buttonElement.innerHTML = `
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                    </svg>
                `;
                buttonElement.classList.add('saved');
                console.log(`ë‚´ëª©ë¡ì— ì¶”ê°€: ${musicId}`);
            }

            // ëª¨ë“  ì €ì¥ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            updateAllSaveButtonStates();

            // í˜„ì¬ ë‚´ëª©ë¡ ë³´ê¸° ì¤‘ì´ë©´ ëª©ë¡ ìƒˆë¡œê³ ì¹¨
            if (isShowingSaved) {
                updateMusicListUI(mySavedMusic);
            }

            // Firestoreì— ì €ì¥ ìƒíƒœ ì €ì¥
            try {
                const savedMusicRef = window.firebaseCollection(window.firebaseDb, 'savedMusic');
                const querySnapshot = await window.firebaseGetDocs(
                    window.firebaseQuery(savedMusicRef,
                        window.firebaseWhere('userId', '==', user.uid),
                        window.firebaseWhere('musicId', '==', musicId)
                    )
                );

                if (!isCurrentlySaved) {
                    // ì €ì¥ ì¶”ê°€
                    await window.firebaseAddDoc(savedMusicRef, {
                        userId: user.uid,
                        musicId: musicId,
                        musicName: musicItem.name || musicItem.title,
                        audioSrc: musicItem.audioSrc,
                        category: musicItem.category,
                        createdAt: new Date().toISOString()
                    });
                    console.log('Firestoreì— ì €ì¥ ì¶”ê°€ ì„±ê³µ');
                } else {
                    // ì €ì¥ í•´ì œ
                    querySnapshot.forEach(async (doc) => {
                        await window.firebaseDeleteDoc(doc.ref);
                    });
                    console.log('Firestoreì—ì„œ ì €ì¥ ì œê±° ì„±ê³µ');
                }

                // ì €ì¥ ëª©ë¡ ë³´ê¸° ì¤‘ì´ë©´ ìƒˆë¡œê³ ì¹¨
                if (isShowingSaved) {
                    await loadSavedMusicFromFirestore();
                }
            } catch (error) {
                console.error('Firestore ì €ì¥ ì˜¤ë¥˜:', error);
                alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');

                // ì˜¤ë¥˜ ì‹œ í´ë¼ì´ì–¸íŠ¸ ìƒíƒœ ë¡¤ë°±
                if (isCurrentlySaved) {
                    mySavedMusic.push(musicItem);
                    buttonElement.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                    `;
                    buttonElement.classList.add('saved');
                } else {
                    mySavedMusic = mySavedMusic.filter(liked => (liked.musicId || liked.id) !== musicId);
                    buttonElement.innerHTML = `
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                        </svg>
                    `;
                    buttonElement.classList.remove('saved');
                }
                updateAllSaveButtonStates();
            }
        }

        // ëª¨ë“  ì €ì¥ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateAllSaveButtonStates() {
            const saveButtons = document.querySelectorAll('.save-button');
            saveButtons.forEach(button => {
                // ë²„íŠ¼ì˜ ë¶€ëª¨ ì¹´ë“œì—ì„œ musicId ì°¾ê¸°
                const musicCard = button.closest('.music-card');
                if (musicCard) {
                    const musicId = musicCard.getAttribute('data-music-id');
                    const isSaved = mySavedMusic.some(liked => (liked.musicId || liked.id) == musicId);

                    // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
                    if (isSaved) {
                        button.classList.add('saved');
                        button.innerHTML = `
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                            </svg>
                        `;
                    } else {
                        button.classList.remove('saved');
                        button.innerHTML = `
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
                            </svg>
                        `;
                    }
                }
            });
        }

        // ğŸš€ ìˆ˜ì •ëœ shareMusic í•¨ìˆ˜
        async function shareMusic(title, url, imageUrl) {
            const shareData = {
                title: title,
                text: 'Pixel Sundayì—ì„œ ë©‹ì§„ ìŒì•…ì„ ë“¤ì–´ë³´ì„¸ìš”!',
                url: new URL(url, window.location.origin).href
            };

            const isMobile = /Mobi|Android/i.test(navigator.userAgent);
            
            if (imageUrl) {
                try {
                    const response = await fetch(imageUrl);
                    const blob = await response.blob();
                    shareData.files = [new File([blob], 'shared_image.jpg', { type: 'image/jpeg' })];
                } catch (error) {
                    console.error('ì´ë¯¸ì§€ fetch ì‹¤íŒ¨:', error);
                }
            }

            if (isMobile && navigator.share) {
                navigator.share(shareData)
                    .then(() => console.log('ê³µìœ  ì„±ê³µ'))
                    .catch((error) => {
                        console.error('ê³µìœ  ì‹¤íŒ¨:', error);
                        showShareModal(shareData.title, shareData.url);
                    });
            } else {
                showShareModal(shareData.title, shareData.url);
            }
        }
        
        // **ìƒˆë¡œ ì¶”ê°€ëœ í•¨ìˆ˜: ê³µìœ  íŒì—… ë„ìš°ê¸°**
        function showShareModal(title, url) {
            const modal = document.getElementById('share-modal');
            const linkInput = document.getElementById('share-link-input');
            linkInput.value = url;
            modal.style.display = 'flex';
        }
        
        // **ìƒˆë¡œ ì¶”ê°€ëœ í•¨ìˆ˜: ê³µìœ  íŒì—… ìˆ¨ê¸°ê¸°**
        function hideShareModal() {
            const modal = document.getElementById('share-modal');
            modal.style.display = 'none';
        }

        // ì„±ì¸ ì¸ì¦ ëª¨ë‹¬ í‘œì‹œ
        function showAdultVerificationModal() {
            console.log('=== ì„±ì¸ ì¸ì¦ ëª¨ë‹¬ í‘œì‹œ ì‹œë„ ===');
            const modal = document.getElementById('adult-verification-modal');
            console.log('ëª¨ë‹¬ element:', modal);
            if (modal) {
                // ëª¨ë‹¬ ì´ˆê¸°í™”
                document.getElementById('phone-number-input').value = '';
                document.getElementById('verification-code-input').value = '';
                document.getElementById('verification-code-section').style.display = 'none';
                document.getElementById('submit-verification-btn').disabled = true;
                document.getElementById('submit-verification-btn').style.opacity = '0.5';

                modal.style.display = 'flex';
                console.log('ëª¨ë‹¬ display ì„¤ì • ì™„ë£Œ:', modal.style.display);
            } else {
                console.error('ì„±ì¸ ì¸ì¦ ëª¨ë‹¬ elementë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                alert('ì„±ì¸ ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ì„±ì¸ ì¸ì¦ì„ ìš”ì²­í•´ì£¼ì„¸ìš”.');
            }
        }

        // ì„±ì¸ ì¸ì¦ ëª¨ë‹¬ ë‹«ê¸°
        function closeAdultVerificationModal() {
            const modal = document.getElementById('adult-verification-modal');
            modal.style.display = 'none';

            // íƒ€ì´ë¨¸ ì •ë¦¬
            if (window.verificationTimer) {
                clearInterval(window.verificationTimer);
                window.verificationTimer = null;
            }
        }

        // íœ´ëŒ€í° ë²ˆí˜¸ í¬ë§·íŒ… (010-0000-0000)
        function formatPhoneNumber(input) {
            let value = input.value.replace(/[^0-9]/g, '');

            if (value.length > 3 && value.length <= 7) {
                value = value.slice(0, 3) + '-' + value.slice(3);
            } else if (value.length > 7) {
                value = value.slice(0, 3) + '-' + value.slice(3, 7) + '-' + value.slice(7, 11);
            }

            input.value = value;
        }

        // ì¸ì¦ë²ˆí˜¸ ë°œì†¡ (í”„ë¡œí† íƒ€ì… - ì‹¤ì œë¡œëŠ” ë°œì†¡í•˜ì§€ ì•ŠìŒ)
        let verificationCode = null;
        function sendVerificationCode() {
            const phoneInput = document.getElementById('phone-number-input');
            const phoneNumber = phoneInput.value.replace(/[^0-9]/g, '');

            if (phoneNumber.length !== 11 || !phoneNumber.startsWith('010')) {
                alert('ì˜¬ë°”ë¥¸ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            // ëœë¤ 6ìë¦¬ ì¸ì¦ë²ˆí˜¸ ìƒì„± (í”„ë¡œí† íƒ€ì…ìš©)
            verificationCode = Math.floor(100000 + Math.random() * 900000).toString();
            console.log('ìƒì„±ëœ ì¸ì¦ë²ˆí˜¸ (í”„ë¡œí† íƒ€ì…):', verificationCode);

            // ì¸ì¦ë²ˆí˜¸ ì…ë ¥ ì„¹ì…˜ í‘œì‹œ
            document.getElementById('verification-code-section').style.display = 'block';
            document.getElementById('send-code-btn').textContent = 'ì¬ë°œì†¡';

            // íƒ€ì´ë¨¸ ì‹œì‘ (3ë¶„)
            startTimer(180);

            alert(`ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.\n(í”„ë¡œí† íƒ€ì…: ${verificationCode})`);
        }

        // íƒ€ì´ë¨¸ ì‹œì‘
        function startTimer(duration) {
            // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ë¦¬
            if (window.verificationTimer) {
                clearInterval(window.verificationTimer);
            }

            let timer = duration;
            const timerDisplay = document.getElementById('timer');

            window.verificationTimer = setInterval(function () {
                const minutes = parseInt(timer / 60, 10);
                const seconds = parseInt(timer % 60, 10);

                timerDisplay.textContent = minutes + ':' + (seconds < 10 ? '0' + seconds : seconds);

                if (--timer < 0) {
                    clearInterval(window.verificationTimer);
                    timerDisplay.textContent = 'ì‹œê°„ ë§Œë£Œ';
                    timerDisplay.style.color = '#999';
                    verificationCode = null;
                }
            }, 1000);
        }

        // ì¸ì¦ë²ˆí˜¸ ì…ë ¥ ì‹œ ë²„íŠ¼ í™œì„±í™”
        document.addEventListener('DOMContentLoaded', function() {
            const codeInput = document.getElementById('verification-code-input');
            if (codeInput) {
                codeInput.addEventListener('input', function() {
                    const submitBtn = document.getElementById('submit-verification-btn');
                    if (this.value.length === 6) {
                        submitBtn.disabled = false;
                        submitBtn.style.opacity = '1';
                    } else {
                        submitBtn.disabled = true;
                        submitBtn.style.opacity = '0.5';
                    }
                });
            }
        });

        // ì„±ì¸ ì¸ì¦ ìš”ì²­ ì œì¶œ
        async function submitAdultVerification() {
            const phoneNumber = document.getElementById('phone-number-input').value.replace(/[^0-9]/g, '');
            const inputCode = document.getElementById('verification-code-input').value;

            // ì¸ì¦ë²ˆí˜¸ í™•ì¸ (í”„ë¡œí† íƒ€ì…)
            if (inputCode !== verificationCode) {
                alert('ì¸ì¦ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }

            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                // Firestoreì— ì¸ì¦ ìš”ì²­ ì €ì¥
                const verificationRequestRef = window.firebaseCollection(window.firebaseDb, 'adultVerificationRequests');
                await window.firebaseAddDoc(verificationRequestRef, {
                    userId: user.uid,
                    userEmail: user.email,
                    phoneNumber: phoneNumber,
                    requestedAt: window.firebaseServerTimestamp(),
                    status: 'pending', // pending, approved, rejected
                    verifiedAt: null,
                    verifiedBy: null
                });

                alert('ì„±ì¸ ì¸ì¦ ìš”ì²­ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.\nê´€ë¦¬ì ìŠ¹ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.');
                closeAdultVerificationModal();

                console.log('ì„±ì¸ ì¸ì¦ ìš”ì²­ ì œì¶œ ì™„ë£Œ:', {
                    userId: user.uid,
                    phoneNumber: phoneNumber
                });

            } catch (error) {
                console.error('ì„±ì¸ ì¸ì¦ ìš”ì²­ ì‹¤íŒ¨:', error);
                alert('ì¸ì¦ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\nì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // **ìƒˆë¡œ ì¶”ê°€ëœ í•¨ìˆ˜: URLì„ í´ë¦½ë³´ë“œì— ë³µì‚¬í•˜ê¸°**
        function copyToClipboard() {
            const linkInput = document.getElementById('share-link-input');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(linkInput.value)
                .then(() => {
                    alert('ë§í¬ê°€ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
                })
                .catch(err => {
                    console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err);
                    alert('ë§í¬ ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                });
        }

        // Media Session API ì„¤ì • (ë¸”ë£¨íˆ¬ìŠ¤/í—¤ë“œí° ì»¨íŠ¸ë¡¤ ì—°ë™)
        function setupMediaSession() {
            if ('mediaSession' in navigator) {
                try {
                    // í˜„ì¬ ì¬ìƒ ì¤‘ì¸ ìŒì•… ì •ë³´ ì„¤ì •
                    const musicList = (isShowingLiked || isShowingSaved) ? mySavedMusic : mySunoMusic;
                    const currentMusic = musicList && currentMusicIndex >= 0 ? musicList[currentMusicIndex] : null;

                    if (currentMusic) {
                        // ì²« ë²ˆì§¸ ì´ë¯¸ì§€ ê°€ì ¸ì˜¤ê¸°
                        const firstImage = currentMusic.images && currentMusic.images.length > 0
                            ? (currentMusic.images[0].imageSrc || currentMusic.images[0])
                            : '';

                        navigator.mediaSession.metadata = new MediaMetadata({
                            title: currentMusic.name || currentMusic.title || 'ê°¤ëŸ¬ë¦¬',
                            artist: currentMusic.artist || currentMusic.category || 'Unknown',
                            album: 'PixelPlanet Gallery',
                            artwork: firstImage ? [
                                { src: firstImage, sizes: '512x512', type: 'image/jpeg' }
                            ] : []
                        });
                    }

                    // ì¬ìƒ/ì¼ì‹œì •ì§€ ë²„íŠ¼ í•¸ë“¤ëŸ¬
                    navigator.mediaSession.setActionHandler('play', () => {
                        if (currentAudio) {
                            currentAudio.play();
                            updatePlayButtonIcon(false); // ì¬ìƒ ì¤‘
                        }
                    });

                    navigator.mediaSession.setActionHandler('pause', () => {
                        if (currentAudio) {
                            currentAudio.pause();
                            updatePlayButtonIcon(true); // ì¼ì‹œì •ì§€
                        }
                    });

                    // ì´ì „ íŠ¸ë™ ë²„íŠ¼ í•¸ë“¤ëŸ¬
                    navigator.mediaSession.setActionHandler('previoustrack', () => {
                        console.log('ë¸”ë£¨íˆ¬ìŠ¤ ì´ì „ íŠ¸ë™ ë²„íŠ¼ í´ë¦­');
                        playPreviousMusic();
                    });

                    // ë‹¤ìŒ íŠ¸ë™ ë²„íŠ¼ í•¸ë“¤ëŸ¬
                    navigator.mediaSession.setActionHandler('nexttrack', () => {
                        console.log('ë¸”ë£¨íˆ¬ìŠ¤ ë‹¤ìŒ íŠ¸ë™ ë²„íŠ¼ í´ë¦­');
                        playNextMusic();
                    });

                    console.log('Media Session API ì„¤ì • ì™„ë£Œ - ë¸”ë£¨íˆ¬ìŠ¤ ì»¨íŠ¸ë¡¤ ì—°ë™ë¨');
                } catch (error) {
                    console.warn('Media Session API ì„¤ì • ì‹¤íŒ¨:', error);
                }
            } else {
                console.log('Media Session API ë¯¸ì§€ì› ë¸Œë¼ìš°ì €');
            }
        }

        // ì¬ìƒ ë²„íŠ¼ ì•„ì´ì½˜ ì—…ë°ì´íŠ¸ í—¬í¼ í•¨ìˆ˜
        function updatePlayButtonIcon(isPaused) {
            const mobileButton = document.getElementById('mobile-play-btn');
            if (mobileButton) {
                const icon = isPaused ?
                    `<svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M8 5v14l11-7z"/>
                    </svg>` :
                    `<svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                    </svg>`;
                mobileButton.innerHTML = icon;
            }
        }

        // **ìˆ˜ì •ëœ ë¶€ë¶„: togglePlay í•¨ìˆ˜ì— images ë§¤ê°œë³€ìˆ˜ ì¶”ê°€ ë° showGallery í˜¸ì¶œ ë¡œì§ ì¶”ê°€**
        function togglePlay(musicId, audioSrc, images) {
            // ì¹´í…Œê³ ë¦¬ ê°„ ì´ë™ì„ ìœ„í•´ ì „ì²´ ë°ì´í„°(allMusicData) ì‚¬ìš©
            const musicList = (isShowingLiked || isShowingSaved) ? mySavedMusic : (allMusicData || mySunoMusic);
            currentMusicIndex = musicList.findIndex(music => (music.musicId || music.id) === musicId);
            if (currentMusicIndex === -1) {
                console.error("ìŒì›ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                console.log('ì°¾ìœ¼ë ¤ëŠ” musicId:', musicId);
                console.log('musicList ê¸¸ì´:', musicList.length);
                return;
            }

            const audio = new Audio(audioSrc);
            const button = document.querySelector(`.music-card[data-music-id="${musicId}"] .play-button`);

            if (currentAudio && currentAudio.src === audio.src) {
                const mobileButton = document.getElementById('mobile-play-btn');
                const audioTimer = document.getElementById('audio-timer');

                if (currentAudio.paused) {
                    currentAudio.play();
                    if (button) {
                        button.innerHTML = `
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                            </svg>
                        `;
                    }
                    if (mobileButton) {
                        mobileButton.innerHTML = `
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                            </svg>
                        `;
                    }
                    // ì¬ìƒ ì‹œ íƒ€ì´ë¨¸ í‘œì‹œ (í¬ë¦¬ì—ì´í„°/ê´€ë¦¬ìë§Œ)
                    if (audioTimer && (userRole === 'creator' || userRole === 'admin')) {
                        audioTimer.style.display = 'block';
                    }
                    // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œì—ì„œë§Œ ì „ì²´í™”ë©´ ì „í™˜
                    const isMobile = window.innerWidth <= 768;
                    const isPortrait = window.innerHeight > window.innerWidth;
                    if (isMobile && isPortrait && !isMobilePortraitMode) {
                        enableMobilePortraitMode();
                    }
                } else {
                    currentAudio.pause();
                    if (button) {
                        button.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    `;
                    }
                    if (mobileButton) {
                        mobileButton.innerHTML = `
                            <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        `;
                    }
                    // ì¼ì‹œì •ì§€ ì‹œì—ë„ íƒ€ì´ë¨¸ ìœ ì§€ (ìˆ¨ê¸°ì§€ ì•ŠìŒ)
                }
                return;
            }

            if (currentAudio) {
                currentAudio.pause();
                const prevButton = document.querySelector(`.music-card[data-music-id="${currentAudio.id.replace('audio-', '')}"] .play-button`);
                if(prevButton) {
                    prevButton.innerHTML = `
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                            <path d="M8 5v14l11-7z"/>
                        </svg>
                    `;
                }
            }

            currentAudio = audio;
            currentAudio.id = `audio-${musicId}`;

            // ì˜¤ë””ì˜¤ ì—ëŸ¬ ì²˜ë¦¬
            currentAudio.addEventListener('error', (e) => {
                console.error('ì˜¤ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜:', e);
                // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ê³„ì† ì§„í–‰ (ìºì‹œ ì—ëŸ¬ëŠ” ë¬´ì‹œ)
            });

            // ì‹œê°„ í¬ë§· í•¨ìˆ˜
            function formatTime(seconds) {
                if (!isFinite(seconds) || isNaN(seconds)) return '0:00';
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs.toString().padStart(2, '0')}`;
            }

            // ì˜¤ë””ì˜¤ íƒ€ì´ë¨¸ í‘œì‹œ
            const audioTimer = document.getElementById('audio-timer');
            const currentTimeDisplay = document.getElementById('audio-current-time');
            const durationDisplay = document.getElementById('audio-duration');

            // ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹œ ì´ ì¬ìƒ ì‹œê°„ í‘œì‹œ
            currentAudio.addEventListener('loadedmetadata', () => {
                if (durationDisplay) {
                    durationDisplay.textContent = formatTime(currentAudio.duration);
                }
                // í¬ë¦¬ì—ì´í„°/ê´€ë¦¬ìë§Œ íƒ€ì´ë¨¸ í‘œì‹œ
                if (audioTimer && (userRole === 'creator' || userRole === 'admin')) {
                    audioTimer.style.display = 'block';
                }
            });

            // ì¬ìƒ ì‹œê°„ ì—…ë°ì´íŠ¸
            currentAudio.addEventListener('timeupdate', () => {
                if (currentTimeDisplay) {
                    currentTimeDisplay.textContent = formatTime(currentAudio.currentTime);
                }
            });

            // ì¬ìƒ ì¢…ë£Œ ì‹œ íƒ€ì´ë¨¸ ìˆ¨ê¹€
            currentAudio.addEventListener('ended', () => {
                if (audioTimer) {
                    audioTimer.style.display = 'none';
                }
            });

            // ì¼ì‹œì •ì§€ ì‹œ íƒ€ì´ë¨¸ ìœ ì§€ (ìˆ¨ê¸°ì§€ ì•ŠìŒ)

            currentAudio.play().catch(error => {
                console.warn('ì˜¤ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜ (ë¬´ì‹œí•˜ê³  ê³„ì†):', error);
                // ìë™ ì¬ìƒ ì •ì±… ë“±ìœ¼ë¡œ ì¸í•œ ì˜¤ë¥˜ëŠ” ë¬´ì‹œ
            });

            // Media Session API ì—…ë°ì´íŠ¸ (ë¸”ë£¨íˆ¬ìŠ¤ ì»¨íŠ¸ë¡¤ ë©”íƒ€ë°ì´í„° ê°±ì‹ )
            setupMediaSession();

            if (button) {
                button.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                    </svg>
                `;
            }

            // ëª¨ë°”ì¼ ë²„íŠ¼ë„ ì—…ë°ì´íŠ¸
            const mobileButton = document.getElementById('mobile-play-btn');
            if (mobileButton) {
                mobileButton.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="white">
                        <path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/>
                    </svg>
                `;
            }

            // ğŸµ ìˆ˜ì •ëœ ë¶€ë¶„ ì‹œì‘: ì¢‹ì•„ìš” ëª©ë¡ì—ì„œ ì¬ìƒ ì‹œ ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
            let imagesToShow;
            if (isShowingLiked) {
                const fullMusicItem = allMusicData.find(music => music.id === musicId);
                imagesToShow = fullMusicItem ? fullMusicItem.images : [images]; // imagesëŠ” í˜„ì¬ ì¢‹ì•„ìš”í•œ ì´ë¯¸ì§€
            } else {
                imagesToShow = images; // 'ì „ì²´ ëª©ë¡'ì¼ ë•ŒëŠ” ê¸°ì¡´ ë¡œì§ ìœ ì§€
            }
            // ğŸµ ìˆ˜ì •ëœ ë¶€ë¶„ ë

            // í˜„ì¬ ìŒì› ì •ë³´ì™€ í•¨ê»˜ ê°¤ëŸ¬ë¦¬ í‘œì‹œ
            const currentMusic = musicList[currentMusicIndex];
            showGalleryWithIndex(musicId, imagesToShow, 0, audioSrc, currentMusic.name || currentMusic.title, currentMusic.creator_name);

            // ì¬ìƒ ì¤‘ì¸ ê°¤ëŸ¬ë¦¬ ê°•ì¡° í‘œì‹œ (ì¢Œì¸¡ íŒ¨ë„ ë™ê¸°í™”)
            updatePlayingHighlight(musicId, currentMusic.category);

            // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œì—ì„œë§Œ ê³¡ ì¬ìƒ ì‹œ ìë™ìœ¼ë¡œ ì „ì²´í™”ë©´ ì „í™˜
            const isMobile = window.innerWidth <= 768;
            const isPortrait = window.innerHeight > window.innerWidth;
            if (isMobile && isPortrait && !isMobilePortraitMode) {
                enableMobilePortraitMode();
            }

            // ëª¨ë“  ì‚¬ìš©ìì—ê²Œ ìŒì•… ì¢…ë£Œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€ (íšŒì›ë§Œ ì¹´í…Œê³ ë¦¬ ë‚´ ìë™ ì¬ìƒ)
            currentAudio.addEventListener('ended', playNextMusic);

            // ë¹„íšŒì›ì—ê²Œ ìë™ ì¬ìƒ ì œí•œ ì•ˆë‚´ (ì²« ì¬ìƒ ì‹œì—ë§Œ)
            if (!userName && !userRole) {
                // ê°¤ëŸ¬ë¦¬ì— ë©”ì‹œì§€ í‘œì‹œ
                setTimeout(() => {
                    showGalleryMessage('ë¹„íšŒì›ì€ ìë™ ì¬ìƒì´ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 2000);
                }, 1000);
            }
        }

        // ì¬ìƒ ì¤‘ì¸ ê°¤ëŸ¬ë¦¬ ê°•ì¡° í‘œì‹œ í•¨ìˆ˜
        function updatePlayingHighlight(musicId, musicCategory) {
            // ëª¨ë“  music-cardì—ì„œ playing í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.music-card').forEach(card => {
                card.classList.remove('playing');
            });

            // í˜„ì¬ ì¬ìƒì¤‘ì¸ ì¹´ë“œì— playing í´ë˜ìŠ¤ ì¶”ê°€
            if (musicId) {
                const playingCard = document.querySelector(`.music-card[data-music-id="${musicId}"]`);
                if (playingCard) {
                    playingCard.classList.add('playing');

                    // ì¢Œì¸¡ íŒ¨ë„ ìŠ¤í¬ë¡¤í•˜ì—¬ ì¬ìƒì¤‘ì¸ í•­ëª© ë³´ì´ê²Œ í•˜ê¸°
                    const container = document.querySelector('.music-list-container');
                    if (container && !isMobilePortraitMode) {
                        const cardTop = playingCard.offsetTop;
                        const containerHeight = container.clientHeight;
                        const scrollPosition = cardTop - (containerHeight / 2) + (playingCard.offsetHeight / 2);

                        container.scrollTo({
                            top: scrollPosition,
                            behavior: 'smooth'
                        });
                    }
                }
            }

            // ëª¨ë“  category-tabì—ì„œ has-playing í´ë˜ìŠ¤ ì œê±°
            document.querySelectorAll('.category-tab').forEach(tab => {
                tab.classList.remove('has-playing');
            });

            // í˜„ì¬ ì¬ìƒì¤‘ì¸ ìŒì•…ì˜ ì¹´í…Œê³ ë¦¬ íƒ­ì— has-playing í´ë˜ìŠ¤ ì¶”ê°€
            if (musicCategory) {
                document.querySelectorAll('.category-tab').forEach(tab => {
                    if (tab.textContent.trim() === musicCategory || tab.title === musicCategory) {
                        tab.classList.add('has-playing');
                    }
                });
            }
        }

        function playNextMusic() {
            // ë¹„íšŒì›ì¼ ë•ŒëŠ” ìë™ ì¬ìƒ ì¤‘ì§€
            if (!userName || !userRole) {
                console.log('ë¹„íšŒì› - ìë™ ì¬ìƒ ì¤‘ì§€');
                if (currentAudio) {
                    currentAudio.pause();
                    const button = document.querySelector(`.music-card[data-music-id="${currentAudio.id.replace('audio-', '')}"] .play-button`);
                    if(button) {
                        button.innerHTML = `
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                <path d="M8 5v14l11-7z"/>
                            </svg>
                        `;
                    }
                }
                return;
            }

            // ë¡œê·¸ì¸í•œ íšŒì›ë§Œ í˜„ì¬ ì¹´í…Œê³ ë¦¬ ë‚´ì—ì„œ ìë™ ì¬ìƒ
            // ì¹´í…Œê³ ë¦¬ ê°„ ì´ë™ì„ ìœ„í•´ ì „ì²´ ë°ì´í„°(allMusicData) ì‚¬ìš©
            const musicList = isShowingLiked ? mySavedMusic : (isShowingSaved ? mySavedMusic : (allMusicData || mySunoMusic));

            if (!musicList || musicList.length === 0 || currentMusicIndex < 0) {
                console.log('ì¬ìƒí•  ìŒì•…ì´ ì—†ìŒ');
                return;
            }

            const currentMusic = musicList[currentMusicIndex];
            if (!currentMusic) {
                console.log('í˜„ì¬ ìŒì•…ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }

            let nextMusic;
            let nextGlobalIndex;

            // ì¢‹ì•„ìš” ë³´ê¸° ë˜ëŠ” ëª©ë¡ ë³´ê¸° ëª¨ë“œì¼ ë•ŒëŠ” ì „ì²´ ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆœí™˜
            if (isShowingLiked || isShowingSaved) {
                nextGlobalIndex = currentMusicIndex + 1;
                if (nextGlobalIndex >= musicList.length) {
                    nextGlobalIndex = 0; // ì „ì²´ ë¦¬ìŠ¤íŠ¸ì—ì„œ ìˆœí™˜
                }
                nextMusic = musicList[nextGlobalIndex];
                currentMusicIndex = nextGlobalIndex;
            } else {
                // ì¼ë°˜ ëª¨ë“œì¼ ë•ŒëŠ” í˜„ì¬ ì¹´í…Œê³ ë¦¬ ë‚´ì˜ ìŒì•…ë“¤ë§Œ í•„í„°ë§
                const currentCategory = currentMusic.category;
                const categoryMusicList = musicList.filter(music => music.category === currentCategory);

                // ì¢Œì¸¡ íŒ¨ë„ê³¼ ë™ì¼í•œ ìˆœì„œë¡œ ì •ë ¬ (uploadedAt ë‚´ë¦¼ì°¨ìˆœ)
                categoryMusicList.sort((a, b) => {
                    const dateA = a.uploadedAt || new Date(0);
                    const dateB = b.uploadedAt || new Date(0);
                    return new Date(dateB) - new Date(dateA);
                });

                if (categoryMusicList.length === 0) {
                    console.log('ì¹´í…Œê³ ë¦¬ ë‚´ ìŒì•…ì´ ì—†ìŒ');
                    return;
                }

                // í˜„ì¬ ì¹´í…Œê³ ë¦¬ ë‚´ì—ì„œì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
                const currentCategoryIndex = categoryMusicList.findIndex(music =>
                    (music.musicId || music.id) === (currentMusic.musicId || currentMusic.id)
                );

                if (currentCategoryIndex === -1) {
                    console.log('í˜„ì¬ ìŒì•…ì˜ ì¹´í…Œê³ ë¦¬ ì¸ë±ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    return;
                }

                // ë‹¤ìŒ ê³¡ ì¸ë±ìŠ¤ ê³„ì‚°
                let nextCategoryIndex = currentCategoryIndex + 1;

                // ì¹´í…Œê³ ë¦¬ì˜ ë§ˆì§€ë§‰ ê³¡ì¸ ê²½ìš° ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™
                if (nextCategoryIndex >= categoryMusicList.length) {
                    console.log('=== ì¹´í…Œê³ ë¦¬ ë§ˆì§€ë§‰ ê³¡ - ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™ ì‹œë„ ===');

                    // ì „ì²´ ì¹´í…Œê³ ë¦¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    const allCategories = [...new Set(musicList.map(m => m.category))].filter(Boolean);
                    const currentCategoryIdx = allCategories.indexOf(currentCategory);

                    console.log('ì „ì²´ ì¹´í…Œê³ ë¦¬:', allCategories);
                    console.log('í˜„ì¬ ì¹´í…Œê³ ë¦¬:', currentCategory, 'ì¸ë±ìŠ¤:', currentCategoryIdx);

                    if (currentCategoryIdx === -1) {
                        console.log('í˜„ì¬ ì¹´í…Œê³ ë¦¬ë¥¼ ëª©ë¡ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ - í˜„ì¬ ì¹´í…Œê³ ë¦¬ ìˆœí™˜');
                        nextCategoryIndex = 0;
                    } else {
                        // ë‹¤ìŒ ì ‘ê·¼ ê°€ëŠ¥í•œ ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
                        let foundNextCategory = false;

                        // ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ë¶€í„° ìˆœì°¨ì ìœ¼ë¡œ í™•ì¸ (ìµœëŒ€ ì „ì²´ ì¹´í…Œê³ ë¦¬ ìˆ˜ë§Œí¼)
                        for (let i = 1; i < allCategories.length; i++) {
                            let nextCatIdx = (currentCategoryIdx + i) % allCategories.length;
                            const nextCategoryName = allCategories[nextCatIdx];
                            const nextCategoryDetail = allCategoryDetails.find(cat => cat.name === nextCategoryName);

                            console.log(`ì¹´í…Œê³ ë¦¬ "${nextCategoryName}" í™•ì¸ ì¤‘... (ì¸ë±ìŠ¤: ${nextCatIdx})`);

                            // ì„±ì¸ ì¹´í…Œê³ ë¦¬ì´ê³  ì„±ì¸ ì¸ì¦ì´ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
                            if (nextCategoryDetail && nextCategoryDetail.isAdult && !isAdultVerified) {
                                console.log(`-> ì„±ì¸ ì¹´í…Œê³ ë¦¬ - ê±´ë„ˆë›°ê¸° (ì„±ì¸ ì¸ì¦ í•„ìš”)`);
                                continue; // ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ í™•ì¸
                            }

                            // ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ì˜ ìŒì•… ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                            const nextCategoryMusicList = musicList.filter(music => music.category === nextCategoryName);

                            // ì¢Œì¸¡ íŒ¨ë„ê³¼ ë™ì¼í•œ ìˆœì„œë¡œ ì •ë ¬ (uploadedAt ë‚´ë¦¼ì°¨ìˆœ)
                            nextCategoryMusicList.sort((a, b) => {
                                const dateA = a.uploadedAt || new Date(0);
                                const dateB = b.uploadedAt || new Date(0);
                                return new Date(dateB) - new Date(dateA);
                            });

                            if (nextCategoryMusicList.length === 0) {
                                console.log(`-> ì¹´í…Œê³ ë¦¬ì— ìŒì•…ì´ ì—†ìŒ - ê±´ë„ˆë›°ê¸°`);
                                continue; // ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ í™•ì¸
                            }

                            // ì ‘ê·¼ ê°€ëŠ¥í•œ ì¹´í…Œê³ ë¦¬ ë°œê²¬!
                            console.log(`-> ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™: "${nextCategoryName}" (${nextCategoryMusicList.length}ê³¡)`);
                            console.log('ì „ì²´ musicList í¬ê¸°:', musicList.length);
                            console.log('ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ ì²« ë²ˆì§¸ ê°¤ëŸ¬ë¦¬:', nextCategoryMusicList[0]);
                            nextMusic = nextCategoryMusicList[0];
                            foundNextCategory = true;

                            // ì „ì²´ ëª©ë¡ì—ì„œì˜ ì‹¤ì œ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
                            nextGlobalIndex = musicList.findIndex(music =>
                                (music.musicId || music.id) === (nextMusic.musicId || nextMusic.id)
                            );

                            if (nextGlobalIndex !== -1) {
                                currentMusicIndex = nextGlobalIndex;
                            }
                            break; // ì°¾ì•˜ìœ¼ë¯€ë¡œ ë£¨í”„ ì¢…ë£Œ
                        }

                        // ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ë¥¼ ëª» ì°¾ì€ ê²½ìš° í˜„ì¬ ì¹´í…Œê³ ë¦¬ ìˆœí™˜
                        if (!foundNextCategory) {
                            console.log('ì ‘ê·¼ ê°€ëŠ¥í•œ ë‹¤ìŒ ì¹´í…Œê³ ë¦¬ ì—†ìŒ - í˜„ì¬ ì¹´í…Œê³ ë¦¬ ìˆœí™˜');
                            nextCategoryIndex = 0;
                        }
                    }
                }

                // nextMusicì´ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ë‹¤ë©´ í˜„ì¬ ì¹´í…Œê³ ë¦¬ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                if (!nextMusic) {
                    nextMusic = categoryMusicList[nextCategoryIndex];

                    if (!nextMusic) {
                        console.log('ë‹¤ìŒ ìŒì•…ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                        return;
                    }

                    // ì „ì²´ ëª©ë¡ì—ì„œì˜ ì‹¤ì œ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
                    nextGlobalIndex = musicList.findIndex(music =>
                        (music.musicId || music.id) === (nextMusic.musicId || nextMusic.id)
                    );

                    if (nextGlobalIndex !== -1) {
                        currentMusicIndex = nextGlobalIndex;
                    }
                }
            }

            if (!nextMusic) {
                console.log('ë‹¤ìŒ ìŒì•…ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }

            // ì´ì „ ìŒì•…ì˜ ì¬ìƒ ë²„íŠ¼ ì•„ì´ì½˜ì„ ì •ì§€ ìƒíƒœë¡œ ë³€ê²½
            const prevButton = document.querySelector(`.music-card[data-music-id="${currentMusic.musicId || currentMusic.id}"] .play-button`);
            if (prevButton) {
                prevButton.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                `;
            }

            if (isShowingLiked || isShowingSaved) {
                console.log(`ë¦¬ìŠ¤íŠ¸ ë‚´ì—ì„œ ìë™ ì¬ìƒ:`, nextMusic.name || nextMusic.title);
            } else {
                console.log(`ì¹´í…Œê³ ë¦¬ ${currentMusic.category} ë‚´ì—ì„œ ìë™ ì¬ìƒ:`, nextMusic.name || nextMusic.title);
            }

            let imagesToShow;
            if (isShowingLiked) {
                const fullMusicItem = allMusicData.find(music => music.id === nextMusic.musicId);
                imagesToShow = fullMusicItem ? fullMusicItem.images : [nextMusic];
            } else {
                imagesToShow = nextMusic.images; // ì¼ë°˜ ëª¨ë“œ ë° ì €ì¥ ëª©ë¡
            }

            togglePlay(nextMusic.musicId || nextMusic.id, nextMusic.audioSrc, imagesToShow);
        }

        // ì´ì „ ê°¤ëŸ¬ë¦¬ë¡œ ì´ë™í•˜ëŠ” í•¨ìˆ˜
        function playPreviousMusic() {
            // ë¹„íšŒì›ì¼ ë•ŒëŠ” ìë™ ì¬ìƒ ì¤‘ì§€
            if (!userName || !userRole) {
                console.log('ë¹„íšŒì› - ì´ì „ ê°¤ëŸ¬ë¦¬ ì´ë™ ë¶ˆê°€');
                return;
            }

            // ì¹´í…Œê³ ë¦¬ ê°„ ì´ë™ì„ ìœ„í•´ ì „ì²´ ë°ì´í„°(allMusicData) ì‚¬ìš©
            const musicList = isShowingLiked ? mySavedMusic : (isShowingSaved ? mySavedMusic : (allMusicData || mySunoMusic));

            if (!musicList || musicList.length === 0 || currentMusicIndex < 0) {
                console.log('ì¬ìƒí•  ìŒì•…ì´ ì—†ìŒ');
                return;
            }

            const currentMusic = musicList[currentMusicIndex];
            if (!currentMusic) {
                console.log('í˜„ì¬ ìŒì•…ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }

            let prevMusic;
            let prevGlobalIndex;

            // ì¢‹ì•„ìš” ë³´ê¸° ë˜ëŠ” ëª©ë¡ ë³´ê¸° ëª¨ë“œì¼ ë•ŒëŠ” ì „ì²´ ë¦¬ìŠ¤íŠ¸ë¥¼ ìˆœí™˜
            if (isShowingLiked || isShowingSaved) {
                prevGlobalIndex = currentMusicIndex - 1;
                if (prevGlobalIndex < 0) {
                    prevGlobalIndex = musicList.length - 1; // ì „ì²´ ë¦¬ìŠ¤íŠ¸ì—ì„œ ì—­ìˆœí™˜
                }
                prevMusic = musicList[prevGlobalIndex];
                currentMusicIndex = prevGlobalIndex;
            } else {
                // ì¼ë°˜ ëª¨ë“œì¼ ë•ŒëŠ” í˜„ì¬ ì¹´í…Œê³ ë¦¬ ë‚´ì˜ ìŒì•…ë“¤ë§Œ í•„í„°ë§
                const currentCategory = currentMusic.category;
                const categoryMusicList = musicList.filter(music => music.category === currentCategory);

                // ì¢Œì¸¡ íŒ¨ë„ê³¼ ë™ì¼í•œ ìˆœì„œë¡œ ì •ë ¬ (uploadedAt ë‚´ë¦¼ì°¨ìˆœ)
                categoryMusicList.sort((a, b) => {
                    const dateA = a.uploadedAt || new Date(0);
                    const dateB = b.uploadedAt || new Date(0);
                    return new Date(dateB) - new Date(dateA);
                });

                if (categoryMusicList.length === 0) {
                    console.log('ì¹´í…Œê³ ë¦¬ ë‚´ ìŒì•…ì´ ì—†ìŒ');
                    return;
                }

                // í˜„ì¬ ì¹´í…Œê³ ë¦¬ ë‚´ì—ì„œì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
                const currentCategoryIndex = categoryMusicList.findIndex(music =>
                    (music.musicId || music.id) === (currentMusic.musicId || currentMusic.id)
                );

                if (currentCategoryIndex === -1) {
                    console.log('í˜„ì¬ ìŒì•…ì˜ ì¹´í…Œê³ ë¦¬ ì¸ë±ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                    return;
                }

                // ì´ì „ ê³¡ ì¸ë±ìŠ¤ ê³„ì‚°
                let prevCategoryIndex = currentCategoryIndex - 1;

                // ì¹´í…Œê³ ë¦¬ì˜ ì²« ë²ˆì§¸ ê³¡ì¸ ê²½ìš° ì´ì „ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™
                if (prevCategoryIndex < 0) {
                    console.log('=== ì¹´í…Œê³ ë¦¬ ì²« ë²ˆì§¸ ê³¡ - ì´ì „ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™ ì‹œë„ ===');

                    // ì „ì²´ ì¹´í…Œê³ ë¦¬ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                    const allCategories = [...new Set(musicList.map(m => m.category))].filter(Boolean);
                    const currentCategoryIdx = allCategories.indexOf(currentCategory);

                    console.log('ì „ì²´ ì¹´í…Œê³ ë¦¬:', allCategories);
                    console.log('í˜„ì¬ ì¹´í…Œê³ ë¦¬:', currentCategory, 'ì¸ë±ìŠ¤:', currentCategoryIdx);

                    if (currentCategoryIdx === -1) {
                        console.log('í˜„ì¬ ì¹´í…Œê³ ë¦¬ë¥¼ ëª©ë¡ì—ì„œ ì°¾ì„ ìˆ˜ ì—†ìŒ - í˜„ì¬ ì¹´í…Œê³ ë¦¬ ë§ˆì§€ë§‰ ê³¡');
                        prevCategoryIndex = categoryMusicList.length - 1;
                    } else {
                        // ì´ì „ ì ‘ê·¼ ê°€ëŠ¥í•œ ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
                        let foundPrevCategory = false;

                        // ì´ì „ ì¹´í…Œê³ ë¦¬ë¶€í„° ì—­ìˆœìœ¼ë¡œ í™•ì¸
                        for (let i = 1; i < allCategories.length; i++) {
                            let prevCatIdx = (currentCategoryIdx - i + allCategories.length) % allCategories.length;
                            const prevCategoryName = allCategories[prevCatIdx];
                            const prevCategoryDetail = allCategoryDetails.find(cat => cat.name === prevCategoryName);

                            console.log(`ì¹´í…Œê³ ë¦¬ "${prevCategoryName}" í™•ì¸ ì¤‘... (ì¸ë±ìŠ¤: ${prevCatIdx})`);

                            // ì„±ì¸ ì¹´í…Œê³ ë¦¬ì´ê³  ì„±ì¸ ì¸ì¦ì´ ì•ˆ ë˜ì–´ ìˆìœ¼ë©´ ê±´ë„ˆë›°ê¸°
                            if (prevCategoryDetail && prevCategoryDetail.isAdult && !isAdultVerified) {
                                console.log(`-> ì„±ì¸ ì¹´í…Œê³ ë¦¬ - ê±´ë„ˆë›°ê¸° (ì„±ì¸ ì¸ì¦ í•„ìš”)`);
                                continue;
                            }

                            // ì´ì „ ì¹´í…Œê³ ë¦¬ì˜ ìŒì•… ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                            const prevCategoryMusicList = musicList.filter(music => music.category === prevCategoryName);

                            // ì¢Œì¸¡ íŒ¨ë„ê³¼ ë™ì¼í•œ ìˆœì„œë¡œ ì •ë ¬ (uploadedAt ë‚´ë¦¼ì°¨ìˆœ)
                            prevCategoryMusicList.sort((a, b) => {
                                const dateA = a.uploadedAt || new Date(0);
                                const dateB = b.uploadedAt || new Date(0);
                                return new Date(dateB) - new Date(dateA);
                            });

                            if (prevCategoryMusicList.length === 0) {
                                console.log(`-> ì¹´í…Œê³ ë¦¬ì— ìŒì•…ì´ ì—†ìŒ - ê±´ë„ˆë›°ê¸°`);
                                continue;
                            }

                            // ì ‘ê·¼ ê°€ëŠ¥í•œ ì¹´í…Œê³ ë¦¬ ë°œê²¬! í•´ë‹¹ ì¹´í…Œê³ ë¦¬ì˜ ë§ˆì§€ë§‰ ê³¡ ì„ íƒ
                            console.log(`-> ì´ì „ ì¹´í…Œê³ ë¦¬ë¡œ ì´ë™: "${prevCategoryName}" (${prevCategoryMusicList.length}ê³¡)`);
                            console.log('ì „ì²´ musicList í¬ê¸°:', musicList.length);
                            console.log('ì´ì „ ì¹´í…Œê³ ë¦¬ ë§ˆì§€ë§‰ ê°¤ëŸ¬ë¦¬:', prevCategoryMusicList[prevCategoryMusicList.length - 1]);
                            prevMusic = prevCategoryMusicList[prevCategoryMusicList.length - 1]; // ë§ˆì§€ë§‰ ê³¡
                            foundPrevCategory = true;

                            // ì „ì²´ ëª©ë¡ì—ì„œì˜ ì‹¤ì œ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
                            prevGlobalIndex = musicList.findIndex(music =>
                                (music.musicId || music.id) === (prevMusic.musicId || prevMusic.id)
                            );

                            if (prevGlobalIndex !== -1) {
                                currentMusicIndex = prevGlobalIndex;
                            }
                            break;
                        }

                        // ì´ì „ ì¹´í…Œê³ ë¦¬ë¥¼ ëª» ì°¾ì€ ê²½ìš° í˜„ì¬ ì¹´í…Œê³ ë¦¬ ë§ˆì§€ë§‰ ê³¡
                        if (!foundPrevCategory) {
                            console.log('ì ‘ê·¼ ê°€ëŠ¥í•œ ì´ì „ ì¹´í…Œê³ ë¦¬ ì—†ìŒ - í˜„ì¬ ì¹´í…Œê³ ë¦¬ ë§ˆì§€ë§‰ ê³¡');
                            prevCategoryIndex = categoryMusicList.length - 1;
                        }
                    }
                }

                // prevMusicì´ ì•„ì§ ì„¤ì •ë˜ì§€ ì•Šì•˜ë‹¤ë©´ í˜„ì¬ ì¹´í…Œê³ ë¦¬ì—ì„œ ê°€ì ¸ì˜¤ê¸°
                if (!prevMusic) {
                    prevMusic = categoryMusicList[prevCategoryIndex];

                    if (!prevMusic) {
                        console.log('ì´ì „ ìŒì•…ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                        return;
                    }

                    // ì „ì²´ ëª©ë¡ì—ì„œì˜ ì‹¤ì œ ì¸ë±ìŠ¤ ì—…ë°ì´íŠ¸
                    prevGlobalIndex = musicList.findIndex(music =>
                        (music.musicId || music.id) === (prevMusic.musicId || prevMusic.id)
                    );

                    if (prevGlobalIndex !== -1) {
                        currentMusicIndex = prevGlobalIndex;
                    }
                }
            }

            if (!prevMusic) {
                console.log('ì´ì „ ìŒì•…ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ');
                return;
            }

            // í˜„ì¬ ìŒì•…ì˜ ì¬ìƒ ë²„íŠ¼ ì•„ì´ì½˜ì„ ì •ì§€ ìƒíƒœë¡œ ë³€ê²½
            const currButton = document.querySelector(`.music-card[data-music-id="${currentMusic.musicId || currentMusic.id}"] .play-button`);
            if (currButton) {
                currButton.innerHTML = `
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M8 5v14l11-7z"/>
                    </svg>
                `;
            }

            if (isShowingLiked || isShowingSaved) {
                console.log(`ë¦¬ìŠ¤íŠ¸ ë‚´ì—ì„œ ì´ì „ ê°¤ëŸ¬ë¦¬ ì¬ìƒ:`, prevMusic.name || prevMusic.title);
            } else {
                console.log(`ì¹´í…Œê³ ë¦¬ ${currentMusic.category} ë‚´ì—ì„œ ì´ì „ ê°¤ëŸ¬ë¦¬ ì¬ìƒ:`, prevMusic.name || prevMusic.title);
            }

            let imagesToShow;
            if (isShowingLiked) {
                const fullMusicItem = allMusicData.find(music => music.id === prevMusic.musicId);
                imagesToShow = fullMusicItem ? fullMusicItem.images : [prevMusic];
            } else {
                imagesToShow = prevMusic.images;
            }

            togglePlay(prevMusic.musicId || prevMusic.id, prevMusic.audioSrc, imagesToShow);
        }

        // playMusicById í•¨ìˆ˜ ì¶”ê°€ (í˜¸í™˜ì„±ì„ ìœ„í•´)
        function playMusicById(musicId, audioSrc, name) {
            // ê¸°ì¡´ togglePlay í•¨ìˆ˜ë¥¼ í˜¸ì¶œí•˜ì—¬ í˜¸í™˜ì„± ìœ ì§€
            // ì¹´í…Œê³ ë¦¬ ê°„ ì´ë™ì„ ìœ„í•´ ì „ì²´ ë°ì´í„°(allMusicData) ì‚¬ìš©
            const musicList = isShowingLiked ? mySavedMusic : (allMusicData || mySunoMusic);
            const music = musicList.find(m => (m.musicId || m.id) === musicId);
            const images = music ? (music.images || []) : [];
            togglePlay(musicId, audioSrc, images);
        }

        // ì´ë¯¸ì§€ ìˆœì„œ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateImageOrderDisplay() {
            const orderDisplays = document.querySelectorAll('.image-order-display');
            const galleryItems = document.querySelectorAll('#image-gallery .gallery-item');
            const reorderInputs = document.querySelectorAll('.reorder-input');

            orderDisplays.forEach((display, index) => {
                const galleryItem = galleryItems[index];
                if (galleryItem && galleryItem.classList.contains('active')) {
                    display.style.background = 'rgba(255,215,0,0.9)'; // í™œì„± ì´ë¯¸ì§€ëŠ” ê¸ˆìƒ‰
                    display.style.color = 'black';

                    // í˜„ì¬ í™œì„± ì´ë¯¸ì§€ì˜ ìˆœì„œ ì…ë ¥ í•„ë“œ ì—…ë°ì´íŠ¸
                    if (reorderInputs[index]) {
                        reorderInputs[index].value = currentImageIndex + 1;
                    }
                } else {
                    display.style.background = 'rgba(0,0,0,0.8)';
                    display.style.color = 'white';
                }
            });

            // ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
            const navButtons = document.querySelectorAll('.nav-button');
            navButtons.forEach((button, buttonIndex) => {
                const isEven = buttonIndex % 2 === 0; // ì§ìˆ˜ ì¸ë±ìŠ¤ëŠ” ì´ì „ ë²„íŠ¼, í™€ìˆ˜ëŠ” ë‹¤ìŒ ë²„íŠ¼
                const imageIndex = Math.floor(buttonIndex / 2);
                const galleryItem = galleryItems[imageIndex];

                if (galleryItem && galleryItem.classList.contains('active')) {
                    if (isEven) { // ì´ì „ ë²„íŠ¼
                        button.disabled = currentImageIndex === 0;
                    } else { // ë‹¤ìŒ ë²„íŠ¼
                        button.disabled = currentImageIndex === galleryItems.length - 1;
                    }

                    if (button.disabled) {
                        button.style.opacity = '0.5';
                        button.style.cursor = 'not-allowed';
                    } else {
                        button.style.opacity = '1';
                        button.style.cursor = 'pointer';
                    }
                }
            });
        }

        // ğŸ”§ ê¸°ì¡´ showGallery í•¨ìˆ˜ë¥¼ ìƒˆë¡œìš´ í•¨ìˆ˜ë¥¼ ì‚¬ìš©í•˜ë„ë¡ ìˆ˜ì •
        function showGallery(musicId, images) {
            showGalleryWithIndex(musicId, images, 0);
        }

        // íŠ¹ì • ì¸ë±ìŠ¤ë¡œ ê°¤ëŸ¬ë¦¬ë¥¼ í‘œì‹œí•˜ëŠ” í•¨ìˆ˜
        function showGalleryWithIndex(musicId, images, startIndex = 0, audioSrc = null, title = null, creator = null) {
            // í˜„ì¬ ì„ íƒëœ ê°¤ëŸ¬ë¦¬ì˜ ì¹´í…Œê³ ë¦¬ í™•ì¸ (ì¢‹ì•„ìš”/ì €ì¥ ëª©ë¡ë„ ê³ ë ¤)
            const musicList = (isShowingLiked || isShowingSaved) ? mySavedMusic : mySunoMusic;
            let currentMusic = musicList.find(music => (music.musicId || music.id) === musicId);

            // í˜„ì¬ ëª©ë¡ì—ì„œ ì°¾ì§€ ëª»í•˜ë©´ allMusicDataì—ì„œ ì°¾ê¸°
            if (!currentMusic && allMusicData) {
                currentMusic = allMusicData.find(music => (music.musicId || music.id) === musicId);
            }

            console.log('showGalleryWithIndex í˜¸ì¶œ:', {
                musicId,
                foundInList: !!currentMusic,
                category: currentMusic?.category,
                isShowingLiked,
                isShowingSaved
            });

            const isGlossGazeOrKawai = currentMusic && (
                currentMusic.category === 'Gloss & Gaze' ||
                currentMusic.category === 'Kawai' ||
                currentMusic.category === 'Kawaii' ||
                currentMusic.category === 'KAWAI'
            );

            // Gloss & Gazeë‚˜ Kawai ì¹´í…Œê³ ë¦¬ì¸ ê²½ìš° í¬ì¸íŠ¸ ì°¨ê° ì—†ì´ ë°”ë¡œ ê°¤ëŸ¬ë¦¬ í‘œì‹œ
            if (isGlossGazeOrKawai) {
                console.log('Gloss & Gaze ë˜ëŠ” Kawai ì¹´í…Œê³ ë¦¬ - ë¬´ë£Œ');
                displayGallery();
                return;
            }

            // í¬ì¸íŠ¸ ì°¨ê° ì—¬ë¶€ í™•ì¸ ë¡œì§
            const shouldDeductPoints = userName && shouldChargePointsForGallery(musicId, currentMusic);
            console.log('í¬ì¸íŠ¸ ì°¨ê° ì—¬ë¶€:', {userName, shouldDeductPoints});

            if (shouldDeductPoints) {
                usePoints().then(pointsUsed => {
                    if (!pointsUsed) {
                        // í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•˜ë©´ ê°¤ëŸ¬ë¦¬ë¥¼ ì—´ì§€ ì•ŠìŒ
                        return;
                    }
                    // í¬ì¸íŠ¸ ì°¨ê° ì„±ê³µ ì‹œ ê°¤ëŸ¬ë¦¬ í‘œì‹œ ë° ì‹œì²­ ê¸°ë¡
                    markGalleryAsViewed(musicId);
                    displayGallery();
                }).catch(error => {
                    console.error('í¬ì¸íŠ¸ ì°¨ê° ì¤‘ ì˜¤ë¥˜:', error);
                    return;
                });
            } else {
                // í¬ì¸íŠ¸ ì°¨ê° ì—†ì´ ë°”ë¡œ ê°¤ëŸ¬ë¦¬ í‘œì‹œ (í•˜ì§€ë§Œ ì‹œì²­ ê¸°ë¡ì€ ë‚¨ê¹€)
                if (userName) {
                    markGalleryAsViewed(musicId);
                }
                displayGallery();
            }

            function displayGallery() {

            const galleryWrapper = document.getElementById('gallery-wrapper');
            const imageGallery = document.getElementById('image-gallery');
            const placeholder = document.getElementById('gallery-placeholder');

            // ìš°ì„ ìˆœìœ„: 1. ê°¤ëŸ¬ë¦¬ë³„ ì„¤ì • > 2. Portrait ì¹´í…Œê³ ë¦¬ > 3. ì‚¬ìš©ì ì„¤ì • > 4. ê¸°ë³¸ê°’ 3ì´ˆ
            // (ì™¸ë¶€ì—ì„œ ì´ë¯¸ ì°¾ì€ currentMusic ì‚¬ìš©)
            if (currentMusic && currentMusic.autoplayTiming) {
                // ê°¤ëŸ¬ë¦¬ë³„ë¡œ ì„¤ì •ëœ ìë™ì „í™˜ ì‹œê°„ì´ ìˆìœ¼ë©´ ìš°ì„  ì ìš©
                const galleryTiming = parseInt(currentMusic.autoplayTiming);
                if (!isNaN(galleryTiming) && galleryTiming >= 1 && galleryTiming <= 60) {
                    currentAutoplayTiming = galleryTiming * 1000;
                    console.log(`ê°¤ëŸ¬ë¦¬ ì„¤ì • ìë™ì „í™˜ ì‹œê°„: ${galleryTiming}ì´ˆ`);
                } else {
                    currentAutoplayTiming = 3000;
                }
            } else if (currentMusic && currentMusic.category === 'Portrait') {
                // Portrait ì¹´í…Œê³ ë¦¬ëŠ” 5ì´ˆ ê¸°ë³¸ê°’
                currentAutoplayTiming = 5000;
                console.log('Portrait ì¹´í…Œê³ ë¦¬ ê¸°ë³¸ê°’: 5ì´ˆ');
            } else {
                // ì‚¬ìš©ìê°€ ì„¤ì •í•œ ê°’ì´ ìˆìœ¼ë©´ ê·¸ ê°’ì„ ì‚¬ìš©, ì—†ìœ¼ë©´ 3ì´ˆ
                const autoplayTimingInput = document.getElementById('autoplay-timing-input');
                if (autoplayTimingInput && autoplayTimingInput.value) {
                    const userTiming = parseInt(autoplayTimingInput.value, 10);
                    if (!isNaN(userTiming) && userTiming >= 1 && userTiming <= 60) {
                        currentAutoplayTiming = userTiming * 1000;
                        console.log(`ì‚¬ìš©ì ì„¤ì • ìë™ì „í™˜ ì‹œê°„: ${userTiming}ì´ˆ`);
                    } else {
                        currentAutoplayTiming = 3000;
                    }
                } else {
                    currentAutoplayTiming = 3000;
                    console.log('ê¸°ë³¸ ìë™ì „í™˜ ì‹œê°„: 3ì´ˆ');
                }
            }

            // ì´ë¯¸ì§€ì— IDê°€ ì—†ìœ¼ë©´ ìƒì„±
            const imagesWithIds = images.map((img, idx) => ({
                ...img,
                id: img.id || `${musicId}_${idx}`
            }));

            // í˜„ì¬ ê°¤ëŸ¬ë¦¬ ì •ë³´ ì €ì¥
            currentGalleryInfo = {
                musicId: musicId,
                audioSrc: audioSrc,
                images: imagesWithIds,
                title: title,
                creator: creator
            };

            // ê°¤ëŸ¬ë¦¬ëª… ì €ì¥ (ì „ì²´ ì´ë¯¸ì§€ ìˆ˜ í¬í•¨)
            currentGalleryName = `${title || 'ê°¤ëŸ¬ë¦¬'} (${imagesWithIds.length})`;

            // ê°¤ëŸ¬ë¦¬ ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
            imageGallery.innerHTML = '';

            // ê°¤ëŸ¬ë¦¬ ë³€ê²½ ì‹œ ê°¤ëŸ¬ë¦¬ëª… í‘œì‹œ
            setTimeout(() => {
                showGalleryNameMessage();
            }, 300);

            if (images.length === 0) {
                placeholder.textContent = 'ì´ ìŒì•…ì—ëŠ” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.';
                galleryWrapper.style.display = 'none';
                placeholder.style.display = 'block';
                currentGalleryInfo = null; // ì´ë¯¸ì§€ê°€ ì—†ìœ¼ë©´ ê°¤ëŸ¬ë¦¬ ì •ë³´ ì´ˆê¸°í™”
                return;
            }

            placeholder.style.display = 'none';
            galleryWrapper.style.display = 'flex';
            galleryWrapper.classList.add('active');

            imagesWithIds.forEach((img, index) => {
                const galleryItem = document.createElement('div');
                galleryItem.className = `gallery-item${index === startIndex ? ' active' : ''}`;
                galleryItem.setAttribute('data-image-id', img.id);

                const imageElement = document.createElement('img');

                // ì´ë¯¸ì§€ ë¡œë”© ë””ë²„ê¹…
                console.log(`Loading image ${index + 1}:`, img.imageSrc);

                imageElement.src = img.imageSrc;
                imageElement.alt = `ê°¤ëŸ¬ë¦¬ ì´ë¯¸ì§€ ${index + 1}`;

                // ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ
                imageElement.addEventListener('load', () => {
                    console.log(`Image ${index + 1} loaded successfully`);
                });

                // ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨
                imageElement.addEventListener('error', (e) => {
                    console.error(`Image ${index + 1} failed to load:`, img.imageSrc);
                    console.error('Error event:', e);
                    // í”Œë ˆì´ìŠ¤í™€ë” í‘œì‹œ
                    imageElement.alt = `ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨: ${index + 1}`;
                    imageElement.style.backgroundColor = '#333';
                    imageElement.style.color = '#fff';
                    imageElement.style.display = 'flex';
                    imageElement.style.alignItems = 'center';
                    imageElement.style.justifyContent = 'center';
                });

                // ì´ë¯¸ì§€ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                imageElement.addEventListener('click', (event) => {
                    event.stopPropagation();
                    toggleImageAutoTransition();
                });

                galleryItem.appendChild(imageElement);

                if ((userRole === 'creator' || userRole === 'admin') && !isShowingLiked) {
                    const imageControlContainer = document.createElement('div');
                    imageControlContainer.className = 'image-control-container';

                    // í˜„ì¬ ì´ë¯¸ì§€ ìˆœì„œ í‘œì‹œ ì˜ì—­
                    const imageOrderDisplay = document.createElement('div');
                    imageOrderDisplay.className = 'image-order-display';
                    imageOrderDisplay.style.cssText = `
                        background: rgba(0,0,0,0.8);
                        color: white;
                        padding: 8px 12px;
                        border-radius: 20px;
                        font-size: 14px;
                        font-weight: bold;
                        margin-bottom: 10px;
                        text-align: center;
                    `;
                    imageOrderDisplay.textContent = `${index + 1} / ${images.length}`;

                    // ì´ë¯¸ì§€ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ë“¤
                    const navigationContainer = document.createElement('div');
                    navigationContainer.className = 'image-navigation-container';
                    navigationContainer.style.cssText = `
                        display: flex;
                        gap: 5px;
                        margin-bottom: 10px;
                        justify-content: center;
                    `;

                    // ì´ì „ ì´ë¯¸ì§€ ë²„íŠ¼
                    const prevButton = document.createElement('button');
                    prevButton.className = 'nav-button';
                    prevButton.innerHTML = 'â†';
                    prevButton.style.cssText = `
                        background: rgba(0,0,0,0.7);
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 35px;
                        height: 35px;
                        cursor: pointer;
                        font-size: 16px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    prevButton.disabled = index === 0;
                    if (prevButton.disabled) {
                        prevButton.style.opacity = '0.5';
                        prevButton.style.cursor = 'not-allowed';
                    }
                    prevButton.onclick = function(event) {
                        event.stopPropagation();

                        // ìë™ ì „í™˜ ì¤‘ì§€
                        if (isAutoTransitioning) {
                            isAutoTransitioning = false;
                            if (currentImageInterval) {
                                clearInterval(currentImageInterval);
                            }
                        }

                        // ì¦‰ì‹œ ì´ì „ ì´ë¯¸ì§€ë¡œ ì „í™˜
                        const items = document.querySelectorAll('#image-gallery .gallery-item');
                        if (currentImageIndex > 0) {
                            items[currentImageIndex].classList.remove('active');
                            currentImageIndex = currentImageIndex - 1;
                            items[currentImageIndex].classList.add('active');
                            updateImageOrderDisplay(); // ìˆœì„œ í‘œì‹œ ì—…ë°ì´íŠ¸
                        }
                    };

                    // ë‹¤ìŒ ì´ë¯¸ì§€ ë²„íŠ¼
                    const nextButton = document.createElement('button');
                    nextButton.className = 'nav-button';
                    nextButton.innerHTML = 'â†’';
                    nextButton.style.cssText = `
                        background: rgba(0,0,0,0.7);
                        color: white;
                        border: none;
                        border-radius: 50%;
                        width: 35px;
                        height: 35px;
                        cursor: pointer;
                        font-size: 16px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    nextButton.disabled = index === images.length - 1;
                    if (nextButton.disabled) {
                        nextButton.style.opacity = '0.5';
                        nextButton.style.cursor = 'not-allowed';
                    }
                    nextButton.onclick = function(event) {
                        event.stopPropagation();

                        // ìë™ ì „í™˜ ì¤‘ì§€
                        if (isAutoTransitioning) {
                            isAutoTransitioning = false;
                            if (currentImageInterval) {
                                clearInterval(currentImageInterval);
                            }
                        }

                        // ì¦‰ì‹œ ë‹¤ìŒ ì´ë¯¸ì§€ë¡œ ì „í™˜
                        const items = document.querySelectorAll('#image-gallery .gallery-item');
                        if (currentImageIndex < items.length - 1) {
                            items[currentImageIndex].classList.remove('active');
                            currentImageIndex = currentImageIndex + 1;
                            items[currentImageIndex].classList.add('active');
                            updateImageOrderDisplay(); // ìˆœì„œ í‘œì‹œ ì—…ë°ì´íŠ¸
                        }
                    };

                    navigationContainer.appendChild(prevButton);
                    navigationContainer.appendChild(nextButton);

                    const reorderContainer = document.createElement('div');
                    reorderContainer.className = 'reorder-input-container';

                    // í•µì‹¬ ìˆ˜ì •: ì»¨í…Œì´ë„ˆ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ì§€
                    reorderContainer.onclick = function(event) {
                        event.stopPropagation();
                    };

                    const reorderInput = document.createElement('input');
                    reorderInput.type = 'number';
                    reorderInput.className = 'reorder-input';
                    reorderInput.min = 1;
                    reorderInput.max = imagesWithIds.length;
                    reorderInput.placeholder = 'ìˆœì„œ';
                    reorderInput.value = index + 1;

                    // ì…ë ¥ í•„ë“œ í´ë¦­/í¬ì»¤ìŠ¤ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ì§€
                    reorderInput.onclick = function(event) {
                        event.stopPropagation();
                    };
                    reorderInput.onfocus = function(event) {
                        event.stopPropagation();
                    };
                    reorderInput.oninput = function(event) {
                        event.stopPropagation();
                    };

                    reorderContainer.appendChild(reorderInput);

                    const reorderButton = document.createElement('button');
                    reorderButton.className = 'reorder-button';
                    reorderButton.innerHTML = 'ë³€ê²½';
                    reorderButton.onclick = function(event) {
                        event.stopPropagation(); // ë²„íŠ¼ í´ë¦­ ì‹œ ì´ë²¤íŠ¸ ì „íŒŒ ì¤‘ì§€

                        // í˜„ì¬ í™œì„±í™”ëœ ì´ë¯¸ì§€ì˜ ID ê°€ì ¸ì˜¤ê¸°
                        const activeItem = document.querySelector('#image-gallery .gallery-item.active');
                        if (!activeItem) {
                            alert('í™œì„±í™”ëœ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                            return;
                        }

                        const currentImageId = activeItem.getAttribute('data-image-id');
                        const newOrder = parseInt(reorderInput.value);

                        if (newOrder >= 1 && newOrder <= imagesWithIds.length) {
                            reorderImageToOrder(musicId, currentImageId, newOrder, event);
                        } else {
                            alert('ìœ íš¨í•œ ìˆœì„œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” (1ë¶€í„° ' + imagesWithIds.length + 'ê¹Œì§€).');
                        }
                    };
                    reorderContainer.appendChild(reorderButton);

                    imageControlContainer.appendChild(imageOrderDisplay);
                    imageControlContainer.appendChild(navigationContainer);
                    imageControlContainer.appendChild(reorderContainer);
                    galleryItem.appendChild(imageControlContainer);
                    
                    const deleteButton = document.createElement('button');
                    deleteButton.className = 'image-delete-button';
                    deleteButton.innerHTML = 'Ã—';
                    deleteButton.onclick = function(event) {
                        deleteImage(musicId, img.id, event);
                    };
                    galleryItem.appendChild(deleteButton);
                }
                
                imageGallery.appendChild(galleryItem);
            });
            
            currentImageIndex = startIndex;
            clearInterval(currentImageInterval);

            // ìˆœì„œ í‘œì‹œ ì´ˆê¸°í™”
            setTimeout(() => {
                updateImageOrderDisplay();
            }, 100);

            if (images.length > 1) {
                isAutoTransitioning = true;
                setTimeout(() => {
                    clearInterval(currentImageInterval);
                    currentImageInterval = setInterval(() => {
                        const items = document.querySelectorAll('#image-gallery .gallery-item');
                        if (items.length > 1) {
                            items[currentImageIndex].classList.remove('active');
                            currentImageIndex = (currentImageIndex + 1) % items.length;
                            items[currentImageIndex].classList.add('active');
                            updateImageOrderDisplay(); // ìˆœì„œ í‘œì‹œ ì—…ë°ì´íŠ¸
                        }
                    }, currentAutoplayTiming);
                }, 100);
            }
            
            setTimeout(() => {
                const imageGalleryEl = document.getElementById('image-gallery');
                if (!imageGalleryEl) return;
                
                // ê°¤ëŸ¬ë¦¬ ì „ì²´ ì˜ì—­ í´ë¦­ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬
                if (!imageGalleryEl.getAttribute('data-has-click-handler')) {
                    imageGalleryEl.setAttribute('data-has-click-handler', 'true');
                    imageGalleryEl.onclick = function() {
                        const items = document.querySelectorAll('#image-gallery .gallery-item');
                        if (items.length <= 1) return;
                        
                        if (isAutoTransitioning) {
                            isAutoTransitioning = false;
                            if (currentImageInterval) {
                                clearInterval(currentImageInterval);
                            }
                        } else {
                            items[currentImageIndex].classList.remove('active');
                            currentImageIndex = (currentImageIndex + 1) % items.length;
                            items[currentImageIndex].classList.add('active');
                            updateImageOrderDisplay(); // ìˆœì„œ í‘œì‹œ ì—…ë°ì´íŠ¸

                            isAutoTransitioning = true;
                            currentImageInterval = setInterval(function() {
                                const galleryItems = document.querySelectorAll('#image-gallery .gallery-item');
                                if (galleryItems.length > 1) {
                                    galleryItems[currentImageIndex].classList.remove('active');
                                    currentImageIndex = (currentImageIndex + 1) % galleryItems.length;
                                    galleryItems[currentImageIndex].classList.add('active');
                                    updateImageOrderDisplay(); // ìˆœì„œ í‘œì‹œ ì—…ë°ì´íŠ¸
                                }
                            }, currentAutoplayTiming);
                        }
                    };
                }
            }, 100);
            
            if (typeof playAudio === 'function' && audioSrc) {
                playAudio(audioSrc);
            }

            // ëª¨ë“  í™˜ê²½ì—ì„œ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì¶”ê°€ ë° í™œì„±í™”
            const isMobile = window.innerWidth <= 768;
            const isLandscape = window.innerWidth > window.innerHeight;

            if (!document.getElementById('mobile-controls')) {
                addMobileControls();
            } else {
                // ê¸°ì¡´ ì»¨íŠ¸ë¡¤ì´ ìˆìœ¼ë©´ í™œì„±í™”
                const existingControls = document.getElementById('mobile-controls');
                existingControls.style.display = 'flex';
                existingControls.classList.add('active');
            }

            // ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œì—ì„œ ê°•ì œë¡œ í‘œì‹œ í™•ì¸
            if (isMobile && isLandscape) {
                const mobileControls = document.getElementById('mobile-controls');
                if (mobileControls) {
                    mobileControls.style.display = 'flex';
                    mobileControls.classList.add('active');
                    console.log('ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œ - ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ê°•ì œ í™œì„±í™”');
                }
            }
            } // displayGallery í•¨ìˆ˜ ë
        }

        // ê°¤ëŸ¬ë¦¬ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showGalleryMessage(message, duration = 1000) {
            const galleryWrapper = document.getElementById('gallery-wrapper');
            if (!galleryWrapper) return;

            // ê¸°ì¡´ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì œê±°
            const existingMessage = galleryWrapper.querySelector('.gallery-message');
            if (existingMessage) {
                existingMessage.remove();
            }

            // ìƒˆ ë©”ì‹œì§€ ìƒì„±
            const messageElement = document.createElement('div');
            messageElement.className = 'gallery-message';
            messageElement.textContent = message;
            galleryWrapper.appendChild(messageElement);

            // ë©”ì‹œì§€ í‘œì‹œ
            setTimeout(() => {
                messageElement.classList.add('show');
            }, 50);

            // ì§€ì •ëœ ì‹œê°„ í›„ ë©”ì‹œì§€ ì œê±°
            setTimeout(() => {
                messageElement.classList.remove('show');
                setTimeout(() => {
                    if (messageElement.parentNode) {
                        messageElement.parentNode.removeChild(messageElement);
                    }
                }, 300);
            }, duration);
        }

        // ê°¤ëŸ¬ë¦¬ëª… í‘œì‹œ í•¨ìˆ˜
        function showGalleryNameMessage() {
            if (currentGalleryName) {
                showGalleryMessage(currentGalleryName, 1500);
            }
        }

        // ì´ë¯¸ì§€ ìë™ ì „í™˜ í† ê¸€ í•¨ìˆ˜
        function toggleImageAutoTransition() {
            const items = document.querySelectorAll('#image-gallery .gallery-item');
            if (items.length <= 1) return;

            if (isAutoTransitioning) {
                // ìë™ ì „í™˜ ì¤‘ì§€
                isAutoTransitioning = false;
                if (currentImageInterval) {
                    clearInterval(currentImageInterval);
                    currentImageInterval = null;
                }
                // ê°¤ëŸ¬ë¦¬ ëª…ê³¼ í•¨ê»˜ Hold ë©”ì‹œì§€ í‘œì‹œ
                const holdMessage = currentGalleryName ? `${currentGalleryName}\nHold Image` : 'Hold Image';
                showGalleryMessage(holdMessage);
            } else {
                // ìë™ ì „í™˜ ì¬ì‹œì‘
                isAutoTransitioning = true;
                currentImageInterval = setInterval(() => {
                    const galleryItems = document.querySelectorAll('#image-gallery .gallery-item');
                    if (galleryItems.length > 1 && isAutoTransitioning) {
                        galleryItems[currentImageIndex].classList.remove('active');
                        currentImageIndex = (currentImageIndex + 1) % galleryItems.length;
                        galleryItems[currentImageIndex].classList.add('active');
                        updateImageOrderDisplay(); // ìˆœì„œ í‘œì‹œ ì—…ë°ì´íŠ¸
                    }
                }, currentAutoplayTiming);
                const seconds = Math.round(currentAutoplayTiming / 1000);
                showGalleryMessage(`Auto Mode ${seconds} sec`);
            }
        }

        // ê°¤ëŸ¬ë¦¬ ë‹«ê¸°
        function hideGallery() {
            const galleryWrapper = document.getElementById('gallery-wrapper');
            galleryWrapper.classList.remove('active');
            galleryWrapper.style.display = 'none';
            document.getElementById('gallery-placeholder').style.display = 'block';
            clearInterval(currentImageInterval);

            // ëª¨ë“  í™˜ê²½ì—ì„œ ì»¨íŠ¸ë¡¤ ë²„íŠ¼ ì œê±°
            const mobileControls = document.getElementById('mobile-controls');
            if (mobileControls) {
                mobileControls.remove();
            }

            // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œ í•´ì œ
            if (isMobilePortraitMode) {
                disableMobilePortraitMode();
            }
        }

        // ê°œë³„ ì´ë¯¸ì§€ ì‚­ì œ í•¨ìˆ˜ (Firebase ë²„ì „)
        async function deleteImage(musicId, imageId, event) {
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }

            console.log('Delete image called:', { musicId, imageId });

            const confirmMessage = 'ì´ ì´ë¯¸ì§€ë¥¼ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œëœ ì´ë¯¸ì§€ëŠ” ë³µêµ¬í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            if (!confirm(confirmMessage)) {
                return;
            }

            // ì‚­ì œ ì¤‘ ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
            const deleteButton = event?.target;
            if (deleteButton) {
                deleteButton.disabled = true;
                deleteButton.innerHTML = 'â³';
                deleteButton.style.opacity = '0.6';
            }

            try {
                // 1. musicIdë¥¼ íŒŒë¼ë¯¸í„°ë¡œ ë°›ìŒ (getCurrentMusicId ë¶ˆí•„ìš”)
                const currentMusicId = musicId;
                if (!currentMusicId) {
                    throw new Error('ìŒì•… IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                // 2. Firestoreì—ì„œ ìŒì•… ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
                const musicRef = window.firebaseDoc(window.firebaseDb, 'music', currentMusicId);
                const musicDoc = await window.firebaseGetDoc(musicRef);

                if (!musicDoc.exists()) {
                    throw new Error('ìŒì•… ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                const musicData = musicDoc.data();
                const images = musicData.images || [];

                // ì´ë¯¸ì§€ì— ID ì¶”ê°€
                const imagesWithIds = images.map((img, idx) => ({
                    ...img,
                    id: img.id || `${currentMusicId}_${idx}`
                }));

                // 3. ì‚­ì œí•  ì´ë¯¸ì§€ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
                const deleteIndex = imagesWithIds.findIndex(img => img.id === imageId);

                if (deleteIndex === -1) {
                    throw new Error('ì‚­ì œí•  ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                const imageToDelete = imagesWithIds[deleteIndex];
                console.log('ì‚­ì œí•  ì´ë¯¸ì§€ ì¸ë±ìŠ¤:', deleteIndex, 'ì „ì²´ ì´ë¯¸ì§€ ìˆ˜:', imagesWithIds.length);

                // 4. Firebase Storageì—ì„œ ì´ë¯¸ì§€ íŒŒì¼ ì‚­ì œ
                if (imageToDelete.imageSrc) {
                    try {
                        // imageSrcê°€ Firebase Storage URLì¸ ê²½ìš° íŒŒì¼ ì‚­ì œ
                        if (imageToDelete.imageSrc.includes('firebasestorage.googleapis.com')) {
                            // URLì—ì„œ íŒŒì¼ ê²½ë¡œ ì¶”ì¶œ
                            const url = new URL(imageToDelete.imageSrc);
                            const pathMatch = url.pathname.match(/\/o\/(.+?)(\?|$)/);

                            if (pathMatch) {
                                const filePath = decodeURIComponent(pathMatch[1]);
                                const fileRef = window.firebaseStorageRef(window.firebaseStorage, filePath);

                                await window.firebaseDeleteObject(fileRef);
                                console.log('Firebase Storageì—ì„œ ì´ë¯¸ì§€ íŒŒì¼ ì‚­ì œ ì™„ë£Œ:', filePath);
                            }
                        }
                    } catch (storageError) {
                        console.warn('Firebase Storage ì‚­ì œ ì¤‘ ì˜¤ë¥˜ (ê³„ì† ì§„í–‰):', storageError);
                        // Storage ì‚­ì œ ì‹¤íŒ¨í•´ë„ FirestoreëŠ” ì—…ë°ì´íŠ¸
                    }
                }

                // 5. Firestoreì—ì„œ ì´ë¯¸ì§€ ì •ë³´ ì œê±°
                const updatedImages = imagesWithIds.filter(img => img.id !== imageId);

                // order ì†ì„± ì¬ì •ë ¬
                updatedImages.forEach((img, idx) => {
                    img.order = idx;
                });

                // ë‹¤ìŒ ì´ë¯¸ì§€ ì¸ë±ìŠ¤ ê³„ì‚°
                let nextImageIndex;
                if (updatedImages.length === 0) {
                    // ëª¨ë“  ì´ë¯¸ì§€ê°€ ì‚­ì œë¨
                    nextImageIndex = -1;
                } else if (deleteIndex >= updatedImages.length) {
                    // ë§ˆì§€ë§‰ ì´ë¯¸ì§€ë¥¼ ì‚­ì œí•œ ê²½ìš°, ìƒˆë¡œìš´ ë§ˆì§€ë§‰ ì´ë¯¸ì§€ë¡œ ì´ë™
                    nextImageIndex = updatedImages.length - 1;
                } else {
                    // ì‚­ì œëœ ì´ë¯¸ì§€ì˜ ë‹¤ìŒ ì´ë¯¸ì§€ë¡œ ì´ë™ (ê°™ì€ ì¸ë±ìŠ¤ ìœ„ì¹˜)
                    nextImageIndex = deleteIndex;
                }

                console.log('ë‹¤ìŒ ì´ë¯¸ì§€ ì¸ë±ìŠ¤:', nextImageIndex);

                // Firestore ì—…ë°ì´íŠ¸
                await window.firebaseSetDoc(musicRef, { images: updatedImages }, { merge: true });

                console.log('Firestoreì—ì„œ ì´ë¯¸ì§€ ì •ë³´ ì‚­ì œ ì™„ë£Œ');
                console.log('ì´ë¯¸ì§€ ì‚­ì œ ì„±ê³µ:', imageId);

                // 6. ì¦‰ì‹œ UIì—ì„œ í•´ë‹¹ ì´ë¯¸ì§€ ì œê±° (ë¶€ë“œëŸ¬ìš´ ì• ë‹ˆë©”ì´ì…˜)
                const imageElement = document.querySelector(`[data-image-id="${imageId}"]`);
                if (imageElement) {
                    imageElement.style.transition = 'opacity 0.3s ease-out';
                    imageElement.style.opacity = '0';
                    setTimeout(() => {
                        if (imageElement.parentNode) {
                            imageElement.remove();
                        }
                    }, 300);
                }

                // 7. í˜„ì¬ ìŒì•…ì˜ ì´ë¯¸ì§€ ëª©ë¡ ì—…ë°ì´íŠ¸
                const currentMusic = mySunoMusic.find(music =>
                    (music.musicId || music.id) === currentMusicId
                );

                if (currentMusic) {
                    // ì´ë¯¸ì§€ê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆë‹¤ë©´ ê°¤ëŸ¬ë¦¬ ë‹«ê¸°
                    if (updatedImages.length === 0) {
                        currentMusic.images = [];
                        setTimeout(() => {
                            hideAllPanelsExcept('gallery-placeholder');
                            document.getElementById('gallery-placeholder').innerHTML = '<p>ì´ë¯¸ì§€ê°€ ëª¨ë‘ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
                        }, 500);
                    } else {
                        // ë‚¨ì€ ì´ë¯¸ì§€ê°€ ìˆë‹¤ë©´ í•´ë‹¹ ìœ„ì¹˜ë¡œ ê°¤ëŸ¬ë¦¬ ì´ë™
                        currentMusic.images = updatedImages;

                        setTimeout(() => {
                            // ì‚­ì œëœ ì´ë¯¸ì§€ì˜ ë‹¤ìŒ ë²ˆí˜¸ë¡œ ê°¤ëŸ¬ë¦¬ í‘œì‹œ
                            showGalleryWithIndex(
                                currentMusicId,
                                updatedImages,
                                nextImageIndex,
                                currentMusic.audioSrc,
                                currentMusic.name,
                                currentMusic.createdBy
                            );

                            console.log(`ì´ë¯¸ì§€ ì‚­ì œ í›„ ${nextImageIndex + 1}ë²ˆì§¸ ì´ë¯¸ì§€ë¡œ ì´ë™`);
                            showGalleryMessage(`ì´ë¯¸ì§€ ì‚­ì œ ì™„ë£Œ (${nextImageIndex + 1}/${updatedImages.length})`, 1500);
                        }, 300);
                    }
                }

                // 8. allMusicDataì—ì„œë„ ì œê±°
                const allMusic = allMusicData.find(music => {
                    if (music.images && Array.isArray(music.images)) {
                        return music.images.some(img => img.id == imageId);
                    }
                    return false;
                });
                if (allMusic && allMusic.images) {
                    allMusic.images = allMusic.images.filter(img => img.id !== imageId);
                }

                // 9. ìŒì•… ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadMusicDataFromServer();

                // ì„±ê³µ ë©”ì‹œì§€
                console.log('ì´ë¯¸ì§€ê°€ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤ (Firebase Storage + Firestore).');

            } catch (error) {
                console.error('ì´ë¯¸ì§€ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:', error);
                alert(`ì´ë¯¸ì§€ ì‚­ì œ ì‹¤íŒ¨: ${error.message}`);

                // ì˜¤ë¥˜ ì‹œ ë²„íŠ¼ ë³µêµ¬
                if (deleteButton) {
                    deleteButton.disabled = false;
                    deleteButton.innerHTML = 'Ã—';
                    deleteButton.style.opacity = '1';
                }
            }
        }

        // í˜„ì¬ ì¬ìƒì¤‘ì¸ ìŒì•… IDë¥¼ ë°˜í™˜í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
        function getCurrentMusicId() {
            // 1. í˜„ì¬ ì—´ë¦° ê°¤ëŸ¬ë¦¬ì˜ ìŒì•… ID ìš°ì„  ë°˜í™˜
            if (currentGalleryInfo && currentGalleryInfo.musicId) {
                console.log('getCurrentMusicId: currentGalleryInfo.musicId =', currentGalleryInfo.musicId);
                return currentGalleryInfo.musicId;
            }
            // 2. ì¬ìƒ ì¤‘ì¸ ì˜¤ë””ì˜¤ì—ì„œ ìŒì•… ID ê°€ì ¸ì˜¤ê¸°
            if (currentAudio && currentAudio.id) {
                const musicId = currentAudio.id.replace('audio-', '');
                console.log('getCurrentMusicId: currentAudio.id =', musicId);
                return musicId;
            }
            console.error('getCurrentMusicId: ìŒì•… IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', {
                currentGalleryInfo,
                currentAudio
            });
            return null;
        }

        // ë¡œê·¸ì¸/ë¡œê·¸ì•„ì›ƒ/ì—…ë¡œë“œ í¼ í‘œì‹œ
        function showLoginSection() {
            // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œì—ì„œëŠ” mobile-login-popup ì‚¬ìš©
            const isMobile = window.innerWidth <= 768;
            const isPortrait = window.innerHeight > window.innerWidth;

            if (isMobile && isPortrait) {
                const mobilePopup = document.getElementById('mobile-login-popup');
                if (!mobilePopup) {
                    console.error('Mobile popup element not found!');
                    return;
                }

                mobilePopup.classList.add('show');
                mobilePopup.innerHTML = `
                    <div class="login-section">
                        <button class="close-button" onclick="hideMobileLoginForm()">Ã—</button>
                        <h2>ë¡œê·¸ì¸</h2>
                        <form id="login-form">
                            <input type="email" id="email" name="email" placeholder="ì´ë©”ì¼" required>
                            <input type="password" id="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
                            <button type="submit">ë¡œê·¸ì¸</button>
                        </form>
                        <div id="google-button-container"></div>
                        <p style="text-align: center; margin-top: 10px;">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a href="#" id="show-signup">íšŒì›ê°€ì…</a></p>
                    </div>
                `;

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ì—°ê²°
                setTimeout(() => {
                    renderGoogleButton();
                }, 100);

                document.getElementById('login-form').addEventListener('submit', handleLogin);
                document.getElementById('show-signup').addEventListener('click', showSignupSection);
                return;
            }

            // PC ë° ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œì—ì„œëŠ” ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
            const formContainer = document.getElementById('form-container');
            formContainer.style.display = 'flex';
            formContainer.innerHTML = `
                <div class="login-section">
                    <button class="close-button" onclick="hideLoginForm()">Ã—</button>
                    <h2>ë¡œê·¸ì¸</h2>
                    <form id="login-form">
                        <input type="email" id="email" name="email" placeholder="ì´ë©”ì¼" required>
                        <input type="password" id="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
                        <button type="submit">ë¡œê·¸ì¸</button>
                    </form>
                    <div id="google-button-container"></div>
                    <p style="text-align: center; margin-top: 10px;">ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a href="#" id="show-signup">íšŒì›ê°€ì…</a></p>
                </div>
            `;
            formContainer.style.display = 'flex';
            // DOMì´ ì¤€ë¹„ëœ í›„ êµ¬ê¸€ ë¡œê·¸ì¸ ì´ˆê¸°í™”
            setTimeout(() => {
                renderGoogleButton();
            }, 100);
            
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('show-signup').addEventListener('click', showSignupSection);

            // ë°°ê²½ í´ë¦­ ì‹œ ì°½ ë‹«ê¸°
            formContainer.addEventListener('click', (event) => {
                if (event.target === formContainer) {
                    hideLoginForm();
                }
            });
        }

        function showSignupSection() {
            // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œì—ì„œëŠ” mobile-login-popup ì‚¬ìš©
            const isMobile = window.innerWidth <= 768;
            const isPortrait = window.innerHeight > window.innerWidth;

            if (isMobile && isPortrait) {
                const mobilePopup = document.getElementById('mobile-login-popup');
                mobilePopup.classList.add('show');
                mobilePopup.innerHTML = `
                    <div class="login-section">
                        <button class="close-button" onclick="hideMobileLoginForm()">Ã—</button>
                        <h2>íšŒì›ê°€ì…</h2>
                        <form id="signup-form">
                            <input type="email" id="signup-email" name="email" placeholder="ì´ë©”ì¼" required>
                            <input type="password" id="signup-password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
                            <select id="signup-role" name="role" required>
                                <option value="user">ì¼ë°˜ íšŒì›</option>
                                <option value="creator">í¬ë¦¬ì—ì´í„°</option>
                            </select>
                            <button type="submit">íšŒì›ê°€ì…</button>
                        </form>
                        <p style="text-align: center; margin-top: 10px;">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="#" id="show-login">ë¡œê·¸ì¸</a></p>
                    </div>
                `;

                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë‹¤ì‹œ ì—°ê²°
                document.getElementById('signup-form').addEventListener('submit', handleSignup);
                document.getElementById('show-login').addEventListener('click', showLoginSection);
                return;
            }

            // PC ë° ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œì—ì„œëŠ” ê¸°ì¡´ ë°©ì‹ ì‚¬ìš©
            const formContainer = document.getElementById('form-container');
            formContainer.style.display = 'flex';
            formContainer.innerHTML = `
                <div class="login-section">
                    <button class="close-button" onclick="hideLoginForm()">Ã—</button>
                    <h2>íšŒì›ê°€ì…</h2>
                    <form id="signup-form">
                        <input type="email" id="signup-email" name="email" placeholder="ì´ë©”ì¼" required>
                        <input type="password" id="signup-password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required>
                        <select id="signup-role" name="role" required>
                            <option value="user">ì¼ë°˜ íšŒì›</option>
                            <option value="creator">í¬ë¦¬ì—ì´í„°</option>
                        </select>
                        <button type="submit">íšŒì›ê°€ì…</button>
                    </form>
                    <p style="text-align: center; margin-top: 10px;">ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a href="#" id="show-login">ë¡œê·¸ì¸</a></p>
                </div>
            `;
            formContainer.style.display = 'flex';
            document.getElementById('signup-form').addEventListener('submit', handleSignup);
            document.getElementById('show-login').addEventListener('click', showLoginSection);

            // ë°°ê²½ í´ë¦­ ì‹œ ì°½ ë‹«ê¸°
            formContainer.addEventListener('click', (event) => {
                if (event.target === formContainer) {
                    hideLoginForm();
                }
            });
        }

        // ëª¨ë°”ì¼ ë¡œê·¸ì¸ í¼ ìˆ¨ê¸°ê¸° (ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œ ì „ìš©)
        function hideMobileLoginForm() {
            const mobilePopup = document.getElementById('mobile-login-popup');
            mobilePopup.classList.remove('show');
            mobilePopup.innerHTML = '';
        }

        // ê¸°ì¡´ ë¡œê·¸ì¸ í¼ ìˆ¨ê¸°ê¸° (PC ë° ëª¨ë°”ì¼ ê°€ë¡œëª¨ë“œ)
        function hideLoginForm() {
            const formContainer = document.getElementById('form-container');
            formContainer.style.display = 'none';

            // ê°¤ëŸ¬ë¦¬ê°€ ì´ë¯¸ í™œì„±í™”ë˜ì–´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ìœ ì§€, ì•„ë‹ˆë©´ í”Œë ˆì´ìŠ¤í™€ë” í‘œì‹œ
            const galleryWrapper = document.getElementById('gallery-wrapper');
            if (!galleryWrapper.classList.contains('active')) {
                const galleryPlaceholder = document.getElementById('gallery-placeholder');
                galleryPlaceholder.style.display = 'flex';
            }
        }

        // Firestoreì—ì„œ ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ë¡œë“œí•˜ëŠ” í•¨ìˆ˜
        async function loadCategoriesFromFirestore() {
            try {
                const categoriesRef = window.firebaseCollection(window.firebaseDb, 'categories');
                const querySnapshot = await window.firebaseGetDocs(categoriesRef);

                const categories = [];
                const categoryDetails = [];

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    // ë¬¸ì„œ IDë¥¼ ì¹´í…Œê³ ë¦¬ ì´ë¦„ìœ¼ë¡œ ì‚¬ìš©
                    const categoryName = doc.id;
                    categories.push(categoryName);
                    categoryDetails.push({
                        name: categoryName,
                        topSection: data.topSection || 'visual-mode',
                        classification: data.classification || 'ê¸°íƒ€',
                        description: data.description || '',
                        isAdult: data.isAdult || false
                    });
                });

                // ì „ì—­ ë³€ìˆ˜ ì—…ë°ì´íŠ¸
                allCategories = categories;
                allCategoryDetails = categoryDetails;

                // categoryClassificationMap ì—…ë°ì´íŠ¸
                categoryClassificationMap = {};
                categoryDetails.forEach(cat => {
                    categoryClassificationMap[cat.name] = cat.classification;
                });

                console.log('=== ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì™„ë£Œ ===');
                console.log('Firestoreì—ì„œ ë¡œë“œí•œ ì¹´í…Œê³ ë¦¬:', categories);
                console.log('ì¹´í…Œê³ ë¦¬ ìƒì„¸ ì •ë³´:', categoryDetails);
                console.log('ì„±ì¸ ì¹´í…Œê³ ë¦¬:', categoryDetails.filter(cat => cat.isAdult).map(cat => cat.name));
                console.log('ì¹´í…Œê³ ë¦¬ ë¶„ë¥˜ ë§µ:', categoryClassificationMap);
                return categories;
            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ ë¡œë“œ ì‹¤íŒ¨:', error);
                return [];
            }
        }

        // topSectionì— ë”°ë¼ ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ì—…ë°ì´íŠ¸ (ì—…ë¡œë“œ í¼)
        function updateCategoryOptionsByTopSection() {
            const topSection = document.getElementById('musicTopSection').value;
            const categorySelect = document.getElementById('musicCategory');

            if (!topSection) {
                categorySelect.innerHTML = '<option value="">ë¨¼ì € ìƒìœ„ ì„¹ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                return;
            }

            // ì„ íƒí•œ topSectionì— í•´ë‹¹í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë§Œ í•„í„°ë§
            const filteredCategories = allCategoryDetails.filter(cat => cat.topSection === topSection);

            if (filteredCategories.length === 0) {
                categorySelect.innerHTML = '<option value="">ì´ ì„¹ì…˜ì— ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
                return;
            }

            let options = '<option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>';
            options += filteredCategories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            categorySelect.innerHTML = options;
        }

        // topSectionì— ë”°ë¼ ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ì—…ë°ì´íŠ¸ (í¸ì§‘ í¼)
        function updateEditCategoryOptionsByTopSection() {
            const topSection = document.getElementById('editTopSection').value;
            const categorySelect = document.getElementById('editCategoryName');

            if (!topSection) {
                categorySelect.innerHTML = '<option value="">ë¨¼ì € ìƒìœ„ ì„¹ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>';
                return;
            }

            // ì„ íƒí•œ topSectionì— í•´ë‹¹í•˜ëŠ” ì¹´í…Œê³ ë¦¬ë§Œ í•„í„°ë§
            const filteredCategories = allCategoryDetails.filter(cat => cat.topSection === topSection);

            if (filteredCategories.length === 0) {
                categorySelect.innerHTML = '<option value="">ì´ ì„¹ì…˜ì— ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
                return;
            }

            let options = '<option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>';
            options += filteredCategories.map(cat => `<option value="${cat.name}">${cat.name}</option>`).join('');
            categorySelect.innerHTML = options;
        }

        // ğŸ’¡ showUploadForm í•¨ìˆ˜ ìˆ˜ì •: ì¹´í…Œê³ ë¦¬ ì…ë ¥ í•„ë“œ ì¶”ê°€
        async function showUploadForm() {
            hideAllPanelsExcept('form-container');
            const formContainer = document.getElementById('form-container');

            // Firestoreì—ì„œ ìµœì‹  ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ
            await loadCategoriesFromFirestore();

            formContainer.innerHTML = `
                <div class="upload-section">
                    <button class="close-button" onclick="hideAllPanelsExcept('gallery-placeholder'); loadMusicDataFromServer();">Ã—</button>
                    <h2>ìŒì› ì—…ë¡œë“œ</h2>
                    <form id="upload-form" enctype="multipart/form-data">
                        <input type="text" id="musicName" name="musicName" placeholder="ìŒì› ì œëª©" required>
                        <label for="audioFile">ìŒì› íŒŒì¼:</label>
                        <input type="file" id="audioFile" name="audioFile" accept="audio/*" required>
                        <label for="imageFiles">ì´ë¯¸ì§€ íŒŒì¼ (ìµœëŒ€ 5ê°œ):</label>
                        <input type="file" id="imageFiles" name="imageFiles[]" accept="image/*" multiple required>
                        <label for="musicTopSection">ìµœìƒìœ„ ì„¹ì…˜</label>
                        <select id="musicTopSection" name="musicTopSection" required onchange="updateCategoryOptionsByTopSection()">
                            <option value="">ì„¹ì…˜ ì„ íƒ</option>
                            <option value="visual-mode">Looks & Lines</option>
                            <option value="momentary">MOMENTARY</option>
                            <option value="chronicles">CHRONICLES</option>
                        </select>
                        <label for="musicCategory">í•˜ìœ„ ì¹´í…Œê³ ë¦¬</label>
                        <select id="musicCategory" name="musicCategory" required>
                            <option value="">ë¨¼ì € ìƒìœ„ ì„¹ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                        <button type="submit">ì—…ë¡œë“œ</button>
                    </form>
                </div>
            `;
            formContainer.style.display = 'flex';
            document.getElementById('upload-form').addEventListener('submit', handleUpload);
        }

        // ğŸ’¡ showEditForm í•¨ìˆ˜ ìˆ˜ì •: ì¹´í…Œê³ ë¦¬ ì…ë ¥ í•„ë“œ ì¶”ê°€
        async function showEditForm(musicItem) {
            hideAllPanelsExcept('form-container');
            const formContainer = document.getElementById('form-container');

            // Firestoreì—ì„œ ìµœì‹  ì¹´í…Œê³ ë¦¬ ëª©ë¡ ë¡œë“œ
            await loadCategoriesFromFirestore();

            // í˜„ì¬ ì¹´í…Œê³ ë¦¬ì˜ topSection ì°¾ê¸°
            const currentCategoryDetail = allCategoryDetails.find(cat => cat.name === musicItem.category);
            const currentTopSection = currentCategoryDetail ? currentCategoryDetail.topSection : 'visual-mode';

            formContainer.innerHTML = `
                <div class="edit-section">
                    <button class="close-button" onclick="hideAllPanelsExcept('gallery-placeholder'); loadMusicDataFromServer();">Ã—</button>
                    <h2>ì½˜í…ì¸  ì—…ë°ì´íŠ¸</h2>
                    <form id="edit-form">
                        <input type="hidden" id="musicId" value="${musicItem.id}">
                        <label>ìŒì› ì œëª©:</label>
                        <input type="text" id="editMusicName" value="${musicItem.name}" required>
                        <label>ìµœìƒìœ„ ì„¹ì…˜:</label>
                        <select id="editTopSection" onchange="updateEditCategoryOptionsByTopSection()">
                            <option value="">ì„¹ì…˜ ì„ íƒ</option>
                            <option value="visual-mode" ${currentTopSection === 'visual-mode' ? 'selected' : ''}>Looks & Lines</option>
                            <option value="momentary" ${currentTopSection === 'momentary' ? 'selected' : ''}>MOMENTARY</option>
                            <option value="chronicles" ${currentTopSection === 'chronicles' ? 'selected' : ''}>CHRONICLES</option>
                        </select>
                        <label>í•˜ìœ„ ì¹´í…Œê³ ë¦¬:</label>
                        <select id="editCategoryName">
                            <option value="">ë¨¼ì € ìƒìœ„ ì„¹ì…˜ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                        <label>ì´ë¯¸ì§€ ìë™ì „í™˜ ì‹œê°„ (ì´ˆ): <span style="color: #999; font-size: 12px;">ì„ íƒì‚¬í•­</span></label>
                        <input type="number" id="editAutoplayTiming" min="1" max="60" value="${musicItem.autoplayTiming || ''}" placeholder="ê¸°ë³¸ê°’: 3ì´ˆ">
                        <small style="display: block; margin-top: -10px; margin-bottom: 15px; color: #666; font-size: 12px;">
                            1~60ì´ˆ ì‚¬ì´ ê°’ ì…ë ¥ (ë¯¸ì…ë ¥ ì‹œ ê¸°ë³¸ê°’ 3ì´ˆ ì ìš©)<br>
                            ê¶Œì¥: íŒ¨ì…˜ 2-3ì´ˆ, í¬íŠ¸ë ˆì´íŠ¸ 5-7ì´ˆ, í’ê²½ 7-10ì´ˆ
                        </small>
                        <label>ê¸°ì¡´ ìŒì›:</label>
                        <audio controls src="${musicItem.audioSrc}"></audio>
                        <label>ìƒˆ ìŒì› íŒŒì¼ (ì„ íƒ ì‚¬í•­):</label>
                        <input type="file" id="editAudioFile" name="editAudioFile" accept="audio/*">
                        <label>ìƒˆ ì´ë¯¸ì§€ íŒŒì¼ (ì„ íƒ ì‚¬í•­, ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥):</label>
                        <input type="file" id="editImageFiles" name="editImageFiles[]" accept="image/*" multiple>
                        <button type="submit">ìˆ˜ì •</button>
                    </form>
                </div>
            `;
            formContainer.style.display = 'flex';

            // í˜„ì¬ ì„ íƒëœ topSectionì— ë§ëŠ” ì¹´í…Œê³ ë¦¬ ì˜µì…˜ ë¡œë“œ
            const filteredCategories = allCategoryDetails.filter(cat => cat.topSection === currentTopSection);
            let categoryOptions = '<option value="">ì¹´í…Œê³ ë¦¬ ì„ íƒ</option>';
            categoryOptions += filteredCategories.map(cat => {
                const selected = (cat.name === musicItem.category) ? 'selected' : '';
                return `<option value="${cat.name}" ${selected}>${cat.name}</option>`;
            }).join('');
            document.getElementById('editCategoryName').innerHTML = categoryOptions;

            document.getElementById('edit-form').addEventListener('submit', (event) => {
                handleEdit(event, musicItem.id);
            });
        }

        function hideAllPanelsExcept(panelId) {
            document.getElementById('gallery-placeholder').style.display = 'none';
            document.getElementById('gallery-wrapper').style.display = 'none';
            document.getElementById('form-container').style.display = 'none';
            document.getElementById(panelId).style.display = 'flex';
        }

        async function handleSignup(event) {
            event.preventDefault();
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const role = document.getElementById('signup-role').value;

            try {
                const userCredential = await window.firebaseCreateUserWithEmailAndPassword(
                    window.firebaseAuth,
                    email,
                    password
                );

                const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD

                // Firestoreì— ì‚¬ìš©ì ì •ë³´ ì €ì¥ (ì´ˆê¸° í¬ì¸íŠ¸ í¬í•¨)
                await window.firebaseSetDoc(
                    window.firebaseDoc(window.firebaseDb, 'users', userCredential.user.uid),
                    {
                        email: email,
                        role: role,
                        createdAt: new Date().toISOString(),
                        dailyPoints: 0,
                        walletBalance: 1000,  // ê°€ì… ì¶•í•˜ í¬ì¸íŠ¸ 1000P (ì§€ê°‘ í¬ì¸íŠ¸ë¡œ ì§€ê¸‰)
                        lastDailyPointClaim: today  // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •í•˜ì—¬ ê°€ì… ë‹¹ì¼ ì¶”ê°€ 100P ë°©ì§€
                    }
                );

                console.log('íšŒì›ê°€ì… ì™„ë£Œ - Firestore ì €ì¥ ì™„ë£Œ:', {
                    uid: userCredential.user.uid,
                    email: email,
                    walletBalance: 1000
                });

                alert('íšŒì›ê°€ì… ì„±ê³µ! ê°€ì… ì¶•í•˜ í¬ì¸íŠ¸ 1000Pê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!');

                // íšŒì›ê°€ì… í¼ ë‹«ê¸°
                const formContainer = document.getElementById('form-container');
                if (formContainer) formContainer.style.display = 'none';

                // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œ íŒì—…ë„ ë‹«ê¸°
                const mobilePopup = document.getElementById('mobile-login-popup');
                if (mobilePopup) {
                    mobilePopup.classList.remove('show');
                    mobilePopup.innerHTML = '';
                }

                // Firebase Auth ìƒíƒœê°€ onAuthStateChangedë¡œ ìë™ ì—…ë°ì´íŠ¸ë¨
                // checkLoginStatusëŠ” í˜¸ì¶œí•˜ì§€ ì•Šì•„ë„ ë¨ (onAuthStateChangedê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬)
            } catch (error) {
                console.error('Error:', error);
                alert('íšŒì›ê°€ì… ì‹¤íŒ¨: ' + error.message);
            }
        }


        async function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;

            try {
                const userCredential = await window.firebaseSignInWithEmailAndPassword(
                    window.firebaseAuth,
                    email,
                    password
                );
                alert('ë¡œê·¸ì¸ ì„±ê³µ!');

                // ë¡œê·¸ì¸ í¼ ë‹«ê¸°
                const formContainer = document.getElementById('form-container');
                if (formContainer) formContainer.style.display = 'none';

                // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œ íŒì—…ë„ ë‹«ê¸°
                const mobilePopup = document.getElementById('mobile-login-popup');
                if (mobilePopup) {
                    mobilePopup.classList.remove('show');
                    mobilePopup.innerHTML = '';
                }

                checkLoginStatus();
            } catch (error) {
                console.error('Error:', error);
                alert('ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message);
            }
        }


        async function handleGoogleLogin() {
            try {
                const result = await window.firebaseSignInWithPopup(
                    window.firebaseAuth,
                    window.firebaseGoogleProvider
                );

                // Firestoreì— ì‚¬ìš©ì ì •ë³´ í™•ì¸ ë° ìƒì„±
                const userDocRef = window.firebaseDoc(window.firebaseDb, 'users', result.user.uid);
                const userDoc = await window.firebaseGetDoc(userDocRef);

                let isNewUser = false;
                if (!userDoc.exists()) {
                    // ì‹ ê·œ ì‚¬ìš©ìì¸ ê²½ìš° ê¸°ë³¸ ì—­í• (user)ë¡œ ì €ì¥ ë° ì´ˆê¸° í¬ì¸íŠ¸ ì§€ê¸‰
                    const today = new Date().toISOString().split('T')[0];
                    await window.firebaseSetDoc(userDocRef, {
                        email: result.user.email,
                        role: 'user',
                        createdAt: new Date().toISOString(),
                        dailyPoints: 0,
                        walletBalance: 1000,  // ê°€ì… ì¶•í•˜ í¬ì¸íŠ¸ 1000P (ì§€ê°‘ í¬ì¸íŠ¸ë¡œ ì§€ê¸‰)
                        lastDailyPointClaim: today  // ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •í•˜ì—¬ ê°€ì… ë‹¹ì¼ ì¶”ê°€ 100P ë°©ì§€
                    });
                    isNewUser = true;
                    console.log('Google ì‹ ê·œ ê°€ì… ì™„ë£Œ - Firestore ì €ì¥ ì™„ë£Œ:', {
                        uid: result.user.uid,
                        email: result.user.email,
                        walletBalance: 1000
                    });
                }

                if (isNewUser) {
                    alert('Google ë¡œê·¸ì¸ ì„±ê³µ! ê°€ì… ì¶•í•˜ í¬ì¸íŠ¸ 1000Pê°€ ì§€ê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤!');
                } else {
                    alert('Google ë¡œê·¸ì¸ ì„±ê³µ!');
                }

                // ë¡œê·¸ì¸ í¼ ë‹«ê¸°
                const formContainer = document.getElementById('form-container');
                if (formContainer) formContainer.style.display = 'none';

                // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œ íŒì—…ë„ ë‹«ê¸°
                const mobilePopup = document.getElementById('mobile-login-popup');
                if (mobilePopup) {
                    mobilePopup.classList.remove('show');
                    mobilePopup.innerHTML = '';
                }

                // Firebase Auth ìƒíƒœê°€ onAuthStateChangedë¡œ ìë™ ì—…ë°ì´íŠ¸ë¨
                // checkLoginStatusëŠ” í˜¸ì¶œí•˜ì§€ ì•Šì•„ë„ ë¨ (onAuthStateChangedê°€ ìë™ìœ¼ë¡œ ì²˜ë¦¬)
            } catch (error) {
                console.error('Error:', error);
                alert('Google ë¡œê·¸ì¸ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // Google ë¡œê·¸ì¸ ë²„íŠ¼ ë Œë”ë§ì„ ìœ„í•œ í•¨ìˆ˜
        function renderGoogleButton() {
            const container = document.getElementById('google-button-container');
            if (!container) return;

            container.innerHTML = '<button onclick="handleGoogleLogin()" style="width: 100%; padding: 12px; background-color: #4285f4; color: white; border: none; border-radius: 5px; font-size: 16px; cursor: pointer; margin-top: 10px;">Googleë¡œ ë¡œê·¸ì¸</button>';
        }

        // ê¸°ì¡´ Google Identity Services ì½œë°± (í˜¸í™˜ì„± ìœ ì§€)
        function handleGoogleLoginLegacy(response) {
            handleGoogleLogin()
            .catch(error => {
                console.error('Google ë¡œê·¸ì¸ ì˜¤ë¥˜:', error);
                alert('Google ë¡œê·¸ì¸ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        }

        async function handleLogout() {
            try {
                await window.firebaseSignOut(window.firebaseAuth);
                alert('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ë¡œê·¸ì•„ì›ƒ í›„ ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬ì˜ ì²« ë²ˆì§¸ ëª©ë¡ìœ¼ë¡œ ìë™ ê°¤ëŸ¬ë¦¬ ì‹œì‘
                currentCategory = null;
                currentPage = 1;
                autoOpenGallery = true;
                checkLoginStatus();
            } catch (error) {
                console.error('Error:', error);
                alert('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨: ' + error.message);
            }
        }

        // setupAutoplayTimingListener í•¨ìˆ˜ë¥¼ checkLoginStatus í•¨ìˆ˜ ì•ì— ì¶”ê°€
        function setupAutoplayTimingListener() {
            const autoplayTimingInput = document.getElementById('autoplay-timing-input');
            if (autoplayTimingInput) {
                autoplayTimingInput.addEventListener('input', (event) => {
                    let newTiming = parseInt(event.target.value, 10);
                    
                    if (!isNaN(newTiming) && newTiming >= 1 && newTiming <= 60) {
                        currentAutoplayTiming = newTiming * 1000;
                    } else {
                        currentAutoplayTiming = 3000;
                    }

                    if (document.getElementById('gallery-wrapper').classList.contains('active')) {
                        clearInterval(currentImageInterval);
                        isAutoTransitioning = true;
                        currentImageInterval = setInterval(() => {
                            const items = document.querySelectorAll('#image-gallery .gallery-item');
                            if (items.length > 1) {
                                items[currentImageIndex].classList.remove('active');
                                currentImageIndex = (currentImageIndex + 1) % items.length;
                                items[currentImageIndex].classList.add('active');
                                updateImageOrderDisplay(); // ìˆœì„œ í‘œì‹œ ì—…ë°ì´íŠ¸
                            }
                        }, currentAutoplayTiming);
                    }
                });
            }
        }

        async function checkLoginStatus() {
            const loginStatusContainer = document.getElementById('login-status');

            window.firebaseOnAuthStateChanged(window.firebaseAuth, async (user) => {
                if (user) {
                    const fullEmail = user.email;
                    userName = fullEmail.includes('@') ? fullEmail.split('@')[0] : fullEmail;

                    // Firestoreì—ì„œ ì‚¬ìš©ì ì—­í•  ë¶ˆëŸ¬ì˜¤ê¸°
                    try {
                        const userDocRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                        const userDoc = await window.firebaseGetDoc(userDocRef);

                        if (userDoc.exists()) {
                            const userData = userDoc.data();
                            userRole = userData.role || 'user';
                            isAdultVerified = userData.isAdultVerified || false; // ì„±ì¸ ì¸ì¦ ìƒíƒœ ë¡œë“œ
                            console.log('=== ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì™„ë£Œ ===');
                            console.log('ì‚¬ìš©ì UID:', user.uid);
                            console.log('ì‚¬ìš©ì ì—­í• :', userRole);
                            console.log('ì„±ì¸ ì¸ì¦ ìƒíƒœ:', isAdultVerified);
                        } else {
                            userRole = 'user';
                            isAdultVerified = false;
                            console.log('ì‚¬ìš©ì ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ - ê¸°ë³¸ê°’ ì„¤ì •');
                        }
                    } catch (error) {
                        console.error('ì—­í•  ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                        userRole = 'user';
                        isAdultVerified = false;
                    }

                    // ë¡œê·¸ì¸ ì‹œ ë‚´ëª©ë¡ ë°ì´í„° ì´ˆê¸°í™”
                    loadSavedMusic(); // ì¢‹ì•„ìš” ëª©ë¡
                    loadSavedMusicFromFirestore(); // ì €ì¥ ëª©ë¡

                    // ì¹´í…Œê³ ë¦¬ ë°ì´í„° ë¡œë“œ (ì„±ì¸ ì¹´í…Œê³ ë¦¬ ì •ë³´ í¬í•¨)
                    await loadCategoriesFromFirestore();

                    // ìŒì•… ë°ì´í„° ë¡œë“œ
                    await fetchAllMusicData();
                    if (allMusicData.length > 0) {
                        const categories = [...new Set(allMusicData.map(item => item.category).filter(Boolean))];
                        if (categories.length > 0) {
                            renderCategoryTabs(categories, allCategoryDetails);
                            // ì ‘ê·¼ ê°€ëŠ¥í•œ ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ ì„ íƒ (ì„±ì¸ ì¹´í…Œê³ ë¦¬ ê±´ë„ˆë›°ê¸°)
                            const defaultCategory = findAccessibleDefaultCategory(categories);
                            selectCategory(defaultCategory);
                        }
                    }

                    loginStatusContainer.innerHTML = `
                        <div class="logged-in-container">
                            <div class="points-display" id="points-display">
                                <div class="points-item" id="points-info-clickable" style="cursor: pointer; display: flex; gap: 15px;" title="í´ë¦­í•˜ì—¬ í¬ì¸íŠ¸ êµ¬ë§¤">
                                    <span style="display: flex; align-items: center; gap: 5px;">
                                        <span class="icon">âš¡</span>
                                        <span id="daily-points">0P</span>
                                    </span>
                                    <span style="display: flex; align-items: center; gap: 5px;">
                                        <span class="icon">ğŸ’</span>
                                        <span id="wallet-points">0P</span>
                                    </span>
                                </div>
                                <div class="username-display" id="username-display" style="font-weight: bold; cursor: pointer;" title="í´ë¦­í•˜ì—¬ ë‚´ ì •ë³´ ë³´ê¸°">${userName}ë‹˜</div>
                            </div>
                            <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap; margin-top: 20px;">
                                <button id="liked-list-button-top" class="toggle-button" onclick="toggleLikedView()">â¤ï¸</button>
                                <button id="list-view-button-top" class="toggle-button" onclick="toggleListView()">ğŸ“‹</button>
                                <button id="recommended-list-button-top" class="toggle-button" onclick="toggleRecommendedView()">â­</button>
                                <button id="full-view-button" class="toggle-button" onclick="toggleFullView()">â›¶</button>
                                <button id="slide-timer-button" class="slide-timer-button" onclick="toggleSlideSpeed()" data-seconds="3" title="ìŠ¬ë¼ì´ë“œ ìë™ì „í™˜ ì†ë„">â±ï¸</button>
                                ${(userRole === 'creator') ? '<button id="upload-button" onclick="showUploadForm()">ì—…ë¡œë“œ</button>' : ''}
                                ${(userRole === 'admin') ? '<button onclick="location.href=\'admin.html\'">ê´€ë¦¬ì í˜ì´ì§€</button>' : ''}
                            </div>
                        </div>
                    `;

                    // í¬ì¸íŠ¸ ì •ë³´ ë¡œë“œ (HTML ìš”ì†Œ ìƒì„± í›„ í˜¸ì¶œ)
                    updatePointsDisplay();

                    // í¬ì¸íŠ¸ ì •ë³´ í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    const pointsInfoClickable = document.getElementById('points-info-clickable');
                    if (pointsInfoClickable) {
                        pointsInfoClickable.addEventListener('click', (e) => {
                            e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                            showPointsPurchasePopup();
                        });
                    }

                    // ì‚¬ìš©ìëª… í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
                    const usernameDisplay = document.getElementById('username-display');
                    if (usernameDisplay) {
                        usernameDisplay.addEventListener('click', (e) => {
                            e.stopPropagation(); // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
                            toggleUserInfo();
                        });
                    }

                    // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ì´ˆê¸°í™”
                    setTimeout(() => {
                        updateButtonStyles();
                        setupAutoplayTimingListener();
                    }, 100);


                    // ğŸ”» ì¶”ê°€: ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” í¼ íŒ¨ë„ ìˆ¨ê¸°ê³  ë©”ì¸ë§Œ ë³´ì´ê²Œ
                    const formContainer = document.getElementById('form-container');
                    if (formContainer) formContainer.style.display = 'none';

                    // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œ íŒì—…ë„ ë‹«ê¸°
                    const mobilePopup = document.getElementById('mobile-login-popup');
                    if (mobilePopup) {
                        mobilePopup.classList.remove('show');
                        mobilePopup.innerHTML = '';
                    }
                    // ì„ íƒ: ê°¤ëŸ¬ë¦¬ í”Œë ˆì´ìŠ¤í™€ë”ë¥¼ ê¸°ë³¸ìœ¼ë¡œ ë…¸ì¶œí•˜ê³  ì‹¶ìœ¼ë©´ ë‹¤ìŒ í•œ ì¤„ ì‚¬ìš©
                    // hideAllPanelsExcept('gallery-placeholder');

                    // ë¡œê·¸ì¸ í›„ ì¹´í…Œê³ ë¦¬ íƒ­ ë‹¤ì‹œ ë Œë”ë§
                    if (mySunoMusic.length > 0) {
                        const currentCategories = [...new Set(mySunoMusic.map(item => item.category).filter(Boolean))];
                        if (currentCategories.length > 0) {
                            renderCategoryTabs(currentCategories, allCategoryDetails);
                        }

                        // ë¡œê·¸ì¸ í›„ ì²« ë²ˆì§¸ ì¹´í…Œê³ ë¦¬ì˜ ì²« ë²ˆì§¸ ìŒì•… ìë™ ì¬ìƒ
                        if (!currentAudio || currentAudio.paused) {
                            const firstMusic = mySunoMusic[0];
                            if (firstMusic) {
                                currentMusicIndex = 0;
                                const musicId = firstMusic.musicId || firstMusic.id;
                                const audioSrc = firstMusic.audioSrc;
                                const images = firstMusic.images;

                                if (musicId && audioSrc && images) {
                                    console.log('ë¡œê·¸ì¸ í›„ ìë™ ì¬ìƒ:', firstMusic.name || firstMusic.title);
                                    togglePlay(musicId, audioSrc, images);
                                }
                            }
                        }
                    }

                } else {
                    userName = null;
                    userRole = null;
                    loginStatusContainer.innerHTML = `
                        <button onclick="showLoginSection()">ë¡œê·¸ì¸ / íšŒì›ê°€ì…</button>
                    `;

                    // ë‚´ëª©ë¡ ë°ì´í„° ì´ˆê¸°í™”
                    mySavedMusic = [];

                    // ë‚´ëª©ë¡ ë³´ê¸° ëª¨ë“œ í•´ì œ
                    if (isShowingLiked) {
                        isShowingLiked = false;
                        updateButtonStyles();
                    }

                    // ë¡œê·¸ì•„ì›ƒ/ë¹„ë¡œê·¸ì¸ ìƒíƒœì—ì„œëŠ” ê°¤ëŸ¬ë¦¬ë¥¼ ë‹«ì§€ ì•Šê³  ìœ ì§€

                    // ë¡œê·¸ì•„ì›ƒ í›„ ì¹´í…Œê³ ë¦¬ íƒ­ ë‹¤ì‹œ ë Œë”ë§í•˜ì—¬ ì ê¸ˆ ìƒíƒœ ë°˜ì˜
                    if (mySunoMusic.length > 0) {
                        const currentCategories = [...new Set(mySunoMusic.map(item => item.category).filter(Boolean))];
                        if (currentCategories.length > 0) {
                            renderCategoryTabs(currentCategories, allCategoryDetails);

                            // ë¡œê·¸ì•„ì›ƒ í›„ì—ë„ ì¹´í…Œê³ ë¦¬ ìœ ì§€
                            // ì¹´í…Œê³ ë¦¬ íƒ­ë§Œ ë‹¤ì‹œ ë Œë”ë§
                        }
                    }
                }
                // ë¡œê·¸ì¸ ìƒíƒœì— ë”°ë¼ ìŒì•… ëª©ë¡ì„ ë‹¤ì‹œ ë¡œë“œí•©ë‹ˆë‹¤.
                // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ê²½ìš°ì—ë„ ê³µê°œëœ ìŒì•… ëª©ë¡ì„ ë¡œë“œ
                try {
                    await loadMusicDataFromServer();
                } catch (error) {
                    console.error('ìŒì•… ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                    // ë¡œê·¸ì¸í•˜ì§€ ì•Šì€ ì‚¬ìš©ìë„ ìŒì•…ì„ ë³¼ ìˆ˜ ìˆë„ë¡ fetchAllMusicData ì‹œë„
                    if (!user) {
                        try {
                            // ì¹´í…Œê³ ë¦¬ ë°ì´í„° ë¡œë“œ (ì„±ì¸ ì¹´í…Œê³ ë¦¬ ì •ë³´ í¬í•¨)
                            await loadCategoriesFromFirestore();

                            await fetchAllMusicData();
                            if (allMusicData.length > 0) {
                                const categories = [...new Set(allMusicData.map(item => item.category).filter(Boolean))];
                                if (categories.length > 0) {
                                    renderCategoryTabs(categories, allCategoryDetails);
                                    // ì ‘ê·¼ ê°€ëŠ¥í•œ ê¸°ë³¸ ì¹´í…Œê³ ë¦¬ ì„ íƒ (ì„±ì¸ ì¹´í…Œê³ ë¦¬ ê±´ë„ˆë›°ê¸°)
                                    const defaultCategory = findAccessibleDefaultCategory(categories);
                                    selectCategory(defaultCategory);
                                }
                            }
                        } catch (err) {
                            console.error('ì „ì²´ ìŒì•… ë°ì´í„° ë¡œë“œë„ ì‹¤íŒ¨:', err);
                        }
                    }
                }
            });
        }

        // í¬ì¸íŠ¸ ì‹œìŠ¤í…œ ê´€ë ¨ í•¨ìˆ˜ë“¤
        let currentUserPoints = 0; // ì „ì—­ ë³€ìˆ˜ë¡œ í˜„ì¬ í¬ì¸íŠ¸ ì €ì¥

        async function updatePointsDisplay() {
            try {
                const user = window.firebaseAuth.currentUser;
                console.log('updatePointsDisplay í˜¸ì¶œ:', {hasUser: !!user, uid: user?.uid});

                if (!user) {
                    console.log('updatePointsDisplay: ì‚¬ìš©ì ì—†ìŒ');
                    return;
                }

                // Firestoreì—ì„œ í¬ì¸íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const userDocRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                const userDoc = await window.firebaseGetDoc(userDocRef);

                console.log('Firestore ë¬¸ì„œ ì¡´ì¬ ì—¬ë¶€:', userDoc.exists());

                if (userDoc.exists()) {
                    const userData = userDoc.data();
                    const dailyPoints = userData.dailyPoints || 0;
                    const walletBalance = userData.walletBalance || 0;
                    const totalPoints = dailyPoints + walletBalance;

                    console.log('í¬ì¸íŠ¸ ë°ì´í„°:', {dailyPoints, walletBalance, totalPoints});

                    // í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
                    const dailyPointsEl = document.getElementById('daily-points');
                    const walletPointsEl = document.getElementById('wallet-points');

                    console.log('HTML ìš”ì†Œ ì¡´ì¬ ì—¬ë¶€:', {
                        hasDailyPointsEl: !!dailyPointsEl,
                        hasWalletPointsEl: !!walletPointsEl
                    });

                    if (dailyPointsEl) {
                        dailyPointsEl.textContent = `${dailyPoints}P`;
                        console.log('ì¼ì¼ í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸:', dailyPoints);
                    }
                    if (walletPointsEl) {
                        walletPointsEl.textContent = `${walletBalance}P`;
                        console.log('ì§€ê°‘ í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸:', walletBalance);
                    }

                    // ì „ì—­ ë³€ìˆ˜ì— ì´ í¬ì¸íŠ¸ ì €ì¥ (í¬ì¸íŠ¸ 50 ì´í•˜ ì²´í¬ìš©)
                    currentUserPoints = totalPoints;

                    // í¬ì¸íŠ¸ê°€ 50 ì´í•˜ì´ê³  ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë¼ë©´ êµ¬ë… íŒì—… í‘œì‹œ
                    if (userName && currentUserPoints <= 50) {
                        showSubscriptionPopup();
                    }

                    // ì¼ì¼ í¬ì¸íŠ¸ ì§€ê¸‰ ì²´í¬
                    await checkAndGrantDailyPoints(user.uid, userData);
                } else {
                    console.log('updatePointsDisplay: Firestore ë¬¸ì„œê°€ ì¡´ì¬í•˜ì§€ ì•ŠìŒ');
                }
            } catch (error) {
                console.error('í¬ì¸íŠ¸ ì •ë³´ ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì¼ì¼ í¬ì¸íŠ¸ ì§€ê¸‰ ì²´í¬ ë° ì§€ê¸‰ í•¨ìˆ˜
        async function checkAndGrantDailyPoints(userId, userData) {
            const today = new Date().toISOString().split('T')[0]; // YYYY-MM-DD
            const lastClaimDate = userData.lastDailyPointClaim || '';

            console.log('ë°ì¼ë¦¬ í¬ì¸íŠ¸ ì²´í¬:', { today, lastClaimDate, isNewDay: lastClaimDate !== today });

            if (lastClaimDate !== today) {
                try {
                    // ì˜¤ëŠ˜ ì•„ì§ í¬ì¸íŠ¸ë¥¼ ë°›ì§€ ì•Šì•˜ìœ¼ë©´ 60P ì§€ê¸‰
                    const userDocRef = window.firebaseDoc(window.firebaseDb, 'users', userId);
                    const currentDailyPoints = userData.dailyPoints || 0;
                    const newDailyPoints = currentDailyPoints + 60;

                    await window.firebaseSetDoc(userDocRef, {
                        dailyPoints: newDailyPoints,
                        lastDailyPointClaim: today
                    }, { merge: true });

                    console.log('ë°ì¼ë¦¬ í¬ì¸íŠ¸ ì§€ê¸‰ ì™„ë£Œ:', newDailyPoints);

                    // UI ì—…ë°ì´íŠ¸
                    const dailyPointsEl = document.getElementById('daily-points');
                    if (dailyPointsEl) dailyPointsEl.textContent = `${newDailyPoints}P`;

                    // ë°ì¼ë¦¬ ë³´ë„ˆìŠ¤ ë©”ì‹œì§€ í‘œì‹œ (ì•½ê°„ì˜ ì§€ì—° í›„ ì‹¤í–‰)
                    setTimeout(() => {
                        console.log('ë°ì¼ë¦¬ ë³´ë„ˆìŠ¤ ë©”ì‹œì§€ í‘œì‹œ ì‹œë„');
                        showDailyBonusMessage();
                    }, 500);
                } catch (error) {
                    console.error('ë°ì¼ë¦¬ í¬ì¸íŠ¸ ì§€ê¸‰ ì˜¤ë¥˜:', error);
                }
            }
        }

        // ë°ì¼ë¦¬ ë³´ë„ˆìŠ¤ ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showDailyBonusMessage() {
            console.log('showDailyBonusMessage í•¨ìˆ˜ ì‹¤í–‰ë¨');

            try {
                // ê¸°ì¡´ ë©”ì‹œì§€ê°€ ìˆìœ¼ë©´ ì œê±°
                const existingMsg = document.getElementById('daily-bonus-message');
                if (existingMsg) {
                    console.log('ê¸°ì¡´ ë©”ì‹œì§€ ì œê±°');
                    existingMsg.remove();
                }

                const existingOverlay = document.getElementById('daily-bonus-overlay');
                if (existingOverlay) {
                    existingOverlay.remove();
                }

                // ìƒˆ ë©”ì‹œì§€ ìƒì„±
                const messageDiv = document.createElement('div');
                messageDiv.id = 'daily-bonus-message';
                messageDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                    padding: 30px 40px;
                    border-radius: 15px;
                    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                    z-index: 10000;
                    text-align: center;
                    font-size: 18px;
                    font-weight: bold;
                    animation: slideIn 0.5s ease-out;
                `;
                messageDiv.innerHTML = `
                    <div style="font-size: 48px; margin-bottom: 15px;">ğŸ</div>
                    <div style="font-size: 24px; margin-bottom: 10px;">ì¼ì¼ ë¡œê·¸ì¸ ë³´ë„ˆìŠ¤!</div>
                    <div style="font-size: 20px; color: #ffd700;">+100 í¬ì¸íŠ¸ ì§€ê¸‰!</div>
                    <div style="font-size: 14px; margin-top: 15px; opacity: 0.9;">ë§¤ì¼ ì ‘ì†í•˜ì—¬ í¬ì¸íŠ¸ë¥¼ ë°›ìœ¼ì„¸ìš”</div>
                `;

                // ë°°ê²½ ì˜¤ë²„ë ˆì´ ìƒì„±
                const overlay = document.createElement('div');
                overlay.id = 'daily-bonus-overlay';
                overlay.style.cssText = `
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0,0,0,0.5);
                    z-index: 9999;
                `;

                // ì• ë‹ˆë©”ì´ì…˜ CSS ì¶”ê°€
                if (!document.getElementById('daily-bonus-animation-style')) {
                    const style = document.createElement('style');
                    style.id = 'daily-bonus-animation-style';
                    style.textContent = `
                        @keyframes slideIn {
                            from {
                                opacity: 0;
                                transform: translate(-50%, -60%);
                            }
                            to {
                                opacity: 1;
                                transform: translate(-50%, -50%);
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }

                // DOMì— ì¶”ê°€
                document.body.appendChild(overlay);
                document.body.appendChild(messageDiv);
                console.log('ë©”ì‹œì§€ DOMì— ì¶”ê°€ ì™„ë£Œ');

                // 3ì´ˆ í›„ ìë™ìœ¼ë¡œ ì‚¬ë¼ì§
                setTimeout(() => {
                    messageDiv.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (messageDiv.parentNode) messageDiv.remove();
                        if (overlay.parentNode) overlay.remove();
                        console.log('ë©”ì‹œì§€ ìë™ ì œê±°ë¨');
                    }, 300);
                }, 3000);

                // í´ë¦­í•˜ë©´ ì¦‰ì‹œ ì‚¬ë¼ì§
                const closeMessage = () => {
                    if (messageDiv.parentNode) messageDiv.remove();
                    if (overlay.parentNode) overlay.remove();
                    console.log('ë©”ì‹œì§€ í´ë¦­ìœ¼ë¡œ ì œê±°ë¨');
                };
                messageDiv.addEventListener('click', closeMessage);
                overlay.addEventListener('click', closeMessage);
            } catch (error) {
                console.error('ë©”ì‹œì§€ í‘œì‹œ ì¤‘ ì˜¤ë¥˜:', error);
            }
        }

        async function usePoints() {
            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return false;
                }

                // Firestoreì—ì„œ í˜„ì¬ í¬ì¸íŠ¸ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
                const userDocRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                const userDoc = await window.firebaseGetDoc(userDocRef);

                if (!userDoc.exists()) {
                    alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return false;
                }

                const userData = userDoc.data();
                let dailyPoints = userData.dailyPoints || 0;
                let walletBalance = userData.walletBalance || 0;

                // í¬ì¸íŠ¸ 17ê°œ ì°¨ê° (ì¼ì¼ í¬ì¸íŠ¸ ìš°ì„  ì‚¬ìš©)
                const pointsToDeduct = 17;
                const totalPoints = dailyPoints + walletBalance;

                if (totalPoints < pointsToDeduct) {
                    alert('í¬ì¸íŠ¸ê°€ ë¶€ì¡±í•©ë‹ˆë‹¤.');
                    return false;
                }

                // ì¼ì¼ í¬ì¸íŠ¸ë¶€í„° ì°¨ê°
                if (dailyPoints >= pointsToDeduct) {
                    dailyPoints -= pointsToDeduct;
                } else {
                    const remaining = pointsToDeduct - dailyPoints;
                    dailyPoints = 0;
                    walletBalance -= remaining;
                }

                // Firestore ì—…ë°ì´íŠ¸
                await window.firebaseSetDoc(userDocRef, {
                    dailyPoints: dailyPoints,
                    walletBalance: walletBalance
                }, { merge: true });

                // í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
                updatePointsDisplay();
                return true;
            } catch (error) {
                console.error('í¬ì¸íŠ¸ ì‚¬ìš© ì˜¤ë¥˜:', error);
                alert('í¬ì¸íŠ¸ ì‚¬ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                return false;
            }
        }


        // ğŸ’¡ handleUpload í•¨ìˆ˜ ìˆ˜ì •: FormDataì— category ì¶”ê°€
        async function handleUpload(event) {
            event.preventDefault();

            const musicNameInput = document.getElementById('musicName');
            const categoryInput = document.getElementById('musicCategory');

            if (!musicNameInput || !categoryInput) {
                alert('ì—…ë¡œë“œ í¼ì´ ì˜¬ë°”ë¥´ê²Œ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                return;
            }

            const musicName = musicNameInput.value;
            const category = categoryInput.value;
            const audioFile = document.getElementById('audioFile').files[0];
            const imageFiles = document.getElementById('imageFiles').files;

            if (!musicName.trim()) {
                alert('ìŒì•… ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            if (!audioFile) {
                alert('ìŒì› íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            if (imageFiles.length === 0) {
                alert('ì´ë¯¸ì§€ íŒŒì¼ì„ í•œ ê°œ ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const user = window.firebaseAuth.currentUser;
            if (!user) {
                alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                return;
            }

            // ë¡œë”© í‘œì‹œ
            const uploadButton = event.target.querySelector('button[type="submit"]');
            const originalButtonText = uploadButton.textContent;
            uploadButton.disabled = true;
            uploadButton.textContent = 'ì—…ë¡œë“œ ì¤‘...';

            try {
                // ì´ë¯¸ì§€ íŒŒì¼ì„ íŒŒì¼ëª… ìˆœìœ¼ë¡œ ì •ë ¬
                const sortedImageFiles = Array.from(imageFiles).sort((a, b) => {
                    return a.name.localeCompare(b.name);
                });

                // 1. Firebase Storageì— ì˜¤ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ (gallery ê²½ë¡œ)
                const audioFileName = `gallery/audio/${Date.now()}_${audioFile.name}`;
                const audioRef = window.firebaseStorageRef(window.firebaseStorage, audioFileName);
                await window.firebaseUploadBytes(audioRef, audioFile);
                const audioUrl = await window.firebaseGetDownloadURL(audioRef);

                // 2. Firebase Storageì— ì´ë¯¸ì§€ íŒŒì¼ë“¤ ì—…ë¡œë“œ (gallery ê²½ë¡œ)
                const imageUrls = [];
                for (let i = 0; i < sortedImageFiles.length; i++) {
                    const imageFile = sortedImageFiles[i];
                    const imageFileName = `gallery/images/${Date.now()}_${i}_${imageFile.name}`;
                    const imageRef = window.firebaseStorageRef(window.firebaseStorage, imageFileName);
                    await window.firebaseUploadBytes(imageRef, imageFile);
                    const imageUrl = await window.firebaseGetDownloadURL(imageRef);
                    imageUrls.push(imageUrl);
                }

                // 3. Firestoreì— ìŒì•… ì •ë³´ ì €ì¥
                const musicData = {
                    name: musicName,
                    audioSrc: audioUrl,
                    category: category,
                    images: imageUrls.map((url, index) => ({
                        imageSrc: url,
                        order: index
                    })),
                    uploadedBy: user.uid,
                    uploadedAt: new Date().toISOString(),
                    isRecommended: 0
                };

                const musicRef = await window.firebaseAddDoc(
                    window.firebaseCollection(window.firebaseDb, 'music'),
                    musicData
                );

                console.log('ì—…ë¡œë“œ ì™„ë£Œ:', musicRef.id);

                // ì—…ë¡œë“œ ì„±ê³µ ë©”ì‹œì§€ í‘œì‹œ
                alert(`ì—…ë¡œë“œ ì„±ê³µ!\n\nìŒì•… ì œëª©: ${musicName}\nì¹´í…Œê³ ë¦¬: ${category}\nì´ë¯¸ì§€: ${imageUrls.length}ê°œ`);

                // ì—…ë¡œë“œì°½ ë‹«ê¸° ë° ê°¤ëŸ¬ë¦¬ë¡œ ë³µê·€
                hideAllPanelsExcept('gallery-placeholder');

                // ìŒì•… ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                await loadMusicDataFromServer();

                console.log('ì—…ë¡œë“œ ì™„ë£Œ í›„ ì²˜ë¦¬ ì™„ë£Œ');

            } catch (error) {
                console.error('ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì—…ë¡œë“œ ì‹¤íŒ¨: ' + error.message);
            } finally {
                // ë¡œë”© í‘œì‹œ ì œê±°
                if (uploadButton) {
                    uploadButton.disabled = false;
                    uploadButton.textContent = originalButtonText;
                }
            }
        }
        
        // ìŒì•… í¸ì§‘ í•¨ìˆ˜
        async function handleEdit(event, musicId) {
            event.preventDefault();
            const musicName = document.getElementById('editMusicName').value;
            const categoryName = document.getElementById('editCategoryName').value;
            const autoplayTimingValue = document.getElementById('editAutoplayTiming').value;
            const audioFile = document.getElementById('editAudioFile').files[0];
            const imageFiles = document.getElementById('editImageFiles').files;

            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                const musicRef = window.firebaseDoc(window.firebaseDb, 'music', musicId);
                const musicDoc = await window.firebaseGetDoc(musicRef);

                if (!musicDoc.exists()) {
                    alert('ìŒì•…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const updateData = {
                    name: musicName,
                    category: categoryName
                };

                // autoplayTiming ì²˜ë¦¬ (ê°’ì´ ìˆê³  ìœ íš¨í•œ ë²”ìœ„ë©´ ì¶”ê°€)
                if (autoplayTimingValue !== '') {
                    const timing = parseInt(autoplayTimingValue);
                    if (!isNaN(timing) && timing >= 1 && timing <= 60) {
                        updateData.autoplayTiming = timing;
                    }
                }

                const currentData = musicDoc.data();
                const oldAudioSrc = currentData.audioSrc;

                // ì˜¤ë””ì˜¤ íŒŒì¼ì´ ì„ íƒëœ ê²½ìš° ê¸°ì¡´ íŒŒì¼ ì‚­ì œ í›„ ìƒˆ íŒŒì¼ ì—…ë¡œë“œ
                if (audioFile) {
                    console.log('ìƒˆë¡œìš´ ì˜¤ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘...');

                    // 1. ê¸°ì¡´ ì˜¤ë””ì˜¤ íŒŒì¼ ì‚­ì œ
                    if (oldAudioSrc && oldAudioSrc.includes('firebasestorage.googleapis.com')) {
                        try {
                            const url = new URL(oldAudioSrc);
                            const pathMatch = url.pathname.match(/\/o\/(.+?)(\?|$)/);

                            if (pathMatch) {
                                const filePath = decodeURIComponent(pathMatch[1]);
                                const oldAudioRef = window.firebaseStorageRef(window.firebaseStorage, filePath);
                                await window.firebaseDeleteObject(oldAudioRef);
                                console.log('ê¸°ì¡´ ì˜¤ë””ì˜¤ íŒŒì¼ ì‚­ì œ ì™„ë£Œ:', filePath);
                            }
                        } catch (deleteError) {
                            console.warn('ê¸°ì¡´ ì˜¤ë””ì˜¤ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨ (ê³„ì† ì§„í–‰):', deleteError.message);
                        }
                    }

                    // 2. ìƒˆ ì˜¤ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ (gallery ê²½ë¡œ)
                    const audioFileName = `gallery/audio/${Date.now()}_${audioFile.name}`;
                    const audioRef = window.firebaseStorageRef(window.firebaseStorage, audioFileName);
                    await window.firebaseUploadBytes(audioRef, audioFile);
                    const audioUrl = await window.firebaseGetDownloadURL(audioRef);
                    updateData.audioSrc = audioUrl;
                    console.log('ìƒˆë¡œìš´ ì˜¤ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ:', audioFileName);
                }

                // ì´ë¯¸ì§€ íŒŒì¼ì´ ì„ íƒëœ ê²½ìš° ì—…ë¡œë“œ ë° ì¶”ê°€
                if (imageFiles.length > 0) {
                    const sortedImageFiles = Array.from(imageFiles).sort((a, b) => {
                        return a.name.localeCompare(b.name);
                    });

                    const existingImages = currentData.images || [];
                    const newImages = [];

                    for (let i = 0; i < sortedImageFiles.length; i++) {
                        const imageFile = sortedImageFiles[i];
                        const imageFileName = `gallery/images/${Date.now()}_${i}_${imageFile.name}`;
                        const imageRef = window.firebaseStorageRef(window.firebaseStorage, imageFileName);
                        await window.firebaseUploadBytes(imageRef, imageFile);
                        const imageUrl = await window.firebaseGetDownloadURL(imageRef);
                        newImages.push({
                            imageSrc: imageUrl,
                            order: existingImages.length + i
                        });
                    }

                    // ê¸°ì¡´ ì´ë¯¸ì§€ì— ìƒˆ ì´ë¯¸ì§€ ì¶”ê°€
                    updateData.images = [...existingImages, ...newImages];
                }

                // Firestore ì—…ë°ì´íŠ¸
                await window.firebaseSetDoc(musicRef, updateData, { merge: true });
                console.log('Firestore ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì™„ë£Œ');

                // ì„±ê³µ ë©”ì‹œì§€ ìƒì„±
                let successMessage = 'ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                if (audioFile) {
                    successMessage += '\n\nâœ“ ê¸°ì¡´ ì˜¤ë””ì˜¤ íŒŒì¼ ì‚­ì œë¨\nâœ“ ìƒˆ ì˜¤ë””ì˜¤ íŒŒì¼ ì—…ë¡œë“œë¨';
                }
                if (imageFiles.length > 0) {
                    successMessage += `\nâœ“ ${imageFiles.length}ê°œì˜ ì´ë¯¸ì§€ ì¶”ê°€ë¨`;
                }

                alert(successMessage);
                hideAllPanelsExcept('gallery-placeholder');
                loadMusicDataFromServer();
            } catch (error) {
                console.error('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜:', error);
                alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }
        
        // **ì¶”ê°€ëœ í•¨ìˆ˜: ìŒì› ì‚­ì œ ê¸°ëŠ¥**
        async function deleteMusic(musicId) {
            if (!confirm('ìŒì›ê³¼ ëª¨ë“  ê´€ë ¨ ì´ë¯¸ì§€ë¥¼ ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìœ¼ë©°, Firebase Storageì˜ ëª¨ë“  íŒŒì¼ë„ ì˜êµ¬ì ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤.')) {
                return;
            }

            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                console.log('ìŒì•… ì‚­ì œ ì‹œì‘:', musicId);

                // 1. Firestoreì—ì„œ ìŒì•… ë¬¸ì„œ ê°€ì ¸ì˜¤ê¸°
                const musicRef = window.firebaseDoc(window.firebaseDb, 'music', musicId);
                const musicDoc = await window.firebaseGetDoc(musicRef);

                if (!musicDoc.exists()) {
                    alert('ìŒì•…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const musicData = musicDoc.data();
                const images = musicData.images || [];
                const audioSrc = musicData.audioSrc;

                console.log('=== ìŒì•… ì‚­ì œ ìƒì„¸ ì •ë³´ ===');
                console.log('ìŒì•… ID:', musicId);
                console.log('ì´ë¯¸ì§€ ë°°ì—´:', images);
                console.log('ì´ë¯¸ì§€ ê°œìˆ˜:', images.length);
                console.log('ì˜¤ë””ì˜¤ URL:', audioSrc);

                let deletedImagesCount = 0;
                let failedImagesCount = 0;

                // 2. Firebase Storageì—ì„œ ëª¨ë“  ì´ë¯¸ì§€ íŒŒì¼ ì‚­ì œ
                if (images && images.length > 0) {
                    console.log(`${images.length}ê°œì˜ ì´ë¯¸ì§€ ì‚­ì œ ì‹œì‘...`);

                    for (const image of images) {
                        console.log('ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘:', image);

                        if (image && image.imageSrc) {
                            console.log('ì´ë¯¸ì§€ URL:', image.imageSrc);

                            if (image.imageSrc.includes('firebasestorage.googleapis.com')) {
                                try {
                                    // URLì—ì„œ íŒŒì¼ ê²½ë¡œ ì¶”ì¶œ
                                    const url = new URL(image.imageSrc);
                                    const pathMatch = url.pathname.match(/\/o\/(.+?)(\?|$)/);

                                    if (pathMatch) {
                                        const filePath = decodeURIComponent(pathMatch[1]);
                                        console.log('ì‚­ì œí•  íŒŒì¼ ê²½ë¡œ:', filePath);

                                        const fileRef = window.firebaseStorageRef(window.firebaseStorage, filePath);

                                        await window.firebaseDeleteObject(fileRef);
                                        deletedImagesCount++;
                                        console.log('âœ“ ì´ë¯¸ì§€ íŒŒì¼ ì‚­ì œ ì™„ë£Œ:', filePath);
                                    } else {
                                        console.warn('ê²½ë¡œ ì¶”ì¶œ ì‹¤íŒ¨:', image.imageSrc);
                                    }
                                } catch (storageError) {
                                    failedImagesCount++;
                                    console.error('âœ— ì´ë¯¸ì§€ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:', storageError);
                                }
                            } else {
                                console.warn('Firebase Storage URLì´ ì•„ë‹˜:', image.imageSrc);
                            }
                        } else {
                            console.warn('ì´ë¯¸ì§€ URLì´ ì—†ìŒ:', image);
                        }
                    }

                    console.log(`ì´ë¯¸ì§€ ì‚­ì œ ì™„ë£Œ: ì„±ê³µ ${deletedImagesCount}ê°œ, ì‹¤íŒ¨ ${failedImagesCount}ê°œ`);
                } else {
                    console.log('ì‚­ì œí•  ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }

                // 3. Firebase Storageì—ì„œ ì˜¤ë””ì˜¤ íŒŒì¼ ì‚­ì œ
                let audioDeleted = false;
                if (audioSrc && audioSrc.includes('firebasestorage.googleapis.com')) {
                    console.log('ì˜¤ë””ì˜¤ íŒŒì¼ ì‚­ì œ ì‹œì‘:', audioSrc);
                    try {
                        const url = new URL(audioSrc);
                        const pathMatch = url.pathname.match(/\/o\/(.+?)(\?|$)/);

                        if (pathMatch) {
                            const filePath = decodeURIComponent(pathMatch[1]);
                            console.log('ì‚­ì œí•  ì˜¤ë””ì˜¤ íŒŒì¼ ê²½ë¡œ:', filePath);

                            const fileRef = window.firebaseStorageRef(window.firebaseStorage, filePath);

                            await window.firebaseDeleteObject(fileRef);
                            audioDeleted = true;
                            console.log('âœ“ ì˜¤ë””ì˜¤ íŒŒì¼ ì‚­ì œ ì™„ë£Œ:', filePath);
                        } else {
                            console.warn('ì˜¤ë””ì˜¤ ê²½ë¡œ ì¶”ì¶œ ì‹¤íŒ¨:', audioSrc);
                        }
                    } catch (storageError) {
                        console.error('âœ— ì˜¤ë””ì˜¤ íŒŒì¼ ì‚­ì œ ì‹¤íŒ¨:', storageError);
                    }
                } else {
                    console.log('ì‚­ì œí•  ì˜¤ë””ì˜¤ê°€ ì—†ê±°ë‚˜ Firebase Storage URLì´ ì•„ë‹™ë‹ˆë‹¤.');
                }

                // 4. Firestoreì—ì„œ ìŒì•… ë¬¸ì„œ ì™„ì „íˆ ì‚­ì œ
                await window.firebaseDeleteDoc(musicRef);
                console.log('âœ“ Firestore ë¬¸ì„œ ì‚­ì œ ì™„ë£Œ:', musicId);

                // 5. UI ì—…ë°ì´íŠ¸
                const totalImages = images.length;
                const deleteMessage = `ê°¤ëŸ¬ë¦¬ê°€ ì™„ì „íˆ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.\n\n` +
                    `ì „ì²´ ì´ë¯¸ì§€: ${totalImages}ê°œ\n` +
                    `ì‚­ì œ ì„±ê³µ: ${deletedImagesCount}ê°œ\n` +
                    `ì‚­ì œ ì‹¤íŒ¨: ${failedImagesCount}ê°œ\n` +
                    `ì˜¤ë””ì˜¤: ${audioDeleted ? 'ì‚­ì œ ì™„ë£Œ' : (audioSrc ? 'ì‚­ì œ ì‹¤íŒ¨' : 'ì—†ìŒ')}`;

                alert(deleteMessage);

                // ê°¤ëŸ¬ë¦¬ ë‹«ê¸°
                hideAllPanelsExcept('gallery-placeholder');
                document.getElementById('gallery-placeholder').innerHTML = '<p>ê°¤ëŸ¬ë¦¬ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.</p>';

                // ìŒì•… ëª©ë¡ ìƒˆë¡œê³ ì¹¨
                loadMusicDataFromServer();

            } catch (error) {
                console.error('ì‚­ì œ ì˜¤ë¥˜:', error);
                alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        document.addEventListener('DOMContentLoaded', async () => {
            // ë‚´ëª©ë¡ ì´ˆê¸°í™” (ì„œë²„ì—ì„œ ê´€ë¦¬í•˜ë¯€ë¡œ ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ ì œê±°)
            mySavedMusic = [];

            // Firestoreì—ì„œ ì¹´í…Œê³ ë¦¬ ë¯¸ë¦¬ ë¡œë“œ
            await loadCategoriesFromFirestore();

            checkLoginStatus();
            document.getElementById('copy-link-button').addEventListener('click', copyToClipboard);

            // ëª¨ë°”ì¼ ë°˜ì‘í˜• ì²´í¬
            checkMobileOrientation();

            // í™”ë©´ í¬ê¸° ë³€ê²½ ë° ë°©í–¥ ë³€ê²½ ê°ì§€
            window.addEventListener('resize', () => {
                setTimeout(checkMobileOrientation, 100);
            });

            window.addEventListener('orientationchange', () => {
                setTimeout(checkMobileOrientation, 500);
            });

            // ì´ˆê¸° ë¡œë“œ ì‹œì—ë„ ë°©í–¥ ì²´í¬
            setTimeout(checkMobileOrientation, 1000);

            const toggleLikedButton = document.getElementById('toggle-likes');
            if (toggleLikedButton) {
                toggleLikedButton.addEventListener('click', () => {
                    toggleLikedView();
                    updateButtonStyles();
                });
            }

            // ì¹´í…Œê³ ë¦¬ ì—…ë°ì´íŠ¸ ê°ì§€ (ê´€ë¦¬ì í˜ì´ì§€ì—ì„œ ë³€ê²½ ì‹œ)
            window.addEventListener('storage', (e) => {
                if (e.key === 'categoryUpdateEvent') {
                    console.log('ì¹´í…Œê³ ë¦¬ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ ëª©ë¡ì„ ê°±ì‹ í•©ë‹ˆë‹¤.');
                    loadMusicDataFromServer(); // ì „ì²´ ë°ì´í„° ìƒˆë¡œê³ ì¹¨
                }
            });

            const fullViewButton = document.getElementById('toggle-full-view');
            if (fullViewButton) {
                fullViewButton.addEventListener('click', () => {
                    toggleFullView();
                    updateButtonStyles();
                });
            }

            // ğŸ’¡ í‚¤ë³´ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
            document.addEventListener('keydown', (event) => {
                // Escape í‚¤ë¥¼ ê°ì§€í•˜ëŠ” ë¡œì§
                if (event.key === 'Escape' || event.keyCode === 27) {
                    if (isMobilePortraitMode) {
                        exitMobilePortraitMode();
                    } else if (isFullViewMode) {
                        toggleFullView();
                    }
                }
            });

            // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œì—ì„œ ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ì²˜ë¦¬
            // ê°¤ëŸ¬ë¦¬ê°€ ì—´ë¦´ ë•Œ íˆìŠ¤í† ë¦¬ì— ìƒíƒœ ì¶”ê°€
            let galleryHistoryAdded = false;

            // ë’¤ë¡œê°€ê¸° ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            window.addEventListener('popstate', (event) => {
                const isMobile = window.innerWidth <= 768;
                const isPortrait = window.innerHeight > window.innerWidth;

                // ëª¨ë°”ì¼ ì„¸ë¡œëª¨ë“œì—ì„œ ë’¤ë¡œê°€ê¸° ë™ì‘
                if (isMobile && isPortrait && isMobilePortraitMode) {
                    // ì„¸ë¡œëª¨ë“œë§Œ í•´ì œí•˜ê³  ê°¤ëŸ¬ë¦¬ëŠ” ìœ ì§€ (ëª©ë¡ í™”ë©´ìœ¼ë¡œ ë³µê·€í•˜ë˜ ì¬ìƒì€ ê³„ì†)
                    disableMobilePortraitMode();

                    // ê°¤ëŸ¬ë¦¬ë¥¼ ìˆ¨ê¸°ì§€ ì•Šê³  ëª©ë¡ í™”ë©´ìœ¼ë¡œë§Œ ì „í™˜
                    // hideGallery()ë¥¼ í˜¸ì¶œí•˜ì§€ ì•Šì•„ ì¬ìƒ ì¤‘ì¸ ìŒì•…ê³¼ ê°¤ëŸ¬ë¦¬ ì •ë³´ê°€ ìœ ì§€ë¨

                    // ì¶”ê°€ ë’¤ë¡œê°€ê¸° ë°©ì§€ë¥¼ ìœ„í•´ í˜„ì¬ ìƒíƒœë¥¼ ë‹¤ì‹œ í‘¸ì‹œ
                    window.history.pushState({ listView: true }, '');
                }
            });
        });

        // ìƒˆë¡œìš´ ìˆœì„œ ë²ˆí˜¸ë¥¼ ë°›ì•„ ì´ë¯¸ì§€ ìˆœì„œë¥¼ ë³€ê²½í•˜ëŠ” í•¨ìˆ˜
        async function reorderImageToOrder(musicId, imageId, newOrder, event) {
            if (event) {
                event.stopPropagation();
            }

            if (!musicId) {
                alert("ìŒì•… IDê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.");
                return;
            }

            try {
                // Firestoreì—ì„œ í˜„ì¬ ìŒì•… ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const musicRef = window.firebaseDoc(window.firebaseDb, 'music', musicId);
                const musicDoc = await window.firebaseGetDoc(musicRef);

                if (!musicDoc.exists()) {
                    alert('ìŒì•… ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const musicData = musicDoc.data();
                const images = musicData.images || [];

                console.log('ìˆœì„œ ë³€ê²½ ì‹œì‘:', { musicId, imageId, newOrder });
                console.log('í˜„ì¬ ì´ë¯¸ì§€ ë°°ì—´:', images.map((img, idx) => ({ idx, id: img.id, src: img.imageSrc?.substring(0, 50) })));

                // ì´ë¯¸ì§€ì— IDê°€ ì—†ìœ¼ë©´ ìƒì„±
                const imagesWithIds = images.map((img, idx) => ({
                    ...img,
                    id: img.id || `${musicId}_${idx}`
                }));

                // í˜„ì¬ ì´ë¯¸ì§€ì˜ ì¸ë±ìŠ¤ ì°¾ê¸°
                const currentIndex = imagesWithIds.findIndex(img => img.id === imageId);

                console.log('ì°¾ì€ ì´ë¯¸ì§€ ì¸ë±ìŠ¤:', currentIndex, 'íƒ€ê²Ÿ ì´ë¯¸ì§€ ID:', imageId);

                if (currentIndex === -1) {
                    alert('ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ID: ' + imageId);
                    console.error('ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ:', { imageId, availableIds: imagesWithIds.map(img => img.id) });
                    return;
                }

                // ìƒˆ ìˆœì„œëŠ” 1ë¶€í„° ì‹œì‘í•˜ë¯€ë¡œ 0-based ì¸ë±ìŠ¤ë¡œ ë³€í™˜
                const targetIndex = newOrder - 1;

                if (targetIndex < 0 || targetIndex >= images.length) {
                    alert('ìœ íš¨í•œ ìˆœì„œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                    return;
                }

                if (currentIndex === targetIndex) {
                    alert('ì´ë¯¸ í•´ë‹¹ ìœ„ì¹˜ì— ìˆìŠµë‹ˆë‹¤.');
                    return;
                }

                // ì´ë¯¸ì§€ë¥¼ ìƒˆ ìœ„ì¹˜ë¡œ ì´ë™ (ë°°ì—´ ì¬ì •ë ¬)
                const [movedImage] = imagesWithIds.splice(currentIndex, 1);
                imagesWithIds.splice(targetIndex, 0, movedImage);

                console.log('ì´ë™ í›„ ì´ë¯¸ì§€ ë°°ì—´:', imagesWithIds.map((img, idx) => ({ idx, id: img.id, src: img.imageSrc?.substring(0, 50) })));

                // order ì†ì„± ì—…ë°ì´íŠ¸ ë° ID ë³´ì¡´
                const finalImages = imagesWithIds.map((img, idx) => ({
                    ...img,
                    order: idx,
                    id: img.id // ID ë³´ì¡´
                }));

                console.log('Firestoreì— ì €ì¥í•  ì´ë¯¸ì§€:', finalImages.map((img, idx) => ({ idx, id: img.id, order: img.order })));

                // Firestore ì—…ë°ì´íŠ¸
                await window.firebaseSetDoc(musicRef, { images: finalImages }, { merge: true });

                console.log('ì´ë¯¸ì§€ ìˆœì„œê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');

                // ê°¤ëŸ¬ë¦¬ ë·° ê°±ì‹  (ë³€ê²½ëœ ì´ë¯¸ì§€ ìœ„ì¹˜ë¡œ ì´ë™)
                await updateGalleryView(musicId, imageId);

            } catch (error) {
                console.error('ì´ë¯¸ì§€ ìˆœì„œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜:', error);
                alert('ì´ë¯¸ì§€ ìˆœì„œ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // Firestoreì—ì„œ ìµœì‹  ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ ê°¤ëŸ¬ë¦¬ ë·°ë¥¼ ê°±ì‹ í•˜ëŠ” í•¨ìˆ˜
        async function updateGalleryView(musicId, targetImageId) {
            try {
                // Firestoreì—ì„œ ìŒì•… ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
                const musicRef = window.firebaseDoc(window.firebaseDb, 'music', musicId);
                const musicDoc = await window.firebaseGetDoc(musicRef);

                if (!musicDoc.exists()) {
                    console.error("ê°¤ëŸ¬ë¦¬ ë·° ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ìŒì•…ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
                    hideAllPanelsExcept('gallery-placeholder');
                    document.getElementById('gallery-placeholder').textContent = 'ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.';
                    return;
                }

                const currentMusic = musicDoc.data();
                const updatedImages = currentMusic.images || [];

                if (updatedImages.length > 0) {
                    // ì´ë¯¸ì§€ ID ìƒì„± ë° ë§¤ì¹­
                    const imagesWithIds = updatedImages.map((img, idx) => ({
                        ...img,
                        id: img.id || `${musicId}_${idx}`
                    }));

                    // mySunoMusic ë°°ì—´ ì—…ë°ì´íŠ¸
                    const musicIndexInList = mySunoMusic.findIndex(music => (music.musicId || music.id) === musicId);
                    if (musicIndexInList !== -1) {
                        mySunoMusic[musicIndexInList].images = imagesWithIds;
                    }

                    // íƒ€ê²Ÿ ì´ë¯¸ì§€ì˜ ìƒˆë¡œìš´ ìœ„ì¹˜ ì°¾ê¸°
                    const targetIndex = imagesWithIds.findIndex(img => img.id == targetImageId);
                    const finalIndex = targetIndex >= 0 ? targetIndex : 0;

                    console.log('ìˆœì„œ ë³€ê²½ í›„ ì´ë¯¸ì§€ ìœ„ì¹˜:', {
                        targetImageId,
                        newPosition: finalIndex + 1,
                        totalImages: imagesWithIds.length
                    });

                    // currentGalleryInfo ì—…ë°ì´íŠ¸
                    if (currentGalleryInfo && currentGalleryInfo.musicId === musicId) {
                        currentGalleryInfo.images = imagesWithIds;
                    }

                    // ìë™ ì „í™˜ ì¤‘ì§€
                    if (isAutoTransitioning) {
                        isAutoTransitioning = false;
                        if (currentImageInterval) {
                            clearInterval(currentImageInterval);
                        }
                    }

                    // ê°¤ëŸ¬ë¦¬ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì§€ ì•Šê³  in-placeë¡œ ì—…ë°ì´íŠ¸
                    const galleryItems = document.querySelectorAll('#image-gallery .gallery-item');
                    const imageGallery = document.getElementById('image-gallery');

                    if (galleryItems.length === imagesWithIds.length) {
                        // ì´ë¯¸ì§€ ê°œìˆ˜ê°€ ê°™ìœ¼ë©´ ìˆœì„œë§Œ ì—…ë°ì´íŠ¸ (ë” ë¶€ë“œëŸ¬ì›€)
                        galleryItems.forEach((item, idx) => {
                            const img = item.querySelector('img');
                            if (img && imagesWithIds[idx]) {
                                img.src = imagesWithIds[idx].imageSrc;
                                item.setAttribute('data-image-id', imagesWithIds[idx].id);
                            }
                        });

                        // í™œì„± ì´ë¯¸ì§€ ë³€ê²½ - ë³€ê²½ëœ ìˆœì„œë¡œ ì´ë™
                        galleryItems.forEach(item => item.classList.remove('active'));
                        if (galleryItems[finalIndex]) {
                            galleryItems[finalIndex].classList.add('active');
                            currentImageIndex = finalIndex;
                            console.log(`ê°¤ëŸ¬ë¦¬ë¥¼ ${finalIndex + 1}ë²ˆì§¸ ì´ë¯¸ì§€ë¡œ ì´ë™í–ˆìŠµë‹ˆë‹¤.`);
                        }

                        // ìˆœì„œ í‘œì‹œ ì—…ë°ì´íŠ¸
                        updateImageOrderDisplay();

                        // ì‹œê°ì  í”¼ë“œë°±: ë©”ì‹œì§€ í‘œì‹œ
                        showGalleryMessage(`ì´ë¯¸ì§€ ìˆœì„œê°€ ${finalIndex + 1}ë²ˆìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 1500);
                    } else {
                        // ì´ë¯¸ì§€ ê°œìˆ˜ê°€ ë‹¤ë¥´ë©´ ì „ì²´ ê°¤ëŸ¬ë¦¬ ìƒˆë¡œê³ ì¹¨
                        showGalleryWithIndex(
                            musicId,
                            imagesWithIds,
                            finalIndex,
                            currentMusic.audioSrc,
                            currentMusic.name,
                            currentMusic.createdBy
                        );
                    }

                    console.log('ê°¤ëŸ¬ë¦¬ ë·° ì—…ë°ì´íŠ¸ ì™„ë£Œ - ìˆœì„œ ë³€ê²½ ë°˜ì˜ë¨');
                } else {
                    hideAllPanelsExcept('gallery-placeholder');
                    document.getElementById('gallery-placeholder').textContent = 'ì´ ìŒì•…ì—ëŠ” ì´ë¯¸ì§€ê°€ ì—†ìŠµë‹ˆë‹¤.';
                }

            } catch (error) {
                console.error("ê°¤ëŸ¬ë¦¬ ë·° ì—…ë°ì´íŠ¸ ì¤‘ ì˜¤ë¥˜:", error);
                hideAllPanelsExcept('gallery-placeholder');
                document.getElementById('gallery-placeholder').textContent = 'ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
        }

        // êµ¬ë… íŒì—… í‘œì‹œ í•¨ìˆ˜
        // í¬ì¸íŠ¸ êµ¬ë§¤ íŒì—… í‘œì‹œ í•¨ìˆ˜
        function showPointsPurchasePopup() {
            // ê¸°ì¡´ íŒì—… ì œê±°
            const existingPopup = document.getElementById('points-purchase-popup');
            if (existingPopup) {
                existingPopup.remove();
            }

            // íŒì—… ìƒì„±
            const popup = document.createElement('div');
            popup.id = 'points-purchase-popup';
            popup.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.8);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10000;
            `;

            popup.innerHTML = `
                <div style="background: white; border-radius: 20px; padding: 40px; max-width: 600px; width: 90%; max-height: 80vh; overflow-y: auto;">
                    <h2 style="margin-bottom: 30px; color: #333; text-align: center; font-size: 28px;">ğŸ’ í¬ì¸íŠ¸ êµ¬ë§¤</h2>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="points-package" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 15px; padding: 25px; text-align: center; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" onclick="purchasePoints(100, 1000)">
                            <div style="font-size: 40px; margin-bottom: 10px;">âš¡</div>
                            <div style="font-size: 24px; font-weight: bold; color: white; margin-bottom: 5px;">100P</div>
                            <div style="font-size: 18px; color: #ffd700;">â‚©1,000</div>
                        </div>

                        <div class="points-package" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border-radius: 15px; padding: 25px; text-align: center; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" onclick="purchasePoints(550, 5000)">
                            <div style="font-size: 40px; margin-bottom: 10px;">ğŸ’«</div>
                            <div style="font-size: 24px; font-weight: bold; color: white; margin-bottom: 5px;">550P</div>
                            <div style="font-size: 18px; color: #ffd700;">â‚©5,000</div>
                            <div style="font-size: 12px; color: white; opacity: 0.9; margin-top: 5px;">+10% ë³´ë„ˆìŠ¤</div>
                        </div>

                        <div class="points-package" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); border-radius: 15px; padding: 25px; text-align: center; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" onclick="purchasePoints(1200, 10000)">
                            <div style="font-size: 40px; margin-bottom: 10px;">â­</div>
                            <div style="font-size: 24px; font-weight: bold; color: white; margin-bottom: 5px;">1,200P</div>
                            <div style="font-size: 18px; color: #ffd700;">â‚©10,000</div>
                            <div style="font-size: 12px; color: white; opacity: 0.9; margin-top: 5px;">+20% ë³´ë„ˆìŠ¤</div>
                        </div>

                        <div class="points-package" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); border-radius: 15px; padding: 25px; text-align: center; cursor: pointer; transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'" onclick="purchasePoints(3000, 25000)">
                            <div style="font-size: 40px; margin-bottom: 10px;">ğŸŒŸ</div>
                            <div style="font-size: 24px; font-weight: bold; color: white; margin-bottom: 5px;">3,000P</div>
                            <div style="font-size: 18px; color: #ff6b6b;">â‚©25,000</div>
                            <div style="font-size: 12px; color: white; opacity: 0.9; margin-top: 5px;">+50% ë³´ë„ˆìŠ¤</div>
                        </div>
                    </div>

                    <div style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px;">
                        <h3 style="color: #333; margin-bottom: 10px; font-size: 18px;">ğŸ“‹ í¬ì¸íŠ¸ ì‚¬ìš© ì•ˆë‚´</h3>
                        <ul style="color: #666; line-height: 1.8; padding-left: 20px; margin: 0;">
                            <li>ê°¤ëŸ¬ë¦¬ 1íšŒ ì ‘ê·¼ ì‹œ 17P ì°¨ê°</li>
                            <li>ì¼ì¼ ë¡œê·¸ì¸ ë³´ë„ˆìŠ¤ 60P ì§€ê¸‰</li>
                            <li>êµ¬ë§¤í•œ í¬ì¸íŠ¸ëŠ” ì˜êµ¬ ë³´ê´€ë©ë‹ˆë‹¤</li>
                        </ul>
                    </div>

                    <button onclick="hidePointsPurchasePopup()" style="width: 100%; padding: 15px; background: #95a5a6; color: white; border: none; border-radius: 10px; font-size: 16px; cursor: pointer; transition: background 0.3s;" onmouseover="this.style.background='#7f8c8d'" onmouseout="this.style.background='#95a5a6'">
                        ë‹«ê¸°
                    </button>
                </div>
            `;

            // íŒì—… ë‹«ê¸° (ë°°ê²½ í´ë¦­)
            popup.addEventListener('click', (e) => {
                if (e.target === popup) {
                    hidePointsPurchasePopup();
                }
            });

            document.body.appendChild(popup);
            document.body.style.overflow = 'hidden';
        }

        // í¬ì¸íŠ¸ êµ¬ë§¤ íŒì—… ë‹«ê¸° í•¨ìˆ˜
        function hidePointsPurchasePopup() {
            const popup = document.getElementById('points-purchase-popup');
            if (popup) {
                popup.remove();
                document.body.style.overflow = 'auto';
            }
        }

        // í¬ì¸íŠ¸ êµ¬ë§¤ ì²˜ë¦¬ í•¨ìˆ˜
        async function purchasePoints(points, price) {
            // ì‹¤ì œ ê²°ì œ ì—°ë™ ì‹œ ì—¬ê¸°ì— ê²°ì œ ë¡œì§ ì¶”ê°€
            // í˜„ì¬ëŠ” ë°ëª¨ ë²„ì „ìœ¼ë¡œ ë°”ë¡œ í¬ì¸íŠ¸ ì§€ê¸‰
            const confirmed = confirm(`${points}Pë¥¼ â‚©${price.toLocaleString()}ì— êµ¬ë§¤í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n(ë°ëª¨ ë²„ì „: ì‹¤ì œ ê²°ì œ ì—†ì´ í¬ì¸íŠ¸ê°€ ì§€ê¸‰ë©ë‹ˆë‹¤)`);

            if (!confirmed) return;

            try {
                const user = window.firebaseAuth.currentUser;
                if (!user) {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    return;
                }

                // Firestoreì—ì„œ í˜„ì¬ í¬ì¸íŠ¸ ê°€ì ¸ì˜¤ê¸°
                const userDocRef = window.firebaseDoc(window.firebaseDb, 'users', user.uid);
                const userDoc = await window.firebaseGetDoc(userDocRef);

                if (!userDoc.exists()) {
                    alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                    return;
                }

                const userData = userDoc.data();
                const currentWalletBalance = userData.walletBalance || 0;
                const newWalletBalance = currentWalletBalance + points;

                // í¬ì¸íŠ¸ ì—…ë°ì´íŠ¸
                await window.firebaseSetDoc(userDocRef, {
                    walletBalance: newWalletBalance
                }, { merge: true });

                // ê±°ë˜ ë‚´ì—­ ì¶”ê°€
                const transactionRef = window.firebaseCollection(window.firebaseDb, 'pointTransactions');
                await window.firebaseAddDoc(transactionRef, {
                    userId: user.uid,
                    type: 'purchase',
                    amount: points,
                    price: price,
                    description: `í¬ì¸íŠ¸ êµ¬ë§¤ (+${points}P)`,
                    createdAt: new Date()
                });

                alert(`${points}Pê°€ ì¶©ì „ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ’`);

                // í¬ì¸íŠ¸ í‘œì‹œ ì—…ë°ì´íŠ¸
                updatePointsDisplay();

                // íŒì—… ë‹«ê¸°
                hidePointsPurchasePopup();

            } catch (error) {
                console.error('í¬ì¸íŠ¸ êµ¬ë§¤ ì˜¤ë¥˜:', error);
                alert('í¬ì¸íŠ¸ êµ¬ë§¤ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        function showSubscriptionPopup() {
            const popup = document.getElementById('subscription-popup');
            if (popup) {
                popup.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
        }

        // êµ¬ë… íŒì—… ìˆ¨ê¸°ê¸° í•¨ìˆ˜
        function hideSubscriptionPopup() {
            const popup = document.getElementById('subscription-popup');
            if (popup) {
                popup.style.display = 'none';
                document.body.style.overflow = 'auto';
            }
        }

        // LemonSqueezyë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•˜ëŠ” í•¨ìˆ˜
        function subscribe(planType) {
            console.log('êµ¬ë… í•¨ìˆ˜ í˜¸ì¶œë¨:', planType);

            try {
                let checkoutUrl;

                if (planType === 'yearly') {
                    // ì—°ê°„ êµ¬ë… LemonSqueezy Checkout URL (ì‹¤ì œ URLë¡œ êµì²´ í•„ìš”)
                    checkoutUrl = 'https://your-store.lemonsqueezy.com/checkout/buy/yearly-plan-variant-id';
                } else if (planType === 'monthly') {
                    // ì›”ê°„ êµ¬ë… LemonSqueezy Checkout URL (ì‹¤ì œ URLë¡œ êµì²´ í•„ìš”)
                    checkoutUrl = 'https://your-store.lemonsqueezy.com/checkout/buy/monthly-plan-variant-id';
                }

                if (checkoutUrl) {
                    console.log('LemonSqueezy Checkoutìœ¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸:', { planType, checkoutUrl });

                    // Cross-Origin-Opener-Policy ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•´ í˜„ì¬ ì°½ì—ì„œ ë¦¬ë‹¤ì´ë ‰íŠ¸
                    window.location.href = checkoutUrl;

                    // ìƒˆ ì°½ì—ì„œ ì—´ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ ì½”ë“œ ì‚¬ìš© (COOP ê²½ê³  ë©”ì‹œì§€ê°€ ë‚˜íƒ€ë‚  ìˆ˜ ìˆìŒ)
                    // const newWindow = window.open(checkoutUrl, '_blank', 'noopener,noreferrer');
                } else {
                    console.error('ì²´í¬ì•„ì›ƒ URLì´ ì„¤ì •ë˜ì§€ ì•ŠìŒ');
                    alert('êµ¬ë… ì„¤ì •ì— ë¬¸ì œê°€ ìˆìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.');
                }

            } catch (error) {
                console.error('êµ¬ë… í•¨ìˆ˜ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜:', error);
                alert('êµ¬ë… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ========== ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ê¸°ëŠ¥ ==========

        // ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ
        window.showAddCategoryModalInUpload = () => {
            const modal = document.getElementById('addCategoryModalInUpload');
            if (modal) {
                modal.style.display = 'flex';
                document.getElementById('newCategoryNameInUpload')?.focus();
            }
        };

        // ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
        window.hideAddCategoryModalInUpload = () => {
            const modal = document.getElementById('addCategoryModalInUpload');
            if (modal) {
                modal.style.display = 'none';
                document.getElementById('newCategoryNameInUpload').value = '';
                document.getElementById('newCategoryClassificationInUpload').value = '';
                document.getElementById('newCategoryDescriptionInUpload').value = '';
            }
        };

        // ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì²˜ë¦¬
        window.handleAddCategoryInUpload = async () => {
            const name = document.getElementById('newCategoryNameInUpload').value.trim();
            const classification = document.getElementById('newCategoryClassificationInUpload').value;
            const description = document.getElementById('newCategoryDescriptionInUpload').value.trim();

            if (!name) {
                alert('ì¹´í…Œê³ ë¦¬ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.');
                return;
            }

            if (!classification) {
                alert('ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”.');
                return;
            }

            try {
                // Firestoreì— ì¹´í…Œê³ ë¦¬ ì¶”ê°€
                const categoryRef = window.firebaseDoc(window.firebaseCollection(window.firebaseDb, 'categories'));
                await window.firebaseSetDoc(categoryRef, {
                    name: name,
                    classification: classification,
                    description: description,
                    createdAt: new Date(),
                    createdBy: window.firebaseAuth.currentUser.uid
                });

                alert('ì¹´í…Œê³ ë¦¬ê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!');
                hideAddCategoryModalInUpload();

                // select ë°•ìŠ¤ì— ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€
                const categorySelect = document.getElementById('musicCategory');
                if (categorySelect) {
                    const option = document.createElement('option');
                    option.value = name;
                    option.textContent = name;
                    categorySelect.appendChild(option);
                    categorySelect.value = name;
                }
            } catch (error) {
                console.error('ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì˜¤ë¥˜:', error);
                alert('ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        };

        // ESC í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const modal = document.getElementById('addCategoryModalInUpload');
                if (modal && modal.style.display === 'flex') {
                    hideAddCategoryModalInUpload();
                }
            }
        });

    </script>

    <!-- ì¹´í…Œê³ ë¦¬ ì¶”ê°€ ëª¨ë‹¬ -->
    <div id="addCategoryModalInUpload" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 10000; justify-content: center; align-items: center;" onclick="if(event.target === this) hideAddCategoryModalInUpload();">
        <div style="background: white; padding: 30px; border-radius: 15px; max-width: 500px; width: 90%; box-shadow: 0 10px 40px rgba(0,0,0,0.3);" onclick="event.stopPropagation();">
            <h2 style="margin-top: 0; margin-bottom: 20px; color: #333;">ìƒˆ ì¹´í…Œê³ ë¦¬ ì¶”ê°€</h2>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">ì¹´í…Œê³ ë¦¬ ì´ë¦„ *</label>
                <input type="text" id="newCategoryNameInUpload"
                       style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                       placeholder="ì˜ˆ: íŒ, ë¡, ì¬ì¦ˆ ë“±"
                       onkeydown="if(event.key === 'Enter') { event.preventDefault(); handleAddCategoryInUpload(); }">
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">ë¶„ë¥˜ *</label>
                <select id="newCategoryClassificationInUpload"
                        style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box;"
                        onkeydown="if(event.key === 'Enter') { event.preventDefault(); handleAddCategoryInUpload(); }">
                    <option value="">ë¶„ë¥˜ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="ì¸ë¬¼">ì¸ë¬¼</option>
                    <option value="íŒ¨ì…˜">íŒ¨ì…˜</option>
                    <option value="í™”ë³´">í™”ë³´</option>
                    <option value="ì‹œë„¤ë§ˆí‹±">ì‹œë„¤ë§ˆí‹±</option>
                </select>
            </div>

            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #555;">ì„¤ëª… (ì„ íƒ)</label>
                <textarea id="newCategoryDescriptionInUpload"
                          style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box; resize: vertical;"
                          rows="3"
                          placeholder="ì¹´í…Œê³ ë¦¬ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
            </div>

            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 25px;">
                <button type="button" onclick="hideAddCategoryModalInUpload()"
                        style="background: #6c757d; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                    ì·¨ì†Œ
                </button>
                <button type="button" onclick="handleAddCategoryInUpload()"
                        style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600;">
                    ì¶”ê°€
                </button>
            </div>
        </div>
    </div>

</body>
</html>